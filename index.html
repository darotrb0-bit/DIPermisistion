<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីសុំច្បាប់ - ឧស្សាហកម្មឌីជីថល</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Khmer -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            updateDoc,
            deleteDoc,
            collection, 
            query, 
            where, 
            onSnapshot, 
            serverTimestamp,
            Timestamp, // Import Timestamp
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable Firestore debug logging
        setLogLevel('debug'); 

        // --- Hard-coded Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDjr_Ha2RxOWEumjEeSdluIW3JmyM76mVk",
            authDomain: "dipermisstion.firebaseapp.com",
            projectId: "dipermisstion",
            storageBucket: "dipermisstion.firebasestorage.app",
            messagingSenderId: "512999406057",
            appId: "1:512999406057:web:953a281ab9dde7a9a0f378",
            measurementId: "G-KDPHXZ7H4B"
        };
        // --- End of Hard-coded Config ---

        // --- Global State & Element References ---
        let db, auth, userId, canvasAppId;
        let historyLeaveUnsubscribe = null; 
        let historyOutUnsubscribe = null;
        let allUsersData = []; 
        let currentUser = null; 
        let selectedUserId = null; 
        let faceScanInterval = null; 

        // --- Google Sheet Config ---
        const SHEET_ID = '1_Kgl8UQXRsVATt_BOHYQjVWYKkRIBA12R-qnsBoSUzc';
        const SHEET_NAME = 'បញ្ជឺឈ្មោះរួម';
        const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tq=${encodeURIComponent('SELECT E, L, AA, N, G, S WHERE E IS NOT NULL OFFSET 0')}`;

        // --- Telegram Config ---
        const BOT_TOKEN = '8284240201:AAEDRGHDcuoQAhkWk7km6I-9csZNbReOPHw';
        const CHAT_ID = '1487065922';
        
        // --- Firestore Collection Paths ---
        let leaveRequestsCollectionPath; 
        let outRequestsCollectionPath;

        // --- Element References ---
        let userSearchInput, userDropdown, scanFaceBtn, modelStatusEl, 
            faceScanModal, video, scanStatusEl, cancelScanBtn, 
            loginFormContainer, inAppWarning, dataLoadingIndicator, rememberMeCheckbox, 
            mainAppContainer, homeUserName, loginPage, bottomNav, 
            userPhotoEl, userNameEl, userIdEl, userGenderEl, userGroupEl, userDepartmentEl, 
            logoutBtn, navButtons, pages, mainContent, 
            
            // Leave Request
            requestLeavePage, openLeaveRequestBtn, cancelLeaveRequestBtn, submitLeaveRequestBtn, 
            leaveDurationSearchInput, leaveDurationDropdownEl, leaveSingleDateContainer, leaveDateRangeContainer, 
            leaveSingleDateInput, leaveStartDateInput, leaveEndDateInput, leaveRequestErrorEl, leaveRequestLoadingEl, 
            leaveReasonSearchInput, leaveReasonDropdownEl, 
            
            // Out Request
            requestOutPage, openOutRequestBtn, cancelOutRequestBtn, submitOutRequestBtn,
            outDurationSearchInput, outDurationDropdownEl, outReasonSearchInput, outReasonDropdownEl,
            outDateInput, outRequestErrorEl, outRequestLoadingEl,

            // History
            historyContainerLeave, historyPlaceholderLeave, historyContainerOut, historyPlaceholderOut,
            historyTabButtons, historyTabPanels,

            // Edit Modal
            editModal, editForm, editRequestIdInput, editTypeInput, editDurationSearch, editDurationDropdown,
            editReasonSearch, editReasonDropdown, editStartDateInput, editEndDateInput,
            editSingleDateContainer, editDateRangeContainer,
            editErrorEl, cancelEditBtn, saveEditBtn,

            // Delete Confirm Modal
            deleteConfirmModal, deleteConfirmText, cancelDeleteBtn, confirmDeleteBtn,
            
            criticalErrorDisplay; 
            
        let editingRequest = null; // Store request data during edit
        let requestToDelete = null; // Store request data for deletion

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // --- Assign Element References ---
            criticalErrorDisplay = document.getElementById('critical-error-display');
            loginPage = document.getElementById('page-login');
            userSearchInput = document.getElementById('user-search');
            userDropdown = document.getElementById('user-dropdown');
            scanFaceBtn = document.getElementById('scan-face-btn');
            modelStatusEl = document.getElementById('model-status');
            faceScanModal = document.getElementById('face-scan-modal');
            video = document.getElementById('video');
            scanStatusEl = document.getElementById('scan-status');
            cancelScanBtn = document.getElementById('cancel-scan-btn');
            loginFormContainer = document.getElementById('login-form-container');
            inAppWarning = document.getElementById('in-app-warning');
            dataLoadingIndicator = document.getElementById('data-loading-indicator');
            rememberMeCheckbox = document.getElementById('remember-me');
            mainAppContainer = document.getElementById('main-app-container');
            homeUserName = document.getElementById('home-user-name');
            bottomNav = document.getElementById('bottom-navigation');
            userPhotoEl = document.getElementById('user-photo');
            userNameEl = document.getElementById('user-name');
            userIdEl = document.getElementById('user-id');
            userGenderEl = document.getElementById('user-gender');
            userGroupEl = document.getElementById('user-group');
            userDepartmentEl = document.getElementById('user-department');
            logoutBtn = document.getElementById('logout-btn');
            navButtons = document.querySelectorAll('.nav-btn');
            pages = ['page-home', 'page-history', 'page-account', 'page-help', 'page-request-leave', 'page-request-out'];
            mainContent = document.getElementById('main-content');
            
            // Leave Request Elements
            requestLeavePage = document.getElementById('page-request-leave');
            openLeaveRequestBtn = document.getElementById('open-leave-request-btn');
            cancelLeaveRequestBtn = document.getElementById('cancel-leave-request-btn');
            submitLeaveRequestBtn = document.getElementById('submit-leave-request-btn');
            leaveDurationSearchInput = document.getElementById('leave-duration-search');
            leaveDurationDropdownEl = document.getElementById('leave-duration-dropdown');
            leaveSingleDateContainer = document.getElementById('leave-single-date-container');
            leaveDateRangeContainer = document.getElementById('leave-date-range-container');
            leaveSingleDateInput = document.getElementById('leave-date-single');
            leaveStartDateInput = document.getElementById('leave-date-start');
            leaveEndDateInput = document.getElementById('leave-date-end');
            leaveRequestErrorEl = document.getElementById('leave-request-error');
            leaveRequestLoadingEl = document.getElementById('leave-request-loading');
            leaveReasonSearchInput = document.getElementById('leave-reason-search');
            leaveReasonDropdownEl = document.getElementById('leave-reason-dropdown');

            // Out Request Elements
            requestOutPage = document.getElementById('page-request-out');
            openOutRequestBtn = document.getElementById('open-out-request-btn');
            cancelOutRequestBtn = document.getElementById('cancel-out-request-btn');
            submitOutRequestBtn = document.getElementById('submit-out-request-btn');
            outDurationSearchInput = document.getElementById('out-duration-search');
            outDurationDropdownEl = document.getElementById('out-duration-dropdown');
            outReasonSearchInput = document.getElementById('out-reason-search');
            outReasonDropdownEl = document.getElementById('out-reason-dropdown');
            outDateInput = document.getElementById('out-date-single');
            outRequestErrorEl = document.getElementById('out-request-error');
            outRequestLoadingEl = document.getElementById('out-request-loading');

            // History Elements
            historyContainerLeave = document.getElementById('history-container-leave');
            historyPlaceholderLeave = document.getElementById('history-placeholder-leave');
            historyContainerOut = document.getElementById('history-container-out');
            historyPlaceholderOut = document.getElementById('history-placeholder-out');
            historyTabButtons = document.querySelectorAll('.history-tab-btn');
            historyTabPanels = document.querySelectorAll('.history-tab-panel');

            // Edit Modal Elements
            editModal = document.getElementById('edit-request-modal');
            editForm = document.getElementById('edit-request-form');
            editRequestIdInput = document.getElementById('edit-request-id');
            editTypeInput = document.getElementById('edit-request-type');
            editDurationSearch = document.getElementById('edit-duration-search');
            editDurationDropdown = document.getElementById('edit-duration-dropdown');
            editReasonSearch = document.getElementById('edit-reason-search');
            editReasonDropdown = document.getElementById('edit-reason-dropdown');
            editStartDateInput = document.getElementById('edit-date-start');
            editEndDateInput = document.getElementById('edit-date-end');
            editSingleDateContainer = document.getElementById('edit-single-date-container');
            editDateRangeContainer = document.getElementById('edit-date-range-container');
            editErrorEl = document.getElementById('edit-request-error');
            cancelEditBtn = document.getElementById('cancel-edit-btn');
            saveEditBtn = document.getElementById('save-edit-btn');
            
            // Delete Confirm Modal
            deleteConfirmModal = document.getElementById('delete-confirm-modal');
            deleteConfirmText = document.getElementById('delete-confirm-text');
            cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            confirmDeleteBtn = document.getElementById('confirm-delete-btn');

            // --- Firebase Initialization ---
            try {
                // Use the hard-coded config
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Get Canvas appId (still needed for Firestore path)
                canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Define the correct Firestore paths
                leaveRequestsCollectionPath = `/artifacts/${canvasAppId}/public/data/leave_requests`;
                outRequestsCollectionPath = `/artifacts/${canvasAppId}/public/data/out_requests`;
                console.log("Using Firestore Leave Path:", leaveRequestsCollectionPath);
                console.log("Using Firestore Out Path:", outRequestsCollectionPath);

                // --- Firebase Authentication ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Firebase Auth state changed. User is authenticated. UID:", user.uid);
                        userId = user.uid; // Set global userId (Firebase Auth UID)

                        // Check for Remembered User (localStorage)
                        const rememberedUser = localStorage.getItem('leaveAppUser');
                        if (rememberedUser) {
                            try {
                                const parsedUser = JSON.parse(rememberedUser);
                                if (parsedUser && parsedUser.id) { 
                                    console.log("Found remembered user:", parsedUser.id);
                                    currentUser = parsedUser; // Set current user
                                    showLoggedInState(parsedUser); // Go straight to app
                                    fetchUsers(); // Fetch in background for any updates
                                    return; 
                                } else {
                                    throw new Error("ទិន្នន័យអ្នកប្រើប្រាស់ក្នុង localStorage មិនត្រឹមត្រូវ");
                                }
                            } catch (e) {
                                console.error('បរាជ័យក្នុងការអានទិន្នន័យអ្នកប្រើប្រាស់:', e);
                                localStorage.removeItem('leaveAppUser'); 
                            }
                        }
                        // If no valid remembered user, start normal flow
                        console.log("No remembered user found, starting normal app flow.");
                        initializeAppFlow();
                    } else {
                        console.log("Firebase Auth: No user signed in. Attempting anonymous sign-in...");
                        // If not signed in, attempt anonymous sign-in again (might happen on initial load)
                        signInAnonymously(auth).catch(anonError => {
                             console.error("Error during automatic anonymous sign-in attempt:", anonError);
                             if (criticalErrorDisplay) {
                                 criticalErrorDisplay.classList.remove('hidden');
                                 criticalErrorDisplay.textContent = `Critical Error: មិនអាច Sign In បានទេ។ ${anonError.message}។ សូម Refresh ម្ដងទៀត។`;
                             }
                        });
                    }
                });

                // --- Initial Anonymous Sign-In ---
                try {
                    console.log("Attempting initial Anonymous Sign-In...");
                    await signInAnonymously(auth);
                    console.log("Firebase Auth: Initial Anonymous Sign-In successful (or already signed in).");
                } catch (anonError) {
                    console.error("Initial Anonymous Sign-In Error:", anonError);
                    if (anonError.code === 'auth/operation-not-allowed') {
                        throw new Error("សូមបើក 'Anonymous' sign-in នៅក្នុង Firebase Console (Authentication > Sign-in method)។");
                    }
                    throw new Error(`Firebase Sign-In Error: ${anonError.message}`);
                }

            } catch (e) {
                console.error("Firebase Initialization/Auth Error:", e);
                if(criticalErrorDisplay) {
                    criticalErrorDisplay.classList.remove('hidden');
                    criticalErrorDisplay.textContent = `Critical Error: មិនអាចតភ្ជាប់ Firebase បានទេ។ ${e.message}។ សូម Refresh ម្ដងទៀត។`;
                }
                if(loginPage) loginPage.classList.add('hidden'); // Hide login form
            }

            // --- Main App Logic (to be called after auth is confirmed) ---
            function initializeAppFlow() {
                console.log("initializeAppFlow called."); // Log entry
                function isClient() {
                    const ua = navigator.userAgent || navigator.vendor || window.opera;
                    return (
                        (ua.indexOf('FBAN') > -1) || (ua.indexOf('FBAV') > -1) ||
                        (ua.indexOf('Twitter') > -1) || (ua.indexOf('Telegram') > -1) ||
                        (ua.indexOf('WebView') > -1) || (ua.indexOf('wv') > -1)
                    );
                }

                if (isClient()) {
                    console.log("Detected In-App Browser.");
                    if (inAppWarning) inAppWarning.classList.remove('hidden');
                    if (modelStatusEl) modelStatusEl.textContent = 'សូមបើកក្នុង Browser ពេញលេញ';
                    if (dataLoadingIndicator) dataLoadingIndicator.classList.add('hidden');
                } else {
                    console.log("Detected Full Browser.");
                    if (inAppWarning) inAppWarning.classList.add('hidden');
                    if (dataLoadingIndicator) dataLoadingIndicator.classList.remove('hidden');
                    
                    fetchUsers();
                    
                    if (typeof faceapi !== 'undefined') {
                        if (scanFaceBtn) scanFaceBtn.disabled = true; 
                        loadFaceApiModels();
                    } else {
                        console.error("Face-API.js មិនអាចទាញយកបានត្រឹមត្រូវទេ។");
                        if (modelStatusEl) modelStatusEl.textContent = 'Error: មិនអាចទាញយក Library ស្កេនមុខបាន';
                    }
                }
            }
            
            // --- Google Sheet Data Fetching ---
            async function fetchUsers() {
                console.log("Fetching users from Google Sheet...");
                try {
                    const response = await fetch(GVIZ_URL);
                    if (!response.ok) throw new Error(`Google Sheet fetch failed with status: ${response.status}`);
                    const text = await response.text();
                    const match = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
                     if (!match || !match[1]) throw new Error("ទម្រង់ការឆ្លើយតបពី Google Sheet មិនត្រឹមត្រូវ");
                    const json = JSON.parse(match[1]);
                    
                    if (json.table && json.table.rows && json.table.rows.length > 0) {
                        allUsersData = json.table.rows.map(row => ({
                            id: row.c && row.c[0] ? row.c[0].v : null, 
                            name: row.c && row.c[1] ? row.c[1].v : null,
                            photo: row.c && row.c[2] ? row.c[2].v : null,
                            gender: row.c && row.c[3] ? row.c[3].v : null,
                            group: row.c && row.c[4] ? row.c[4].v : null,
                            department: row.c && row.c[5] ? row.c[5].v : null,
                        }));
                        console.log(`Fetched ${allUsersData.length} users.`);
                        populateUserDropdown(allUsersData, 'user-search', 'user-dropdown', (id) => {
                            selectedUserId = id;
                            if (scanFaceBtn) scanFaceBtn.disabled = (id === null || !modelStatusEl || modelStatusEl.textContent !== 'Model ស្កេនមុខបានទាញយករួចរាល់'); 
                            console.log("Selected User ID:", selectedUserId);
                        });
                        
                        if (dataLoadingIndicator) dataLoadingIndicator.classList.add('hidden');
                        if (loginFormContainer) loginFormContainer.classList.remove('hidden');

                    } else {
                        console.error("រកមិនឃើញទិន្នន័យអ្នកប្រើប្រាស់ក្នុង Google Sheet ទេ។");
                        throw new Error("រកមិនឃើញទិន្នន័យអ្នកប្រើប្រាស់");
                    }
                } catch (error) {
                    console.error("Error ពេលទាញយកទិន្នន័យ Google Sheet:", error);
                    if (dataLoadingIndicator) {
                        dataLoadingIndicator.innerHTML = `<p class="text-red-600 font-semibold">Error: មិនអាចទាញយកទិន្នន័យបាន</p><p class="text-gray-600 text-sm mt-1">សូមពិនិត្យអ៊ីនធឺណិត និង Refresh ម្ដងទៀត។</p>`;
                        dataLoadingIndicator.classList.remove('hidden'); 
                    }
                }
            }

            // --- Reusable Searchable Dropdown Logic ---
            function setupSearchableDropdown(inputId, dropdownId, items, onSelectCallback, allowCustom = false) {
                const searchInput = document.getElementById(inputId);
                const dropdown = document.getElementById(dropdownId);
                
                if (!searchInput || !dropdown) {
                     console.error(`Dropdown elements not found: inputId=${inputId}, dropdownId=${dropdownId}`);
                     return;
                 }
                 
                let currentSelection = null; // Track the value

                function populateDropdown(filter = '') {
                    dropdown.innerHTML = '';
                    const filteredItems = items.filter(item => item.text && item.text.toLowerCase().includes(filter.toLowerCase())); 
                    
                    if (filteredItems.length === 0 && !allowCustom) {
                         dropdown.classList.add('hidden');
                         return;
                     }

                    filteredItems.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.textContent = item.text;
                        itemEl.dataset.value = item.value;
                        itemEl.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                        
                        itemEl.addEventListener('mousedown', (e) => {
                            e.preventDefault(); 
                            searchInput.value = item.text;
                            currentSelection = item.value; // Set selection
                            dropdown.classList.add('hidden');
                            if (onSelectCallback) onSelectCallback(item.value);
                            console.log(`Selected dropdown item: ${item.text} (value: ${item.value})`);
                        });
                        dropdown.appendChild(itemEl);
                    });
                    dropdown.classList.remove('hidden');
                }
                
                function validateSelection() {
                    const currentValue = searchInput.value;
                    if (allowCustom) {
                        currentSelection = currentValue;
                        if (onSelectCallback) onSelectCallback(currentSelection);
                        return;
                    }
                    
                    const validItem = items.find(item => item.text === currentValue);
                    if (validItem) {
                        currentSelection = validItem.value;
                    } else {
                        currentSelection = null;
                        // Don't clear the input, just notify the callback
                    }
                    if (onSelectCallback) onSelectCallback(currentSelection);
                }

                searchInput.addEventListener('input', () => {
                    populateDropdown(searchInput.value);
                    validateSelection();
                });

                searchInput.addEventListener('focus', () => {
                     console.log(`Focus on ${inputId}`);
                     populateDropdown(searchInput.value);
                     validateSelection();
                });

                searchInput.addEventListener('blur', () => {
                     console.log(`Blur on ${inputId}`);
                    setTimeout(() => {
                        dropdown.classList.add('hidden');
                        validateSelection(); // Validate one last time on blur
                        console.log(`Final selection for ${inputId} on blur: ${currentSelection}`);
                    }, 150);
                });
                
                // Return a function to get the current valid selection
                return () => currentSelection;
            }

            let getLeaveDurationSelection;
            let getLeaveReasonSelection;
            let getOutDurationSelection;
            let getOutReasonSelection;
            let getEditDurationSelection;
            let getEditReasonSelection;

            function populateUserDropdown(users, inputId, dropdownId, onSelectCallback) {
                const userItems = users
                    .filter(user => user.id && user.name)
                    .map(user => ({ text: `${user.id} - ${user.name}`, value: user.id }));
                setupSearchableDropdown(inputId, dropdownId, userItems, onSelectCallback, false); // No custom user IDs
            }

            // --- Face Scan Logic ---
            async function loadFaceApiModels() {
                if (!modelStatusEl) return;
                try {
                    console.log("Loading face-api models...");
                    modelStatusEl.textContent = 'កំពុងទាញយក Model ស្កេនមុខ...';
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                        faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                        faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                    ]);
                    modelStatusEl.textContent = 'Model ស្កេនមុខបានទាញយករួចរាល់';
                    console.log("Face-api models loaded successfully.");
                    if (scanFaceBtn) scanFaceBtn.disabled = (selectedUserId === null); 

                } catch (error) {
                    console.error("Error ពេលទាញយក Model របស់ face-api:", error);
                    modelStatusEl.textContent = 'Error: មិនអាចទាញយក Model បាន';
                }
            }

            async function startFaceScan() {
                console.log("startFaceScan called.");
                if (!selectedUserId) {
                    console.warn("Face scan attempt without selected user.");
                    alert("សូមជ្រើសរើសអត្តលេខរបស់អ្នកជាមុនសិន");
                    return;
                }
                
                const user = allUsersData.find(u => u.id === selectedUserId);
                if (!user || !user.photo) {
                    console.error("User data or photo missing for ID:", selectedUserId);
                    alert("Error: មិនអាចទាញយករូបថតយោងរបស់អ្នកបានទេ។ សូមទាក់ទង IT Support។");
                    return;
                }
                console.log("Starting face scan for user:", user.id);

                if (faceScanModal) faceScanModal.classList.remove('hidden');
                if (scanStatusEl) scanStatusEl.textContent = 'កំពុងព្យាយាមបើកកាមេរ៉ា...';

                try {
                    // 1. Fetch and process reference image
                    console.log("Fetching reference image from:", user.photo);
                    if (scanStatusEl) scanStatusEl.textContent = 'កំពុងទាញយករូបថតយោង...';
                    let referenceImage;
                    try {
                        const img = new Image();
                        img.crossOrigin = 'anonymous'; 
                        img.src = user.photo;
                        await new Promise((resolve, reject) => {
                            img.onload = () => { console.log("Reference image loaded."); resolve(); };
                            img.onerror = (err) => { 
                                console.error("Error loading reference image:", err);
                                reject(new Error('Failed to fetch (មិនអាចទាញយករូបថតយោងបាន)។ សូមប្រាកដថា Link រូបថតត្រឹមត្រូវ និងអាចចូលមើលបាន។')); 
                            };
                        });
                        referenceImage = img;
                    } catch (fetchError) {
                        console.error('Fetch image error during face scan:', fetchError);
                        throw fetchError; 
                    }
                    
                    // 2. Compute reference descriptor
                    console.log("Computing reference face descriptor...");
                    if (scanStatusEl) scanStatusEl.textContent = 'កំពុងវិភាគរូបថតយោង...';
                     let referenceDescriptor;
                     try {
                        const referenceDetection = await faceapi.detectSingleFace(referenceImage).withFaceLandmarks(true).withFaceDescriptor();
                        if (!referenceDetection) {
                            throw new Error('រកមិនឃើញមុខនៅក្នុងរូបថតយោង');
                        }
                        referenceDescriptor = referenceDetection.descriptor;
                        console.log("Reference descriptor computed.");
                    } catch (descriptorError) {
                         console.error("Error computing reference descriptor:", descriptorError);
                         throw new Error('មិនអាចវិភាគមុខពីរូបថតយោងបានទេ (រូបថតអាចមិនច្បាស់ ឬ Link មិនត្រឹមត្រូវ)។');
                     }

                    // 3. Start video stream
                    console.log("Requesting camera access...");
                    if (scanStatusEl) scanStatusEl.textContent = 'កំពុងស្នើសុំបើកកាមេរ៉ា...';
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    if (video) video.srcObject = stream;
                    console.log("Camera stream started.");
                    if (scanStatusEl) scanStatusEl.textContent = 'សូមដាក់មុខរបស់អ្នកឲ្យចំកាមេរ៉ា';

                    // 4. Start detection interval
                    console.log("Starting face detection interval.");
                    if (faceScanInterval) clearInterval(faceScanInterval); 
                    faceScanInterval = setInterval(async () => {
                        if (!video || video.readyState < 3) return; 

                        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true).withFaceDescriptor();
                        
                        if (detections) {
                            if (scanStatusEl) scanStatusEl.textContent = 'រកឃើញផ្ទៃមុខ! កំពុងផ្ទៀងផ្ទាត់...';
                            const distance = faceapi.euclideanDistance(referenceDescriptor, detections.descriptor);
                            const similarity = (1 - distance).toFixed(2);
                            const threshold = 0.55; 
                            // if (scanDebugEl) scanDebugEl.textContent = `ភាពស្រដៀងគ្នា: ${similarity} (ត្រូវតែ > ${1-threshold})`; // Removed for cleaner UI

                            if (distance < threshold) { 
                                console.log("Face verification successful!", `Distance: ${distance}`);
                                if (scanStatusEl) scanStatusEl.textContent = 'ផ្ទៀងផ្ទាត់ជោគជ័យ!';
                                stopFaceScan(); 
                                loginUser(selectedUserId); 
                                
                                setTimeout(() => {
                                    if (faceScanModal) faceScanModal.classList.add('hidden');
                                }, 1000);
                            } else {
                                if (scanStatusEl) scanStatusEl.textContent = 'មុខមិនត្រឹមត្រូវ... សូមព្យាយាមម្តងទៀត';
                            }
                        } else {
                            if (scanStatusEl) scanStatusEl.textContent = 'រកមិនឃើញផ្ទៃមុខ...';
                            // if (scanDebugEl) scanDebugEl.textContent = '';
                        }
                    }, 500); 

                } catch (error) {
                    console.error("Error during face scan process:", error);
                    if (scanStatusEl) scanStatusEl.textContent = `Error: ${error.message}`;
                    stopFaceScan(); 
                     setTimeout(() => { 
                         if (faceScanModal) faceScanModal.classList.add('hidden'); 
                         alert(`មានបញ្ហាពេលស្កេនមុខ៖\n${error.message}\nសូមប្រាកដថាអ្នកបានអនុញ្ញាតឲ្យប្រើកាមេរ៉ា។`);
                     }, 1500); 
                }
            }

            function stopFaceScan() {
                console.log("Stopping face scan.");
                if (faceScanInterval) {
                    clearInterval(faceScanInterval);
                    faceScanInterval = null;
                }
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                    console.log("Camera stream stopped.");
                } else {
                     console.log("No active camera stream to stop.");
                 }
            }

            if (scanFaceBtn) scanFaceBtn.addEventListener('click', startFaceScan);
            if (cancelScanBtn) cancelScanBtn.addEventListener('click', () => {
                console.log("Cancel scan button clicked.");
                stopFaceScan();
                if (faceScanModal) faceScanModal.classList.add('hidden');
            });

            // --- App Navigation & State Logic ---
            function loginUser(userIdToLogin) {
                console.log("Logging in user ID:", userIdToLogin);
                const user = allUsersData.find(u => u.id === userIdToLogin);
                 if (!user) {
                     console.error("User data not found for login:", userIdToLogin);
                     alert("មានបញ្ហា Login: រកមិនឃើញទិន្នន័យអ្នកប្រើប្រាស់");
                     return;
                 }

                if (rememberMeCheckbox && rememberMeCheckbox.checked) {
                    console.log("Remembering user.");
                    localStorage.setItem('leaveAppUser', JSON.stringify(user));
                } else {
                    console.log("Not remembering user.");
                    localStorage.removeItem('leaveAppUser'); 
                }
                
                showLoggedInState(user);
            }
            
            function logout() {
                console.log("Logging out user.");
                currentUser = null;
                localStorage.removeItem('leaveAppUser'); 

                if (loginPage) loginPage.classList.remove('hidden');
                if (mainAppContainer) mainAppContainer.classList.add('hidden');
                
                if (userPhotoEl) userPhotoEl.src = 'https://placehold.co/100x100/e2e8f0/64748b?text=User';
                if (userNameEl) userNameEl.textContent = '...';
                if (userIdEl) userIdEl.textContent = '...';
                if (userGenderEl) userGenderEl.textContent = '...';
                if (userGroupEl) userGroupEl.textContent = '...';
                if (userDepartmentEl) userDepartmentEl.textContent = '...';
                
                if (userSearchInput) userSearchInput.value = '';
                selectedUserId = null;
                if (scanFaceBtn) scanFaceBtn.disabled = true;
                if (rememberMeCheckbox) rememberMeCheckbox.checked = false;

                if (historyLeaveUnsubscribe) {
                    console.log("Unsubscribing from leave history listener.");
                    historyLeaveUnsubscribe();
                    historyLeaveUnsubscribe = null;
                }
                if (historyOutUnsubscribe) {
                    console.log("Unsubscribing from out history listener.");
                    historyOutUnsubscribe();
                    historyOutUnsubscribe = null;
                }
                
                signInAnonymously(auth).catch(err => console.error("Error signing in anonymously after logout:", err));
            }
            
            function showLoggedInState(user) {
                console.log("Showing logged-in state for:", user.id);
                currentUser = user;
                populateAccountPage(user);
                
                if (homeUserName) homeUserName.textContent = user.name || '...';

                if (loginPage) loginPage.classList.add('hidden');
                if (mainAppContainer) mainAppContainer.classList.remove('hidden');
                if (criticalErrorDisplay) criticalErrorDisplay.classList.add('hidden');

                navigateTo('page-home');
                
                // Start listening to history for this user
                setupHistoryListener(user.id);
            }
            
            function populateAccountPage(user) {
                if (!user) return; 
                 console.log("Populating account page for:", user.id);
                if (userPhotoEl && user.photo) {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = user.photo;
                    img.onload = () => {
                        userPhotoEl.src = img.src;
                    };
                    img.onerror = () => { 
                        console.warn("Could not load user photo from:", user.photo);
                        userPhotoEl.src = 'https://placehold.co/100x100/e2e8f0/64748b?text=គ្មានរូប';
                    };
                } else if (userPhotoEl) {
                    userPhotoEl.src = 'https://placehold.co/100x100/e2e8f0/64748b?text=User';
                }
                
                if (userNameEl) userNameEl.textContent = user.name || 'មិនមាន';
                if (userIdEl) userIdEl.textContent = user.id || 'មិនមាន';
                if (userGenderEl) userGenderEl.textContent = user.gender || 'មិនមាន';
                if (userGroupEl) userGroupEl.textContent = user.group || 'មិនមាន';
                if (userDepartmentEl) userDepartmentEl.textContent = user.department || 'មិនមាន';
            }
            

            if (logoutBtn) logoutBtn.addEventListener('click', logout);
            
            // --- Bottom Navigation Logic ---
            function navigateTo(pageId) {
                console.log("Navigating to page:", pageId);
                pages.forEach(page => {
                    const pageEl = document.getElementById(page);
                    if (pageEl) {
                        pageEl.classList.add('hidden');
                    } else {
                         console.warn(`Page element not found: ${page}`);
                     }
                });
                
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                } else {
                     console.error(`Target page element not found: ${pageId}`);
                     const homePage = document.getElementById('page-home');
                     if(homePage) homePage.classList.remove('hidden');
                     return; 
                 }

                // Hide nav bar only for request form pages
                if (bottomNav) {
                    if (pageId === 'page-request-leave' || pageId === 'page-request-out') {
                        bottomNav.classList.add('hidden');
                    } else {
                        bottomNav.classList.remove('hidden');
                    }
                }
                
                // Update nav button active state
                if (navButtons) {
                    navButtons.forEach(btn => {
                        if (btn.dataset.page === pageId) {
                            btn.classList.add('text-blue-600');
                            btn.classList.remove('text-gray-500');
                        } else {
                            btn.classList.add('text-gray-500');
                            btn.classList.remove('text-blue-600');
                        }
                    });
                } else {
                     console.warn("Navigation buttons not found.");
                 }
                
                if (mainContent) {
                    mainContent.scrollTop = 0;
                }
            }


            if (navButtons) {
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const pageToNavigate = button.dataset.page;
                         if (pageToNavigate) {
                             navigateTo(pageToNavigate);
                         } else {
                             console.warn("Nav button clicked without data-page attribute.");
                         }
                    });
                });
            } else {
                 console.warn("Navigation buttons not found during event listener setup.");
             }

            // --- Date Formatting Helper ---
            function formatDate(date) {
                if (!date) return 'N/A';
                let d;
                if (date.toDate) { // Check if it's a Firestore Timestamp
                    d = date.toDate();
                } else if (typeof date === 'string' && date.includes('-')) { // YYYY-MM-DD
                    const parts = date.split('-');
                    d = new Date(parts[0], parts[1] - 1, parts[2]);
                } else if (typeof date === 'string' && date.includes('/')) { // MM/DD/YYYY or DD/MM/YYYY
                    // Assuming dd/mm/yyyy format based on request
                    const parts = date.split('/');
                    d = new Date(parts[2], parts[1] - 1, parts[0]);
                } else if (date instanceof Date) {
                    d = date;
                } else {
                    console.warn("Could not parse date:", date);
                    return 'Invalid Date';
                }
                
                if (isNaN(d.getTime())) {
                     console.warn("Parsed invalid date:", d);
                     return 'Invalid Date';
                 }

                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const yyyy = d.getFullYear();
                return `${dd}/${mm}/${yyyy}`;
            }
            
            function formatTime(date) {
                 if (!date || !date.toDate) return ''; // Only format Firestore Timestamps
                 const d = date.toDate();
                 let hours = d.getHours();
                 const minutes = String(d.getMinutes()).padStart(2, '0');
                 const ampm = hours >= 12 ? 'រសៀល' : 'ព្រឹក';
                 hours = hours % 12;
                 hours = hours ? hours : 12; // Hour '0' should be '12'
                 return `${hours}:${minutes} ${ampm}`;
             }

            function getTodayString_DDMMYYYY() {
                const today = new Date();
                const dd = String(today.getDate()).padStart(2, '0');
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const yyyy = today.getFullYear();
                return `${dd}/${mm}/${yyyy}`;
            }

            function getTodayString_YYYYMMDD() {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }

            function addDays_YYYYMMDD(dateString_YYYYMMDD, days) {
                try {
                     const date = new Date(dateString_YYYYMMDD);
                     if (isNaN(date.getTime())) {
                         console.error("Invalid start date provided to addDays:", dateString_YYYYMMDD);
                         return getTodayString_YYYYMMDD(); 
                     }
                    date.setDate(date.getDate() + Math.ceil(days) - 1); 
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                } catch (e) {
                     console.error("Error in addDays function:", e);
                     return getTodayString_YYYYMMDD(); 
                 }
            }
            
            function convertYYYYMMDDtoDDMMYYYY(dateString_YYYYMMDD) {
                 if (!dateString_YYYYMMDD || !dateString_YYYYMMDD.includes('-')) return 'N/A';
                 const parts = dateString_YYYYMMDD.split('-');
                 if (parts.length !== 3) return 'N/A';
                 return `${parts[2]}/${parts[1]}/${parts[0]}`;
             }
             
            function convertDDMMYYYYtoYYYYMMDD(dateString_DDMMYYYY) {
                if (!dateString_DDMMYYYY || !dateString_DDMMYYYY.includes('/')) return 'N/A';
                 const parts = dateString_DDMMYYYY.split('/');
                 if (parts.length !== 3) return 'N/A';
                 return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }

            // --- LEAVE Request Logic (ឈប់សម្រាក) ---
            const leaveDurations = [
                "មួយព្រឹក", "មួយរសៀល", "មួយយប់", "មួយថ្ងៃ", "មួយថ្ងៃកន្លះ", "ពីរថ្ងៃ", "ពីរថ្ងៃកន្លះ",
                "បីថ្ងៃ", "បីថ្ងៃកន្លះ", "បួនថ្ងៃ", "បួនថ្ងៃកន្លះ", "ប្រាំថ្ងៃ", "ប្រាំថ្ងៃកន្លះ",
                "ប្រាំមួយថ្ងៃ", "ប្រាំមួយថ្ងៃកន្លះ", "ប្រាំពីរថ្ងៃ"
            ];
            const leaveDurationItems = leaveDurations.map(d => ({ text: d, value: d }));
            
            const leaveReasons = ["ឈឺក្បាល", "ចុកពោះ", "គ្រុនក្ដៅ", "ផ្ដាសាយ"];
            const leaveReasonItems = leaveReasons.map(r => ({ text: r, value: r }));
            
            const leaveDurationToDaysMap = {
                "មួយព្រឹក": 1, "មួយរសៀល": 1, "មួយយប់": 1, "មួយថ្ងៃ": 1,
                "មួយថ្ងៃកន្លះ": 1.5, "ពីរថ្ងៃ": 2, "ពីរថ្ងៃកន្លះ": 2.5,
                "បីថ្ងៃ": 3, "បីថ្ងៃកន្លះ": 3.5, "បួនថ្ងៃ": 4, "បួនថ្ងៃកន្លះ": 4.5,
                "ប្រាំថ្ងៃ": 5, "ប្រាំថ្ងៃកន្លះ": 5.5, "ប្រាំមួយថ្ងៃ": 6, "ប្រាំមួយថ្ងៃកន្លះ": 6.5,
                "ប្រាំពីរថ្ងៃ": 7
            };
            const leaveSingleDayDurations = ["មួយព្រឹក", "មួយរសៀល", "មួយយប់", "មួយថ្ងៃ"];

            function updateLeaveDateFields(duration) {
                console.log("Leave Duration selected:", duration);
                const today_YYYYMMDD = getTodayString_YYYYMMDD();
                const today_DDMMYYYY = getTodayString_DDMMYYYY();

                if (!duration) {
                    if(leaveSingleDateContainer) leaveSingleDateContainer.classList.add('hidden');
                    if(leaveDateRangeContainer) leaveDateRangeContainer.classList.add('hidden');
                    return;
                }

                if (leaveSingleDayDurations.includes(duration)) {
                    if(leaveSingleDateContainer) leaveSingleDateContainer.classList.remove('hidden');
                    if(leaveDateRangeContainer) leaveDateRangeContainer.classList.add('hidden');
                    if(leaveSingleDateInput) leaveSingleDateInput.value = today_DDMMYYYY; // Display dd/mm/yyyy
                    console.log("Set leave single date to:", today_DDMMYYYY);
                } else {
                    if(leaveSingleDateContainer) leaveSingleDateContainer.classList.add('hidden');
                    if(leaveDateRangeContainer) leaveDateRangeContainer.classList.remove('hidden');
                    if(leaveStartDateInput) leaveStartDateInput.value = today_DDMMYYYY; // Display dd/mm/yyyy
                    
                    const days = leaveDurationToDaysMap[duration] || 0;
                    const endDate_YYYYMMDD = addDays_YYYYMMDD(today_YYYYMMDD, days);
                    const endDate_DDMMYYYY = convertYYYYMMDDtoDDMMYYYY(endDate_YYYYMMDD);
                    
                    if(leaveEndDateInput) {
                        leaveEndDateInput.value = endDate_DDMMYYYY; // Display dd/mm/yyyy
                        leaveEndDateInput.min = today_YYYYMMDD; // Set min in YYYY-MM-DD format for browser
                    }
                    console.log(`Set leave date range: ${today_DDMMYYYY} to ${endDate_DDMMYYYY}`);
                }
            }

            // Setup the leave duration dropdown
            getLeaveDurationSelection = setupSearchableDropdown('leave-duration-search', 'leave-duration-dropdown', leaveDurationItems, updateLeaveDateFields, false); // No custom durations
            // Setup the leave reason dropdown
            getLeaveReasonSelection = setupSearchableDropdown('leave-reason-search', 'leave-reason-dropdown', leaveReasonItems, null, true); // Allow custom reasons
            
            if (openLeaveRequestBtn) openLeaveRequestBtn.addEventListener('click', () => {
                console.log("Opening leave request form.");
                 if (!currentUser) {
                     console.warn("Attempted to open leave request form without a logged-in user.");
                     alert("សូម Login ជាមុនសិន។");
                     return;
                 }
                
                 const reqPhoto = document.getElementById('leave-request-user-photo');
                 const reqName = document.getElementById('leave-request-user-name');
                 const reqId = document.getElementById('leave-request-user-id');
                 const reqDept = document.getElementById('leave-request-user-department');

                 if(reqPhoto) reqPhoto.src = currentUser.photo || 'https://placehold.co/60x60/e2e8f0/64748b?text=User';
                 if(reqName) reqName.textContent = currentUser.name;
                 if(reqId) reqId.textContent = currentUser.id;
                 if(reqDept) reqDept.textContent = currentUser.department || 'មិនមាន';
                
                if (leaveDurationSearchInput) leaveDurationSearchInput.value = '';
                if (leaveReasonSearchInput) leaveReasonSearchInput.value = '';
                if (leaveSingleDateContainer) leaveSingleDateContainer.classList.add('hidden');
                if (leaveDateRangeContainer) leaveDateRangeContainer.classList.add('hidden');
                if (leaveRequestErrorEl) leaveRequestErrorEl.classList.add('hidden');
                if (leaveRequestLoadingEl) leaveRequestLoadingEl.classList.add('hidden');
                if (submitLeaveRequestBtn) submitLeaveRequestBtn.disabled = false;
                
                navigateTo('page-request-leave');
            });

            if (cancelLeaveRequestBtn) cancelLeaveRequestBtn.addEventListener('click', () => {
                console.log("Cancelling leave request.");
                navigateTo('page-home'); 
            });

            if (submitLeaveRequestBtn) submitLeaveRequestBtn.addEventListener('click', async () => {
                 console.log("Submit leave request button clicked.");
                 
                 const selectedDuration = getLeaveDurationSelection ? getLeaveDurationSelection() : null;
                 const selectedReason = getLeaveReasonSelection ? getLeaveReasonSelection() : null;

                 // Validation
                 if (!currentUser || !currentUser.id) {
                     alert("មានបញ្ហា៖ មិនអាចបញ្ជាក់អ្នកប្រើប្រាស់បានទេ។ សូមព្យាយាម Login ម្ដងទៀត។");
                     return;
                 }
                if (!selectedDuration) {
                    if (leaveRequestErrorEl) {
                        leaveRequestErrorEl.textContent = 'សូមជ្រើសរើស "រយៈពេល" ពីក្នុងបញ្ជី។';
                        leaveRequestErrorEl.classList.remove('hidden');
                    }
                    return;
                }
                
                if (!selectedReason || selectedReason.trim() === '') {
                    if (leaveRequestErrorEl) {
                        leaveRequestErrorEl.textContent = 'សូមបំពេញ "មូលហេតុ" ជាមុនសិន។';
                        leaveRequestErrorEl.classList.remove('hidden');
                    }
                    return;
                }
                
                if (leaveRequestErrorEl) leaveRequestErrorEl.classList.add('hidden');
                if (leaveRequestLoadingEl) leaveRequestLoadingEl.classList.remove('hidden');
                if (submitLeaveRequestBtn) submitLeaveRequestBtn.disabled = true;

                try {
                    const startDate_DDMMYYYY = leaveSingleDayDurations.includes(selectedDuration) 
                        ? (leaveSingleDateInput ? leaveSingleDateInput.value : getTodayString_DDMMYYYY())
                        : (leaveStartDateInput ? leaveStartDateInput.value : getTodayString_DDMMYYYY());
                    const endDate_DDMMYYYY = leaveSingleDayDurations.includes(selectedDuration) 
                        ? startDate_DDMMYYYY
                        : (leaveEndDateInput ? leaveEndDateInput.value : getTodayString_DDMMYYYY());
                        
                    // Convert dates to YYYY-MM-DD for consistency, but store DD/MM/YYYY
                    const startDate_YYYYMMDD = convertDDMMYYYYtoYYYYMMDD(startDate_DDMMYYYY);
                    const endDate_YYYYMMDD = convertDDMMYYYYtoYYYYMMDD(endDate_DDMMYYYY);
                    
                    if (new Date(endDate_YYYYMMDD) < new Date(startDate_YYYYMMDD)) {
                         throw new Error('"ថ្ងៃបញ្ចប់" មិនអាចនៅមុន "ថ្ងៃចាប់ផ្តើម" បានទេ។');
                    }

                    const requestId = `leave_${Date.now()}`;
                    const requestData = {
                        userId: currentUser.id, 
                        name: currentUser.name,
                        department: currentUser.department || 'N/A',
                        photo: currentUser.photo || null, 
                        duration: selectedDuration,
                        reason: selectedReason.trim(),
                        startDate: startDate_DDMMYYYY, // Store as dd/mm/yyyy
                        endDate: endDate_DDMMYYYY, // Store as dd/mm/yyyy
                        status: 'pending', 
                        requestedAt: serverTimestamp(), 
                        requestId: requestId,
                        firestoreUserId: auth.currentUser ? auth.currentUser.uid : 'unknown_auth_user',
                        type: 'leave' // Add type
                    };
                    
                    const requestRef = doc(db, leaveRequestsCollectionPath, requestId);
                    await setDoc(requestRef, requestData);
                    console.log("Firestore (leave) write successful.");

                    // --- Send Telegram Notification ---
                    const dateString = (startDate_DDMMYYYY === endDate_DDMMYYYY) ? startDate_DDMMYYYY : `ពី ${startDate_DDMMYYYY} ដល់ ${endDate_DDMMYYYY}`;
                    
                    let message = `<b>🔔 សំណើសុំច្បាប់ឈប់សម្រាក 🔔</b>\n\n`;
                    message += `<b>ឈ្មោះ:</b> ${requestData.name}\n`;
                    message += `<b>អត្តលេខ:</b> ${requestData.userId}\n`;
                    message += `<b>ផ្នែក:</b> ${requestData.department}\n`;
                    message += `<b>រយៈពេល:</b> ${requestData.duration}\n`;
                    message += `<b>កាលបរិច្ឆេទ:</b> ${dateString}\n`;
                    message += `<b>មូលហេតុ:</b> ${requestData.reason}\n\n`;
                    message += `(សូមចូល Firestore ដើម្បីពិនិត្យ ID: \`${requestId}\`)`;
                    
                    await sendTelegramNotification(message);

                    if (requestLoadingEl) requestLoadingEl.classList.add('hidden');
                    alert('សំណើរបស់អ្នកត្រូវបានផ្ញើដោយជោគជ័យ!');
                    navigateTo('page-history'); 

                } catch (error) {
                    console.error("Error submitting leave request:", error);
                     let displayError = error.message;
                     if (error.code && error.code.includes('permission-denied')) {
                         displayError = 'Missing or insufficient permissions. សូមពិនិត្យ Firestore Rules។';
                     }
                    if (leaveRequestErrorEl) {
                        leaveRequestErrorEl.textContent = `Error: ${displayError}`;
                        leaveRequestErrorEl.classList.remove('hidden');
                    }
                    if (leaveRequestLoadingEl) leaveRequestLoadingEl.classList.add('hidden');
                    if (submitLeaveRequestBtn) submitLeaveRequestBtn.disabled = false; 
                }
            });

            // --- OUT Request Logic (ចេញក្រៅ) ---
            const outDurations = ["មួយព្រឹក", "មួយរសៀល", "មួយថ្ងៃ"];
            const outDurationItems = outDurations.map(d => ({ text: d, value: d }));
            
            const outReasons = ["ទៅផ្សារ", "ទៅកាត់សក់", "ទៅភ្នំពេញ", "ទៅពេទ្យ", "ទៅយកអីវ៉ាន់"];
            const outReasonItems = outReasons.map(r => ({ text: r, value: r }));

            // Setup the out duration dropdown
            getOutDurationSelection = setupSearchableDropdown('out-duration-search', 'out-duration-dropdown', outDurationItems, null, false); // No custom durations
            // Setup the out reason dropdown
            getOutReasonSelection = setupSearchableDropdown('out-reason-search', 'out-reason-dropdown', outReasonItems, null, true); // Allow custom reasons

            if (openOutRequestBtn) openOutRequestBtn.addEventListener('click', () => {
                console.log("Opening out request form.");
                 if (!currentUser) {
                     alert("សូម Login ជាមុនសិន។");
                     return;
                 }
                
                 const reqPhoto = document.getElementById('out-request-user-photo');
                 const reqName = document.getElementById('out-request-user-name');
                 const reqId = document.getElementById('out-request-user-id');
                 const reqDept = document.getElementById('out-request-user-department');

                 if(reqPhoto) reqPhoto.src = currentUser.photo || 'https://placehold.co/60x60/e2e8f0/64748b?text=User';
                 if(reqName) reqName.textContent = currentUser.name;
                 if(reqId) reqId.textContent = currentUser.id;
                 if(reqDept) reqDept.textContent = currentUser.department || 'មិនមាន';
                
                if (outDurationSearchInput) outDurationSearchInput.value = '';
                if (outReasonSearchInput) outReasonSearchInput.value = '';
                if (outDateInput) outDateInput.value = getTodayString_DDMMYYYY(); // Set today's date
                if (outRequestErrorEl) outRequestErrorEl.classList.add('hidden');
                if (outRequestLoadingEl) outRequestLoadingEl.classList.add('hidden');
                if (submitOutRequestBtn) submitOutRequestBtn.disabled = false;
                
                navigateTo('page-request-out');
            });
            
            if (cancelOutRequestBtn) cancelOutRequestBtn.addEventListener('click', () => {
                 console.log("Cancelling out request.");
                 navigateTo('page-home');
            });
            
            if (submitOutRequestBtn) submitOutRequestBtn.addEventListener('click', async () => {
                 console.log("Submit out request button clicked.");
                 
                 const selectedDuration = getOutDurationSelection ? getOutDurationSelection() : null;
                 const selectedReason = getOutReasonSelection ? getOutReasonSelection() : null;

                 // Validation
                 if (!currentUser || !currentUser.id) {
                     alert("មានបញ្ហា៖ មិនអាចបញ្ជាក់អ្នកប្រើប្រាស់បានទេ។ សូមព្យាយាម Login ម្ដងទៀត។");
                     return;
                 }
                if (!selectedDuration) {
                    if (outRequestErrorEl) {
                        outRequestErrorEl.textContent = 'សូមជ្រើសរើស "រយៈពេល" ពីក្នុងបញ្ជី។';
                        outRequestErrorEl.classList.remove('hidden');
                    }
                    return;
                }
                
                if (!selectedReason || selectedReason.trim() === '') {
                    if (outRequestErrorEl) {
                        outRequestErrorEl.textContent = 'សូមបំពេញ "មូលហេតុ" ជាមុនសិន។';
                        outRequestErrorEl.classList.remove('hidden');
                    }
                    return;
                }
                
                if (outRequestErrorEl) outRequestErrorEl.classList.add('hidden');
                if (outRequestLoadingEl) outRequestLoadingEl.classList.remove('hidden');
                if (submitOutRequestBtn) submitOutRequestBtn.disabled = true;

                try {
                    const date_DDMMYYYY = outDateInput ? outDateInput.value : getTodayString_DDMMYYYY();
                    const requestId = `out_${Date.now()}`;
                    
                    const requestData = {
                        userId: currentUser.id, 
                        name: currentUser.name,
                        department: currentUser.department || 'N/A',
                        photo: currentUser.photo || null, 
                        duration: selectedDuration,
                        reason: selectedReason.trim(),
                        startDate: date_DDMMYYYY, // Store as dd/mm/yyyy
                        endDate: date_DDMMYYYY, // Store as dd/mm/yyyy
                        status: 'pending', 
                        requestedAt: serverTimestamp(), 
                        requestId: requestId,
                        firestoreUserId: auth.currentUser ? auth.currentUser.uid : 'unknown_auth_user',
                        type: 'out' // Add type
                    };
                    
                    const requestRef = doc(db, outRequestsCollectionPath, requestId);
                    await setDoc(requestRef, requestData);
                    console.log("Firestore (out) write successful.");

                    // --- Send Telegram Notification ---
                    let message = `<b>🔔 សំណើសុំច្បាប់ចេញក្រៅ 🔔</b>\n\n`;
                    message += `<b>ឈ្មោះ:</b> ${requestData.name}\n`;
                    message += `<b>អត្តលេខ:</b> ${requestData.userId}\n`;
                    message += `<b>ផ្នែក:</b> ${requestData.department}\n`;
                    message += `<b>រយៈពេល:</b> ${requestData.duration}\n`;
                    message += `<b>កាលបរិច្ឆេទ:</b> ${requestData.startDate}\n`;
                    message += `<b>មូលហេតុ:</b> ${requestData.reason}\n\n`;
                    message += `(សូមចូល Firestore ដើម្បីពិនិត្យ ID: \`${requestId}\`)`;
                    
                    await sendTelegramNotification(message);

                    if (requestLoadingEl) requestLoadingEl.classList.add('hidden');
                    alert('សំណើរបស់អ្នកត្រូវបានផ្ញើដោយជោគជ័យ!');
                    navigateTo('page-history'); 
                    // Activate the "Out" tab
                    if (historyTabButtons) showHistoryTab('history-out');

                } catch (error) {
                    console.error("Error submitting out request:", error);
                     let displayError = error.message;
                     if (error.code && error.code.includes('permission-denied')) {
                         displayError = 'Missing or insufficient permissions. សូមពិនិត្យ Firestore Rules។';
                     }
                    if (outRequestErrorEl) {
                        outRequestErrorEl.textContent = `Error: ${displayError}`;
                        outRequestErrorEl.classList.remove('hidden');
                    }
                    if (outRequestLoadingEl) outRequestLoadingEl.classList.add('hidden');
                    if (submitOutRequestBtn) submitOutRequestBtn.disabled = false; 
                }
            });
            
            // --- Telegram Helper ---
            async function sendTelegramNotification(message) {
                 console.log("Sending Telegram notification...");
                 try {
                    const telegramUrl = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                     const telegramResponse = await fetch(telegramUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: CHAT_ID,
                            text: message,
                            parse_mode: 'HTML'
                        })
                    });
                     if (!telegramResponse.ok) {
                         const errorBody = await telegramResponse.text();
                         console.error("Telegram API error:", telegramResponse.status, errorBody);
                     } else {
                         console.log("Telegram notification sent successfully.");
                     }
                 } catch (error) {
                     console.error("Failed to send Telegram message:", error);
                 }
            }


            // --- History Page Logic (Real-time) ---
            
            // History Tab switching
            if (historyTabButtons) {
                historyTabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const tabId = button.dataset.tab;
                        showHistoryTab(tabId);
                    });
                });
            }
            
            function showHistoryTab(tabId) {
                if (historyTabButtons) {
                    historyTabButtons.forEach(btn => {
                        if (btn.dataset.tab === tabId) {
                            btn.classList.add('border-blue-600', 'text-blue-600');
                            btn.classList.remove('border-transparent', 'text-gray-500');
                        } else {
                            btn.classList.remove('border-blue-600', 'text-blue-600');
                            btn.classList.add('border-transparent', 'text-gray-500');
                        }
                    });
                }
                if (historyTabPanels) {
                     historyTabPanels.forEach(panel => {
                         if (panel.id === tabId) {
                             panel.classList.remove('hidden');
                         } else {
                             panel.classList.add('hidden');
                         }
                     });
                 }
                 console.log("Switched to history tab:", tabId);
            }

            function setupHistoryListener(currentEmployeeId) {
                console.log("Setting up ALL history listeners for employee ID:", currentEmployeeId);
                
                if (historyLeaveUnsubscribe) {
                     console.log("Detaching previous LEAVE history listener.");
                    historyLeaveUnsubscribe(); 
                }
                if (historyOutUnsubscribe) {
                     console.log("Detaching previous OUT history listener.");
                    historyOutUnsubscribe(); 
                }
                
                if (!db || !leaveRequestsCollectionPath || !outRequestsCollectionPath) {
                    console.error("Firestore DB or Collection Paths are not initialized. Cannot setup history listeners.");
                    return;
                }
                
                // --- Get date range for current month ---
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59); // End of last day
                
                const startTimestamp = Timestamp.fromDate(firstDayOfMonth);
                const endTimestamp = Timestamp.fromDate(lastDayOfMonth);
                console.log("History date range:", firstDayOfMonth.toString(), "to", lastDayOfMonth.toString());

                // --- Listener for LEAVE requests ---
                const leaveHistoryQuery = query(
                    collection(db, leaveRequestsCollectionPath),
                    where("userId", "==", currentEmployeeId),
                    where("requestedAt", ">=", startTimestamp),
                    where("requestedAt", "<=", endTimestamp)
                );
                
                historyLeaveUnsubscribe = onSnapshot(leaveHistoryQuery, (snapshot) => {
                     console.log(`Received LEAVE history snapshot. Empty: ${snapshot.empty}, Size: ${snapshot.size}`);
                     const requests = [];
                     snapshot.forEach(doc => requests.push(doc.data()));
                     renderHistoryCards(requests, 'leave');
                }, (error) => {
                    console.error("Error listening to LEAVE history:", error);
                    let errorMsg = 'Error: មិនអាចទាញយកប្រវត្តិបានទេ';
                    if (error.code && error.code.includes('permission-denied')) {
                         errorMsg = 'Error: មិនមានសិទ្ធិទាញយកប្រវត្តិ (Permission Denied)';
                     } else if (error.code && error.code.includes('failed-precondition')) {
                         errorMsg = 'Error: មិនទាន់បានបង្កើត Index (សូមមើល Console)';
                     }
                    if (historyPlaceholderLeave) {
                        historyPlaceholderLeave.classList.remove('hidden');
                        historyPlaceholderLeave.innerHTML = `<p class="text-red-500">${errorMsg}</p>`;
                    }
                    if (historyContainerLeave) historyContainerLeave.innerHTML = ''; 
                });

                // --- Listener for OUT requests ---
                 const outHistoryQuery = query(
                    collection(db, outRequestsCollectionPath),
                    where("userId", "==", currentEmployeeId),
                    where("requestedAt", ">=", startTimestamp),
                    where("requestedAt", "<=", endTimestamp)
                );
                
                historyOutUnsubscribe = onSnapshot(outHistoryQuery, (snapshot) => {
                     console.log(`Received OUT history snapshot. Empty: ${snapshot.empty}, Size: ${snapshot.size}`);
                     const requests = [];
                     snapshot.forEach(doc => requests.push(doc.data()));
                     renderHistoryCards(requests, 'out');
                }, (error) => {
                    console.error("Error listening to OUT history:", error);
                     let errorMsg = 'Error: មិនអាចទាញយកប្រវត្តិបានទេ';
                    if (error.code && error.code.includes('permission-denied')) {
                         errorMsg = 'Error: មិនមានសិទ្ធិទាញយកប្រវត្តិ (Permission Denied)';
                     } else if (error.code && error.code.includes('failed-precondition')) {
                         errorMsg = 'Error: មិនទាន់បានបង្កើត Index (សូមមើល Console)';
                     }
                    if (historyPlaceholderOut) {
                        historyPlaceholderOut.classList.remove('hidden');
                        historyPlaceholderOut.innerHTML = `<p class="text-red-500">${errorMsg}</p>`;
                    }
                    if (historyContainerOut) historyContainerOut.innerHTML = ''; 
                });
            }
            
            function renderHistoryCards(requests, type) {
                const container = (type === 'leave') ? historyContainerLeave : historyContainerOut;
                const placeholder = (type === 'leave') ? historyPlaceholderLeave : historyPlaceholderOut;
                
                if (!container || !placeholder) return;

                if (requests.length === 0) {
                    placeholder.classList.remove('hidden');
                    container.innerHTML = ''; 
                    return;
                }
                
                placeholder.classList.add('hidden');
                container.innerHTML = ''; // Clear before rendering
                
                // Custom sort: pending/editing first, then by date
                const statusPriority = { 'pending': 1, 'editing': 2, 'approved': 3, 'rejected': 4 };
                
                requests.sort((a, b) => {
                    const statusA = statusPriority[a.status] || 5;
                    const statusB = statusPriority[b.status] || 5;
                    
                    if (statusA !== statusB) {
                        return statusA - statusB; // Sort by status priority
                    }
                    
                    // If status is same, sort by date (newest first)
                     const timeA = a.requestedAt?.toMillis ? a.requestedAt.toMillis() : 0;
                     const timeB = b.requestedAt?.toMillis ? b.requestedAt.toMillis() : 0;
                    return timeB - timeA; 
                });
                
                console.log(`Rendering ${requests.length} history items for type: ${type}`);
                requests.forEach(request => {
                    if (!request || !request.requestId) {
                         console.warn("Attempted to render invalid history card data:", request);
                         return; 
                     }
                    
                    let statusColor, statusText;
                    let showActions = false;
                    switch(request.status) {
                        case 'approved':
                            statusColor = 'bg-green-100 text-green-800';
                            statusText = 'បានយល់ព្រម';
                            break;
                        case 'rejected':
                            statusColor = 'bg-red-100 text-red-800';
                            statusText = 'បានបដិសេធ';
                            break;
                        case 'editing':
                             statusColor = 'bg-blue-100 text-blue-800';
                             statusText = 'កំពុងកែសម្រួល...';
                             break;
                        default: // pending
                            statusColor = 'bg-yellow-100 text-yellow-800';
                            statusText = 'កំពុងរង់ចាំ';
                            showActions = true; // Show actions only for pending
                    }
                    
                    const dateString = (request.startDate === request.endDate) 
                        ? request.startDate 
                         : (request.startDate && request.endDate ? `${request.startDate} ដល់ ${request.endDate}` : 'N/A');
                         
                    const decisionTime = request.decisionAt ? formatTime(request.decisionAt) : '';

                    const card = `
                        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 mb-4">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-semibold text-gray-800">${request.duration || 'N/A'}</span>
                                <span class="text-xs text-right">
                                    <div class="font-medium px-2 py-0.5 rounded-full ${statusColor}">
                                        ${statusText}
                                    </div>
                                    ${decisionTime ? `<p class="text-gray-400 mt-1">${decisionTime}</p>` : ''}
                                </span>
                            </div>
                            <p class="text-sm text-gray-600">${dateString}</p>
                            <p class="text-sm text-gray-500 mt-1"><b>មូលហេតុ:</b> ${request.reason || 'មិនបានបញ្ជាក់'}</p>
                            
                            ${showActions ? `
                            <hr class="my-3 border-gray-100">
                            <div class="flex items-center justify-end space-x-2">
                                <button class="edit-btn p-2 text-gray-500 hover:text-blue-600" 
                                        data-id="${request.requestId}" 
                                        data-type="${request.type}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </button>
                                <button class="delete-btn p-2 text-gray-500 hover:text-red-600" 
                                        data-id="${request.requestId}" 
                                        data-type="${request.type}"
                                        data-name="${request.duration} (${dateString})">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            ` : `
                            <p class="text-xs text-gray-400 mt-2">
                                ID: ${request.requestId}
                            </p>
                            `}
                        </div>
                    `;
                    container.innerHTML += card;
                });
                
                // Add event listeners to new buttons
                container.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => openEditModal(btn.dataset.id, btn.dataset.type));
                });
                container.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => openDeleteConfirm(btn.dataset.id, btn.dataset.type, btn.dataset.name));
                });
            }

            // --- Edit Modal Logic ---
            function openEditModal(requestId, type) {
                console.log(`Opening edit modal for ${type} request: ${requestId}`);
                 if (!editModal || !editForm) return;

                // Find the request data (must be loaded already by onSnapshot)
                const collection = (type === 'leave') ? historyContainerLeave : historyContainerOut;
                const cardElement = collection.querySelector(`[data-id="${requestId}"]`);
                
                // This is a simplified way; a better way would be to fetch from the array
                // For now, we assume data is available or fetch it again
                // Simple fetch from Firestore (as snapshot data might be complex to query locally)
                const collectionPath = (type === 'leave') ? leaveRequestsCollectionPath : outRequestsCollectionPath;
                const docRef = doc(db, collectionPath, requestId);
                
                docRef.get().then(docSnap => {
                    if (docSnap.exists()) {
                        editingRequest = docSnap.data();
                        
                        if (editingRequest.status !== 'pending') {
                             alert("មិនអាចកែសម្រួលសំណើ ដែលត្រូវបានអនុម័ត ឬបដិសេធរួចហើយបានទេ។");
                             return;
                         }
                        
                        // Populate modal
                        if(editRequestIdInput) editRequestIdInput.value = editingRequest.requestId;
                        if(editTypeInput) editTypeInput.value = editingRequest.type;
                        
                        const items = (type === 'leave') ? leaveDurationItems : outDurationItems;
                        const allowCustomReason = true; // Always allow
                        const allowCustomDuration = (type === 'out'); // Only for Out requests
                        
                        // Setup dropdowns for the modal
                        getEditDurationSelection = setupSearchableDropdown('edit-duration-search', 'edit-duration-dropdown', items, (duration) => {
                             if (type === 'leave') updateEditDateFields(duration);
                         }, false); // Never allow custom duration
                         
                        getEditReasonSelection = setupSearchableDropdown('edit-reason-search', 'edit-reason-dropdown', 
                            (type === 'leave') ? leaveReasonItems : outReasonItems, 
                            null, 
                            true); // Always allow custom reason

                        // Set values
                        if(editDurationSearch) editDurationSearch.value = editingRequest.duration;
                        if(editReasonSearch) editReasonSearch.value = editingRequest.reason;
                        
                        // Manually trigger callbacks to set initial state
                        getEditDurationSelection();
                        getEditReasonSelection();
                        
                        if (type === 'leave') {
                            updateEditDateFields(editingRequest.duration); // Call this to show/hide date fields
                            // Set date values
                            if (leaveSingleDayDurations.includes(editingRequest.duration)) {
                                 if(editSingleDateContainer) editSingleDateContainer.querySelector('input').value = convertDDMMYYYYtoYYYYMMDD(editingRequest.startDate);
                            } else {
                                if(editStartDateInput) editStartDateInput.value = convertDDMMYYYYtoYYYYMMDD(editingRequest.startDate);
                                if(editEndDateInput) editEndDateInput.value = convertDDMMYYYYtoYYYYMMDD(editingRequest.endDate);
                            }
                        } else {
                            // For 'out' request
                            if(editSingleDateContainer) {
                                editSingleDateContainer.classList.remove('hidden');
                                editSingleDateContainer.querySelector('input').value = convertDDMMYYYYtoYYYYMMDD(editingRequest.startDate);
                                editSingleDateContainer.querySelector('input').disabled = true; // Still can't change date
                            }
                            if(editDateRangeContainer) editDateRangeContainer.classList.add('hidden');
                        }
                        
                        if(editErrorEl) editErrorEl.classList.add('hidden');
                        if(editModal) editModal.classList.remove('hidden');
                        
                        // Set status to 'editing'
                        updateDoc(docRef, { status: 'editing' });
                        console.log("Request status set to 'editing'.");
                        
                    } else {
                        console.error("Document not found for editing:", requestId);
                        alert("Error: រកមិនឃើញសំណើសម្រាប់កែសម្រួលទេ។");
                    }
                }).catch(error => {
                    console.error("Error fetching document for edit:", error);
                     alert(`Error: ${error.message}`);
                });
            }
            
            function updateEditDateFields(duration) {
                // Similar to updateLeaveDateFields, but for the edit modal
                 const singleContainer = document.getElementById('edit-single-date-container');
                 const rangeContainer = document.getElementById('edit-date-range-container');
                 const singleInput = singleContainer ? singleContainer.querySelector('input') : null;
                 const startInput = document.getElementById('edit-date-start');
                 const endInput = document.getElementById('edit-date-end');
                 
                 if (!singleContainer || !rangeContainer || !singleInput || !startInput || !endInput) return;

                if (!duration) {
                    singleContainer.classList.add('hidden');
                    rangeContainer.classList.add('hidden');
                    return;
                }

                if (leaveSingleDayDurations.includes(duration)) {
                    singleContainer.classList.remove('hidden');
                    rangeContainer.classList.add('hidden');
                    singleInput.disabled = false; // Allow editing single date
                } else {
                    singleContainer.classList.add('hidden');
                    rangeContainer.classList.remove('hidden');
                    startInput.disabled = false; // Allow editing start date
                    endInput.disabled = false; // Allow editing end date
                }
            }

            if (cancelEditBtn) cancelEditBtn.addEventListener('click', async () => {
                if (editModal) editModal.classList.add('hidden');
                if (editingRequest) {
                    // Revert status to 'pending'
                    const collectionPath = (editingRequest.type === 'leave') ? leaveRequestsCollectionPath : outRequestsCollectionPath;
                    const docRef = doc(db, collectionPath, editingRequest.requestId);
                    try {
                         await updateDoc(docRef, { status: 'pending' });
                         console.log("Edit cancelled, status reverted to 'pending'.");
                     } catch (error) {
                         console.error("Error reverting status on cancel:", error);
                     }
                    editingRequest = null;
                }
            });

            if (saveEditBtn) saveEditBtn.addEventListener('click', async () => {
                 if (!editingRequest || !getEditDurationSelection || !getEditReasonSelection) return;

                 const selectedDuration = getEditDurationSelection();
                 const selectedReason = getEditReasonSelection();
                 
                 // Validation
                 if (!selectedDuration) {
                     if(editErrorEl) {
                         editErrorEl.textContent = 'សូមជ្រើសរើស "រយៈពេល" ពីក្នុងបញ្ជី។';
                         editErrorEl.classList.remove('hidden');
                     }
                     return;
                 }
                 if (!selectedReason || selectedReason.trim() === '') {
                     if(editErrorEl) {
                         editErrorEl.textContent = 'សូមបំពេញ "មូលហេតុ" ជាមុនសិន។';
                         editErrorEl.classList.remove('hidden');
                     }
                     return;
                 }
                 
                 if(editErrorEl) editErrorEl.classList.add('hidden');
                 saveEditBtn.disabled = true;

                try {
                     const collectionPath = (editingRequest.type === 'leave') ? leaveRequestsCollectionPath : outRequestsCollectionPath;
                     const docRef = doc(db, collectionPath, editingRequest.requestId);
                     
                     let startDate_DDMMYYYY, endDate_DDMMYYYY;
                     
                     if (editingRequest.type === 'leave') {
                         const startDate_YYYYMMDD = leaveSingleDayDurations.includes(selectedDuration)
                             ? (editSingleDateContainer.querySelector('input').value)
                             : (editStartDateInput.value);
                         const endDate_YYYYMMDD = leaveSingleDayDurations.includes(selectedDuration)
                             ? startDate_YYYYMMDD
                             : (editEndDateInput.value);
                             
                         if (new Date(endDate_YYYYMMDD) < new Date(startDate_YYYYMMDD)) {
                             throw new Error('"ថ្ងៃបញ្ចប់" មិនអាចនៅមុន "ថ្ងៃចាប់ផ្តើម" បានទេ។');
                         }
                         startDate_DDMMYYYY = convertYYYYMMDDtoDDMMYYYY(startDate_YYYYMMDD);
                         endDate_DDMMYYYY = convertYYYYMMDDtoDDMMYYYY(endDate_YYYYMMDD);
                     } else {
                         // 'out' request - date is not editable
                         startDate_DDMMYYYY = editingRequest.startDate;
                         endDate_DDMMYYYY = editingRequest.endDate;
                     }
                     
                     const updatedData = {
                         duration: selectedDuration,
                         reason: selectedReason.trim(),
                         startDate: startDate_DDMMYYYY,
                         endDate: endDate_DDMMYYYY,
                         status: 'pending', // Revert status to pending
                         requestedAt: serverTimestamp() // Update timestamp to new
                     };
                     
                     await updateDoc(docRef, updatedData);
                     console.log("Request updated successfully.");

                     // Send new Telegram notification
                    const dateString = (startDate_DDMMYYYY === endDate_DDMMYYYY) ? startDate_DDMMYYYY : `ពី ${startDate_DDMMYYYY} ដល់ ${endDate_DDMMYYYY}`;
                    const typeText = (editingRequest.type === 'leave') ? "ច្បាប់ឈប់សម្រាក" : "ច្បាប់ចេញក្រៅ";
                    
                    let message = `<b>🔔 សំណើ (បានកែសម្រួល) 🔔</b>\n\n`;
                    message += `<b>ប្រភេទ:</b> ${typeText}\n`;
                    message += `<b>ឈ្មោះ:</b> ${editingRequest.name}\n`;
                    message += `<b>អត្តលេខ:</b> ${editingRequest.userId}\n`;
                    message += `<b>រយៈពេល:</b> ${updatedData.duration}\n`;
                    message += `<b>កាលបរិច្ឆេទ:</b> ${dateString}\n`;
                    message += `<b>មូលហេតុ:</b> ${updatedData.reason}\n\n`;
                    message += `(សូមចូល Firestore ពិនិត្យ ID: \`${editingRequest.requestId}\`)`;
                    
                    await sendTelegramNotification(message);

                     if(editModal) editModal.classList.add('hidden');
                     editingRequest = null;

                } catch (error) {
                     console.error("Error saving edit:", error);
                     if(editErrorEl) {
                         editErrorEl.textContent = `Error: ${error.message}`;
                         editErrorEl.classList.remove('hidden');
                     }
                 } finally {
                     if(saveEditBtn) saveEditBtn.disabled = false;
                 }
            });

            // --- Delete Confirm Logic ---
            function openDeleteConfirm(requestId, type, name) {
                console.log(`Opening delete confirm for ${type} request: ${requestId}`);
                requestToDelete = { requestId, type };
                if (deleteConfirmText) deleteConfirmText.textContent = `តើអ្នកប្រាកដទេ ថាចង់លុបសំណើ "${name}"?`;
                if (deleteConfirmModal) deleteConfirmModal.classList.remove('hidden');
            }
            
            if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => {
                 if (deleteConfirmModal) deleteConfirmModal.classList.add('hidden');
                 requestToDelete = null;
            });
            
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', async () => {
                 if (!requestToDelete) return;
                 
                 confirmDeleteBtn.disabled = true;
                 const { requestId, type } = requestToDelete;
                 const collectionPath = (type === 'leave') ? leaveRequestsCollectionPath : outRequestsCollectionPath;
                 const docRef = doc(db, collectionPath, requestId);

                 try {
                     await deleteDoc(docRef);
                     console.log("Request deleted successfully:", requestId);
                     if (deleteConfirmModal) deleteConfirmModal.classList.add('hidden');
                     requestToDelete = null;
                     
                     // Send Telegram Notification
                    let message = `<b>❌ សំណើត្រូវបានលុបចោល ❌</b>\n\n`;
                    message += `<b>User:</b> ${currentUser.name}\n`;
                    message += `<b>ID:</b> \`${requestId}\`\n`;
                    message += `(សំណើនេះ ត្រូវបានលុបដោយ User ផ្ទាល់។)`;
                    await sendTelegramNotification(message);
                     
                 } catch (error) {
                     console.error("Error deleting request:", error);
                     alert(`Error: ${error.message}`);
                 } finally {
                     if (confirmDeleteBtn) confirmDeleteBtn.disabled = false;
                 }
            });

        });
    </script>
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }
        /* Custom scrollbar for dropdown */
        .custom-dropdown {
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #f3f4f6;
        }
        .custom-dropdown::-webkit-scrollbar {
            width: 6px;
        }
        .custom-dropdown::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 10px;
        }
        .custom-dropdown::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 10px;
            border: 2px solid #f3f4f6;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* History Tab Active State */
        .history-tab-btn.border-blue-600 {
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ===== CRITICAL ERROR DISPLAY ===== -->
    <div id="critical-error-display" class="max-w-md mx-auto min-h-screen flex flex-col justify-center items-center p-6 text-center text-red-600 font-semibold hidden">
        <!-- Error message will be injected here by JS -->
    </div>

    <!-- ===== LOGIN PAGE ===== -->
    <div id="page-login" class="max-w-md mx-auto min-h-screen flex flex-col justify-center items-center p-6 bg-gray-50">
        <!-- Logo and Title -->
        <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="h-20 w-20 mb-4">
        <h1 class="text-2xl font-bold text-blue-800 mb-2">ឧស្សាហកម្មឌីជីថល</h1>
        <p class="text-gray-600 mb-8">សូមចូលប្រើកម្មវិធីសុំច្បាប់</p>

        <!-- In-App Browser Warning -->
        <div id="in-app-warning" class="w-full max-w-sm p-4 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800 text-sm text-left hidden">
            <p class="font-bold text-base mb-2">បញ្ហាកាមេរ៉ា!</p>
            <p>កម្មវិធីនេះ ត្រូវការបើកកាមេរ៉ា ដែលមិនអាចដំណើរការក្នុង Telegram/Facebook បានទេ។</p>
            <p class="font-semibold mt-3">ដំណោះស្រាយ៖</p>
            <ol class="list-decimal list-inside mt-1">
                <li>នៅខាងលើស្តាំ, ចុចសញ្ញា <span class="font-bold">...</span></li>
                <li>ជ្រើសរើស "Open in Browser" (បើកក្នុង Browser)</li>
            </ol>
            <p class="mt-2">បន្ទាប់មក កម្មវិធីនឹងបើកក្នុង Chrome/Safari ហើយកាមេរ៉ានឹងដំណើរការ។</p>
        </div>

        <!-- Data Loading Indicator -->
        <div id="data-loading-indicator" class="w-full max-w-sm p-6 bg-white rounded-lg shadow-md border border-gray-200 flex flex-col items-center justify-center hidden">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600 font-medium">កំពុងទាញយកទិន្នន័យបុគ្គលិក...</p>
            <p class="text-xs text-gray-400 mt-1">សូមរង់ចាំបន្តិច</p>
        </div>

        <!-- Form (will be hidden until data loads) -->
        <div id="login-form-container" class="w-full bg-white p-6 rounded-lg shadow-md border border-gray-200 hidden">
            <!-- Searchable Dropdown -->
            <label for="user-search" class="block text-sm font-medium text-gray-700 mb-2">ជ្រើសរើសអត្តលេខ (ID)</label>
            <div class="relative">
                <input
                    type="text"
                    id="user-search"
                    placeholder="វាយ ឬ ជ្រើសរើស..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    autocomplete="off"
                >
                <!-- Custom Dropdown List -->
                <div
                    id="user-dropdown"
                    class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden custom-dropdown"
                >
                    <!-- User items will be injected here by JS -->
                </div>
            </div>
            
            <!-- Remember Me Checkbox -->
            <div class="flex items-center mt-4">
                <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="remember-me" class="ml-2 block text-sm text-gray-700">ចងចាំខ្ញុំនៅលើ Device នេះ</label>
            </div>

            <!-- Login Button -->
            <button id="scan-face-btn" class="mt-6 w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 flex items-center justify-center space-x-2 disabled:opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm11 11H5V5h10v8zm-5 2a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                <span>ចូលដោយស្កេនផ្ទៃមុខ</span>
            </button>
            <p id="model-status" class="text-xs text-gray-500 text-center mt-2"></p>
        </div>
    </div>

    <!-- ===== Face Scan Modal ===== -->
    <div id="face-scan-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md text-center">
            <h3 class="text-xl font-bold mb-4">កំពុងស្កេនផ្ទៃមុខ</h3>
            <div class="relative w-full h-64 bg-gray-800 rounded-lg overflow-hidden border-4 border-blue-500">
                <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
            </div>
            <p id="scan-status" class="mt-4 text-lg font-medium text-gray-700">រកមិនឃើញផ្ទៃមុខ...</p>
            <button id="cancel-scan-btn" class="mt-4 w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300">
                បោះបង់
            </button>
        </div>
    </div>

    <!-- ===== MAIN APP (Hidden by default) ===== -->
    <div id="main-app-container" class="max-w-md mx-auto min-h-screen bg-white shadow-lg hidden">
        
        <!-- Main Content Area (scrollable) -->
        <main id="main-content" class="pb-20" style="height: 100vh; overflow-y: auto;">
            
            <!-- ===== PAGE 1: HOME (ទំព័រដើម) ===== -->
            <div id="page-home" class="p-6">
                <!-- Header -->
                <header class="flex items-center justify-between mb-8">
                    <div class="flex items-center space-x-3">
                        <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="h-10 w-10 rounded-full border">
                        <div>
                            <p class="text-sm text-gray-500">ស្វាគមន៍</p>
                            <h2 id="home-user-name" class="text-xl font-bold text-gray-800">...</h2>
                        </div>
                    </div>
                </header>

                <!-- Request Types Section -->
                <section>
                    <h3 class="text-md font-semibold text-gray-700 mb-3">ប្រភេទសំណើសុំច្បាប់</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Leave Request -->
                        <button id="open-leave-request-btn" class="bg-blue-50 border border-blue-200 text-blue-800 p-6 rounded-lg shadow-sm hover:bg-blue-100 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-lg font-semibold">សុំច្បាប់ឈប់</p>
                            <p class="text-sm">ឈប់សម្រាក</p>
                        </button>
                        <!-- Out Request -->
                        <button id="open-out-request-btn" class="bg-green-50 border border-green-200 text-green-800 p-6 rounded-lg shadow-sm hover:bg-green-100 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-lg font-semibold">សុំច្បាប់ចេញក្រៅ</p>
                            <p class="text-sm">ចេញក្រៅផ្ទាល់ខ្លួន</p>
                        </button>
                    </div>
                </section>
                
                <!-- Approver Section -->
                <section class="mt-8">
                    <h3 class="text-md font-semibold text-gray-700 mb-3">អ្នកអនុញ្ញាតច្បាប់</h3>
                    <button class="w-full bg-white border border-gray-300 p-4 rounded-lg shadow-sm hover:bg-gray-50 transition-all flex items-center space-x-4">
                        <img src="https://i.postimg.cc/cL3wdGs8/photo-2025-09-27-15-47-14.jpg" alt="Approver" class="h-16 w-16 rounded-full border-2 border-white shadow-md object-cover">
                        <div>
                            <p class="text-lg font-semibold text-gray-800 text-left">លោកគ្រូ​ ពៅ ដារ៉ូ</p>
                            <p class="text-sm text-gray-500 text-left">គណៈគ្រប់គ្រង</p>
                        </div>
                    </button>
                </section>
            </div>

            <!-- ===== PAGE 2: ACCOUNT (គណនី) ===== -->
            <div id="page-account" class="p-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">គណនីរបស់ខ្ញុំ</h2>
                
                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
                    <div class="flex flex-col items-center">
                        <img id="user-photo" src="https://placehold.co/100x100/e2e8f0/64748b?text=User" alt="User Photo" class="h-24 w-24 rounded-full border-4 border-white shadow-lg mb-4 object-cover">
                        <h3 id="user-name" class="text-xl font-bold text-gray-900">...</h3>
                        <p id="user-id" class="text-sm text-gray-500">...</p>
                    </div>
                    
                    <hr class="my-6 border-gray-200">
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-500 font-medium">ភេទ:</span>
                            <span id="user-gender" class="font-semibold text-gray-800">...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500 font-medium">ក្រុម:</span>
                            <span id="user-group" class="font-semibold text-gray-800">...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500 font-medium">ផ្នែកការងារ:</span>
                            <span id="user-department" class="font-semibold text-gray-800">...</span>
                        </div>
                    </div>
                </div>

                <button id="logout-btn" class="w-full bg-red-500 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-150">
                    ចាកចេញពីគណនី
                </button>
            </div>

            <!-- ===== PAGE 3: HISTORY (ប្រវត្តិ) ===== -->
            <div id="page-history" class="p-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">ប្រវត្តិសុំច្បាប់</h2>
                <p class="text-center text-sm text-gray-500 mb-6">បង្ហាញតែសំណើ សម្រាប់ខែបច្ចុប្បន្នប៉ុណ្ណោះ</p>

                <!-- Tabs -->
                <div class="border-b border-gray-200 mb-4">
                    <nav class="-mb-px flex justify-around" aria-label="Tabs">
                        <button class="history-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-600 text-blue-600" data-tab="history-leave">
                            ច្បាប់ឈប់សម្រាក
                        </button>
                        <button class="history-tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="history-out">
                            ច្បាប់ចេញក្រៅ
                        </button>
                    </nav>
                </div>

                <!-- Tab Panel: Leave -->
                <div id="history-leave" class="history-tab-panel">
                    <div id="history-container-leave">
                        <!-- Leave history cards will be injected here -->
                    </div>
                    <div id="history-placeholder-leave" class="text-center text-gray-500 mt-10 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="mt-4 text-lg">មិនទាន់មានប្រវត្តិ</p>
                    </div>
                </div>
                
                <!-- Tab Panel: Out -->
                <div id="history-out" class="history-tab-panel hidden">
                    <div id="history-container-out">
                        <!-- Out history cards will be injected here -->
                    </div>
                    <div id="history-placeholder-out" class="text-center text-gray-500 mt-10 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="mt-4 text-lg">មិនទាន់មានប្រវត្តិ</p>
                    </div>
                </div>
            </div>

            <!-- ===== PAGE 4: HELP (ជំនួយ) ===== -->
            <div id="page-help" class="p-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ជំនួយ និង ទំនាក់ទំនង</h2>

                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ក្រុមការងារ IT SUPPORT</h3>
                    <p class="text-gray-600 mb-4">ប្រសិនបើអ្នកជួបបញ្ហាក្នុងការប្រើប្រាស់កម្មវិធី សូមទាក់ទងមកក្រុមការងារយើងខ្ញុំតាមរយៈ៖</p>
                    
                    <div class="space-y-4">
                        <!-- Telegram -->
                        <a href="https://t.me/MMKDigitalIndustry" target="_blank" class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 border border-gray-200">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram" class="h-6 w-6">
                            <div class="ml-4">
                                <p class="font-semibold text-blue-600">Telegram</p>
                                <p class="text-sm text-gray-600">@MMKDigitalIndustry</p>
                            </div>
                        </a>
                        <!-- Phone -->
                        <a href="tel:090544452" class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 border border-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                            </svg>
                            <div class="ml-4">
                                <p class="font-semibold text-green-700">លេខទូរស័ព្ទ</p>
                                <p class="text-sm text-gray-600">090 544 452</p>
                            </div>
                        </a>
                        <!-- Email -->
                        <a href="mailto:perdigitalindustry@gmail.com" class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 border border-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <div class="ml-4">
                                <p class="font-semibold text-red-700">អ៊ីម៉ែល</p>
                                <p class="text-sm text-gray-600">perdigitalindustry@gmail.com</p>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="text-center text-xs text-gray-400">
                    <p>&copy; 2024 ឧស្សាហកម្មឌីជីថល</p>
                    <p>អភិវឌ្ឍន៍ដោយ ក្រុមការងារ IT SUPPORT</p>
                </div>
            </div>

            <!-- ===== NEW PAGE 5: REQUEST LEAVE (ទម្រង់សុំច្បាប់) ===== -->
            <div id="page-request-leave" class="p-6 hidden bg-gray-50" style="min-height: 100vh;">
                <!-- Header with Back Button -->
                <header class="flex items-center mb-6">
                    <button id="cancel-leave-request-btn" class="p-2 text-gray-600 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h2 class="text-xl font-bold text-gray-800 text-center flex-grow">ទម្រង់សុំច្បាប់ឈប់សម្រាក</h2>
                    <div class="w-8"></div> <!-- Spacer -->
                </header>

                <!-- User Info -->
                <section class="flex items-center bg-white border border-gray-200 p-4 rounded-lg shadow-sm mb-6">
                    <img id="leave-request-user-photo" src="https://placehold.co/60x60/e2e8f0/64748b?text=User" alt="User Photo" class="h-16 w-16 rounded-full border-2 border-white shadow-md object-cover">
                    <div class="ml-4">
                        <h3 id="leave-request-user-name" class="text-lg font-semibold text-gray-800">...</h3>
                        <p id="leave-request-user-id" class="text-sm text-gray-500">...</p>
                        <p id="leave-request-user-department" class="text-sm text-gray-500">...</p>
                    </div>
                </section>

                <!-- Form -->
                <section class="space-y-4 pb-24">
                    <!-- Duration -->
                    <div>
                        <label for="leave-duration-search" class="block text-sm font-medium text-gray-700 mb-1">រយៈពេល</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="leave-duration-search"
                                placeholder="វាយ ឬ ជ្រើសរើសរយៈពេល..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                autocomplete="off"
                            >
                            <div
                                id="leave-duration-dropdown"
                                class="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden custom-dropdown"
                            >
                                <!-- Duration items will be injected here by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Single Date -->
                    <div id="leave-single-date-container" class="hidden">
                        <label for="leave-date-single" class="block text-sm font-medium text-gray-700 mb-1">កាលបរិច្ឆេទ</label>
                        <input
                            type="text"
                            id="leave-date-single"
                            disabled
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed"
                            placeholder="dd/mm/yyyy"
                        >
                    </div>

                    <!-- Date Range -->
                    <div id="leave-date-range-container" class="hidden space-y-4">
                        <div>
                            <label for="leave-date-start" class="block text-sm font-medium text-gray-700 mb-1">ចាប់ពីថ្ងៃ</label>
                            <input
                                type="text"
                                id="leave-date-start"
                                disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed"
                                placeholder="dd/mm/yyyy"
                            >
                        </div>
                        <div>
                            <label for="leave-date-end" class="block text-sm font-medium text-gray-700 mb-1">ដល់ថ្ងៃ</label>
                            <input
                                type="date"
                                id="leave-date-end"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                    </div>

                    <!-- Reason -->
                    <div>
                        <label for="leave-reason-search" class="block text-sm font-medium text-gray-700 mb-1">មូលហេតុ</Tlabel>
                        <div class="relative">
                            <input
                                type="text"
                                id="leave-reason-search"
                                placeholder="វាយ ឬ ជ្រើសរើសមូលហេតុ..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                autocomplete="off"
                            >
                            <div
                                id="leave-reason-dropdown"
                                class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden custom-dropdown"
                            >
                                <!-- Reason items will be injected here by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <p id="leave-request-error" class="text-red-500 text-sm hidden"></p>
                    
                    <div id="leave-request-loading" class="flex items-center justify-center text-gray-600 hidden">
                        <div class="spinner mr-2" style="width: 20px; height: 20px; border-width: 2px;"></div>
                        <span>កំពុងដំណើរការ...</span>
                    </div>

                </section>

                <footer class="absolute bottom-0 left-0 right-0 p-6 bg-white border-t border-gray-200 max-w-md mx-auto">
                    <button id="submit-leave-request-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 disabled:opacity-50">
                        ស្នើសុំច្បាប់
                    </button>
                </footer>
            </div>
            
            <!-- ===== NEW PAGE 6: REQUEST OUT (ទម្រង់ចេញក្រៅ) ===== -->
            <div id="page-request-out" class="p-6 hidden bg-gray-50" style="min-height: 100vh;">
                <!-- Header with Back Button -->
                <header class="flex items-center mb-6">
                    <button id="cancel-out-request-btn" class="p-2 text-gray-600 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h2 class="text-xl font-bold text-gray-800 text-center flex-grow">ទម្រង់សុំច្បាប់ចេញក្រៅ</h2>
                    <div class="w-8"></div> <!-- Spacer -->
                </header>

                <!-- User Info -->
                <section class="flex items-center bg-white border border-gray-200 p-4 rounded-lg shadow-sm mb-6">
                    <img id="out-request-user-photo" src="https://placehold.co/60x60/e2e8f0/64748b?text=User" alt="User Photo" class="h-16 w-16 rounded-full border-2 border-white shadow-md object-cover">
                    <div class="ml-4">
                        <h3 id="out-request-user-name" class="text-lg font-semibold text-gray-800">...</h3>
                        <p id="out-request-user-id" class="text-sm text-gray-500">...</p>
                        <p id="out-request-user-department" class="text-sm text-gray-500">...</p>
                    </div>
                </section>

                <!-- Form -->
                <section class="space-y-4 pb-24">
                    <!-- Date -->
                    <div>
                        <label for="out-date-single" class="block text-sm font-medium text-gray-700 mb-1">កាលបរិច្ឆេទ</label>
                        <input
                            type="text"
                            id="out-date-single"
                            disabled
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed"
                            placeholder="dd/mm/yyyy"
                        >
                    </div>
                
                    <!-- Duration -->
                    <div>
                        <label for="out-duration-search" class="block text-sm font-medium text-gray-700 mb-1">រយៈពេល</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="out-duration-search"
                                placeholder="វាយ ឬ ជ្រើសរើសរយៈពេល..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                autocomplete="off"
                            >
                            <div
                                id="out-duration-dropdown"
                                class="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden custom-dropdown"
                            >
                                <!-- Duration items will be injected here by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Reason -->
                    <div>
                        <label for="out-reason-search" class="block text-sm font-medium text-gray-700 mb-1">មូលហេតុ</Tlabel>
                        <div class="relative">
                            <input
                                type="text"
                                id="out-reason-search"
                                placeholder="វាយ ឬ ជ្រើសរើសមូលហេតុ..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                autocomplete="off"
                            >
                            <div
                                id="out-reason-dropdown"
                                class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden custom-dropdown"
                            >
                                <!-- Reason items will be injected here by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <p id="out-request-error" class="text-red-500 text-sm hidden"></p>
                    
                    <div id="out-request-loading" class="flex items-center justify-center text-gray-600 hidden">
                        <div class="spinner mr-2" style="width: 20px; height: 20px; border-width: 2px;"></div>
                        <span>កំពុងដំណើរការ...</span>
                    </div>

                </section>

                <footer class="absolute bottom-0 left-0 right-0 p-6 bg-white border-t border-gray-200 max-w-md mx-auto">
                    <button id="submit-out-request-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 disabled:opacity-50">
                        ស្នើសុំច្បាប់
                    </button>
                </footer>
            </div>
        </main>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-navigation" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto h-16 bg-white border-t border-gray-200 shadow-md flex justify-around items-center">
            <!-- Home -->
            <button id="nav-home" class="nav-btn p-2 text-blue-600" data-page="page-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
                <span class="text-xs font-medium">ទំព័រដើម</span>
            </button>
            
            <!-- History Button -->
            <button id="nav-history" class="nav-btn p-2 text-gray-500" data-page="page-history">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs font-medium">ប្រវត្តិ</span>
            </button>

            <!-- Account -->
            <button id="nav-account" class="nav-btn p-2 text-gray-500" data-page="page-account">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                </svg>
                <span class="text-xs font-medium">គណនី</span>
            </button>
            
            <!-- Help -->
            <button id="nav-help" class="nav-btn p-2 text-gray-500" data-page="page-help">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                </svg>
                <span class="text-xs font-medium">ជំនួយ</span>
            </button>
        </nav>
    </div>

    <!-- ===== Edit Request Modal ===== -->
    <div id="edit-request-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-6 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md max-h-screen overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">កែសម្រួលសំណើ</h3>
            
            <form id="edit-request-form" class="space-y-4">
                <input type="hidden" id="edit-request-id">
                <input type="hidden" id="edit-request-type">

                <!-- Duration -->
                <div>
                    <label for="edit-duration-search" class="block text-sm font-medium text-gray-700 mb-1">រយៈពេល</label>
                    <div class="relative">
                        <input
                            type="text"
                            id="edit-duration-search"
                            placeholder="វាយ ឬ ជ្រើសរើសរយៈពេល..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            autocomplete="off"
                        >
                        <div
                            id="edit-duration-dropdown"
                            class="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden custom-dropdown"
                        ></div>
                    </div>
                </div>

                <!-- Single Date -->
                <div id="edit-single-date-container" class="hidden">
                    <label for="edit-date-single" class="block text-sm font-medium text-gray-700 mb-1">កាលបរិច្ឆេទ</label>
                    <input
                        type="date"
                        id="edit-date-single"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>

                <!-- Date Range -->
                <div id="edit-date-range-container" class="hidden space-y-4">
                    <div>
                        <label for="edit-date-start" class="block text-sm font-medium text-gray-700 mb-1">ចាប់ពីថ្ងៃ</label>
                        <input
                            type="date"
                            id="edit-date-start"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>
                    <div>
                        <label for="edit-date-end" class="block text-sm font-medium text-gray-700 mb-1">ដល់ថ្ងៃ</label>
                        <input
                            type="date"
                            id="edit-date-end"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>
                </div>

                <!-- Reason -->
                <div>
                    <label for="edit-reason-search" class="block text-sm font-medium text-gray-700 mb-1">មូលហេតុ</Tlabel>
                    <div class="relative">
                        <input
                            type="text"
                            id="edit-reason-search"
                            placeholder="វាយ ឬ ជ្រើសរើសមូលហេតុ..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            autocomplete="off"
                        >
                        <div
                            id="edit-reason-dropdown"
                            class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden custom-dropdown"
                        ></div>
                    </div>
                </div>
                
                <p id="edit-request-error" class="text-red-500 text-sm hidden"></p>

                <!-- Action Buttons -->
                <div class="flex items-center justify-end space-x-3 pt-4">
                    <button id="cancel-edit-btn" type="button" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300">
                        បោះបង់
                    </button>
                    <button id="save-edit-btn" type="button" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 disabled:opacity-50">
                        រក្សាទុកការកែប្រែ
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ===== Delete Confirm Modal ===== -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-6 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">បញ្ជាក់ការលុប</h3>
            <p id="delete-confirm-text" class="text-gray-600 mb-6">តើអ្នកប្រាកដទេ ថាចង់លុប?</p>
            <div class="flex items-center justify-end space-x-3">
                <button id="cancel-delete-btn" type="button" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300">
                    បោះបង់
                </button>
                <button id="confirm-delete-btn" type="button" class="bg-red-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-red-700 disabled:opacity-50">
                    យល់ព្រមលុប
                </button>
            </div>
        </div>
    </div>

</body>
</html>

