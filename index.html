<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីសុំច្បាប់ - ឧស្សាហកម្មឌីជីថល</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Khmer -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc,
            updateDoc, // Import updateDoc for editing
            deleteDoc, // Import deleteDoc for deleting
            collection, 
            query, 
            where, 
            onSnapshot, 
            serverTimestamp,
            Timestamp, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable Firestore debug logging
        setLogLevel('debug'); 

        // --- Hard-coded Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDjr_Ha2RxOWEumjEeSdluIW3JmyM76mVk",
            authDomain: "dipermisstion.firebaseapp.com",
            projectId: "dipermisstion",
            storageBucket: "dipermisstion.firebasestorage.app",
            messagingSenderId: "512999406057",
            appId: "1:512999406057:web:953a281ab9dde7a9a0f378",
            measurementId: "G-KDPHXZ7H4B"
        };
        // --- End of Hard-coded Config ---

        // --- Global State & Element References ---
        let db, auth, userId;
        let historyUnsubscribe = null; 
        let allUsersData = []; 
        let currentUser = null; 
        let selectedUserId = null; 
        let faceScanInterval = null; 
        let currentHistoryFilter = { month: null, year: null, type: 'leave' }; // NEW: Filter state

        // --- Google Sheet Config ---
        const SHEET_ID = '1_Kgl8UQXRsVATt_BOHYQjVWYKkRIBA12R-qnsBoSUzc';
        const SHEET_NAME = 'បញ្ជឺឈ្មោះរួម';
        const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tq=${encodeURIComponent('SELECT E, L, AA, N, G, S WHERE E IS NOT NULL OFFSET 0')}`;

        // --- Telegram Config ---
        const BOT_TOKEN = '8284240201:AAEDRGHDcuoQAhkWk7km6I-9csZNbReOPHw';
        const CHAT_ID = '1487065922';
        
        // --- Firestore Collection Path ---
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const leaveRequestsCollectionPath = `/artifacts/${canvasAppId}/public/data/leave_requests`;

        // --- Element References ---
        let userSearchInput, userDropdown, scanFaceBtn, modelStatusEl, 
            faceScanModal, video, scanStatusEl, scanDebugEl, cancelScanBtn, 
            loginFormContainer, inAppWarning, dataLoadingIndicator, rememberMeCheckbox, 
            mainAppContainer, homeUserName, loginPage, bottomNav, 
            userPhotoEl, userNameEl, userIdEl, userGenderEl, userGroupEl, userDepartmentEl, 
            logoutBtn, navButtons, pages, mainContent, 
            requestLeavePage, openLeaveRequestBtn, cancelLeaveRequestBtn, submitLeaveRequestBtn, 
            durationSearchInput, durationDropdownEl, singleDateContainer, dateRangeContainer, 
            singleDateInput, startDateInput, endDateInput, requestErrorEl, requestLoadingEl, 
            historyContainer, historyPlaceholder,
            reasonSearchInput, reasonDropdownEl, selectedDuration, selectedReason,
            criticalErrorDisplay,
            // NEW: History Filter Elements
            historyTabLeave, historyTabOut, historyContentLeave, historyContentOut,
            monthFilterSelect, yearFilterSelect,
            // NEW: Edit Modal Elements
            editModal, editRequestId, editDurationSearch, editDurationDropdown,
            editReasonSearch, editReasonDropdown, editSingleDateContainer, editDateRangeContainer,
            editSingleDateInput, editStartDateInput, editEndDateInput,
            cancelEditBtn, saveEditBtn, editLoadingEl, editErrorEl,
            // NEW: Delete Modal Elements
            deleteModal, deleteConfirmText, deleteConfirmBtn, deleteCancelBtn, deleteLoadingEl;

        // --- Lists for Dropdowns ---
        const durations = [
            "មួយព្រឹក", "មួយរសៀល", "មួយយប់", "មួយថ្ងៃ", "មួយថ្ងៃកន្លះ", "ពីរថ្ងៃ", "ពីរថ្ងៃកន្លះ",
            "បីថ្ងៃ", "បីថ្ងៃកន្លះ", "បួនថ្ងៃ", "បួនថ្ងៃកន្លះ", "ប្រាំថ្ងៃ", "ប្រាំថ្ងៃកន្លះ",
            "ប្រាំមួយថ្ងៃ", "ប្រាំមួយថ្ងៃកន្លះ", "ប្រាំពីរថ្ងៃ"
        ];
        const durationItems = durations.map(d => ({ text: d, value: d }));
        
        const reasons = ["ឈឺក្បាល", "ចុកពោះ", "គ្រុនក្ដៅ", "ផ្ដាសាយ"];
        const reasonItems = reasons.map(r => ({ text: r, value: r }));

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // --- Assign Element References ---
            userSearchInput = document.getElementById('user-search');
            userDropdown = document.getElementById('user-dropdown');
            scanFaceBtn = document.getElementById('scan-face-btn');
            modelStatusEl = document.getElementById('model-status');
            faceScanModal = document.getElementById('face-scan-modal');
            video = document.getElementById('video');
            scanStatusEl = document.getElementById('scan-status');
            scanDebugEl = document.getElementById('scan-debug');
            cancelScanBtn = document.getElementById('cancel-scan-btn');
            loginFormContainer = document.getElementById('login-form-container');
            inAppWarning = document.getElementById('in-app-warning');
            dataLoadingIndicator = document.getElementById('data-loading-indicator');
            rememberMeCheckbox = document.getElementById('remember-me');
            mainAppContainer = document.getElementById('main-app-container');
            homeUserName = document.getElementById('home-user-name');
            loginPage = document.getElementById('page-login');
            bottomNav = document.getElementById('bottom-navigation');
            userPhotoEl = document.getElementById('user-photo');
            userNameEl = document.getElementById('user-name');
            userIdEl = document.getElementById('user-id');
            userGenderEl = document.getElementById('user-gender');
            userGroupEl = document.getElementById('user-group');
            userDepartmentEl = document.getElementById('user-department');
            logoutBtn = document.getElementById('logout-btn');
            navButtons = document.querySelectorAll('.nav-btn');
            pages = ['page-home', 'page-history', 'page-account', 'page-help', 'page-request-leave'];
            mainContent = document.getElementById('main-content');
            requestLeavePage = document.getElementById('page-request-leave');
            openLeaveRequestBtn = document.getElementById('open-leave-request-btn');
            cancelLeaveRequestBtn = document.getElementById('cancel-leave-request-btn');
            submitLeaveRequestBtn = document.getElementById('submit-leave-request-btn');
            durationSearchInput = document.getElementById('duration-search');
            durationDropdownEl = document.getElementById('duration-dropdown');
            singleDateContainer = document.getElementById('single-date-container');
            dateRangeContainer = document.getElementById('date-range-container');
            singleDateInput = document.getElementById('leave-date-single');
            startDateInput = document.getElementById('leave-date-start');
            endDateInput = document.getElementById('leave-date-end');
            requestErrorEl = document.getElementById('request-error');
            requestLoadingEl = document.getElementById('request-loading');
            historyContainer = document.getElementById('history-container');
            historyPlaceholder = document.getElementById('history-placeholder');
            reasonSearchInput = document.getElementById('reason-search');
            reasonDropdownEl = document.getElementById('reason-dropdown');
            criticalErrorDisplay = document.getElementById('critical-error-display');
            
            // NEW: History Filter Elements
            historyTabLeave = document.getElementById('history-tab-leave');
            historyTabOut = document.getElementById('history-tab-out');
            historyContentLeave = document.getElementById('history-content-leave');
            historyContentOut = document.getElementById('history-content-out');
            monthFilterSelect = document.getElementById('month-filter');
            yearFilterSelect = document.getElementById('year-filter');

            // NEW: Edit Modal Elements
            editModal = document.getElementById('edit-request-modal');
            editRequestId = document.getElementById('edit-request-id');
            editDurationSearch = document.getElementById('edit-duration-search');
            editDurationDropdown = document.getElementById('edit-duration-dropdown');
            editReasonSearch = document.getElementById('edit-reason-search');
            editReasonDropdown = document.getElementById('edit-reason-dropdown');
            editSingleDateContainer = document.getElementById('edit-single-date-container');
            editDateRangeContainer = document.getElementById('edit-date-range-container');
            editSingleDateInput = document.getElementById('edit-leave-date-single');
            editStartDateInput = document.getElementById('edit-leave-date-start');
            editEndDateInput = document.getElementById('edit-leave-date-end');
            cancelEditBtn = document.getElementById('cancel-edit-btn');
            saveEditBtn = document.getElementById('save-edit-btn');
            editLoadingEl = document.getElementById('edit-loading');
            editErrorEl = document.getElementById('edit-error');
            
            // NEW: Delete Modal Elements
            deleteModal = document.getElementById('delete-confirm-modal');
            deleteConfirmText = document.getElementById('delete-confirm-text');
            deleteConfirmBtn = document.getElementById('delete-confirm-btn');
            deleteCancelBtn = document.getElementById('delete-cancel-btn');
            deleteLoadingEl = document.getElementById('delete-loading');


            // --- Firebase Initialization ---
            try {
                // Use the hard-coded config
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                console.log("Using Firestore Path:", leaveRequestsCollectionPath);

                // --- Firebase Authentication ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Firebase Auth state changed. User is authenticated (Anonymous). UID:", user.uid);
                        userId = user.uid; // Set global userId (Firebase Auth UID)

                        const rememberedUser = localStorage.getItem('leaveAppUser');
                        if (rememberedUser) {
                            try {
                                const parsedUser = JSON.parse(rememberedUser);
                                if (parsedUser && parsedUser.id) { 
                                    console.log("Found remembered user:", parsedUser.id);
                                    currentUser = parsedUser; 
                                    showLoggedInState(parsedUser); 
                                    fetchUsers(); // Fetch in background for any updates
                                    return; 
                                } else {
                                    throw new Error("ទិន្នន័យអ្នកប្រើប្រាស់ក្នុង localStorage មិនត្រឹមត្រូវ");
                                }
                            } catch (e) {
                                console.error('បរាជ័យក្នុងការអានទិន្នន័យអ្នកប្រើប្រាស់:', e);
                                localStorage.removeItem('leaveAppUser'); 
                            }
                        }
                        console.log("No remembered user found, starting normal app flow.");
                        initializeAppFlow();
                    } else {
                        console.log("Firebase Auth: No user signed in. Attempting anonymous sign-in...");
                        signInAnonymously(auth).catch(anonError => {
                             console.error("Error during automatic anonymous sign-in attempt:", anonError);
                             if (criticalErrorDisplay) {
                                 criticalErrorDisplay.classList.remove('hidden');
                                 criticalErrorDisplay.textContent = `Critical Error: មិនអាច Sign In បានទេ។ ${anonError.message}។ សូម Refresh ម្ដងទៀត។`;
                             }
                        });
                    }
                });

                // --- Initial Anonymous Sign-In ---
                try {
                    console.log("Attempting initial Anonymous Sign-In...");
                    await signInAnonymously(auth);
                    console.log("Firebase Auth: Initial Anonymous Sign-In successful (or already signed in).");
                } catch (anonError) {
                    console.error("Initial Anonymous Sign-In Error:", anonError);
                    if (anonError.code === 'auth/operation-not-allowed') {
                        throw new Error("សូមបើក 'Anonymous' sign-in នៅក្នុង Firebase Console (Authentication > Sign-in method)។");
                    }
                    throw new Error(`Firebase Sign-In Error: ${anonError.message}`);
                }

            } catch (e) {
                console.error("Firebase Initialization/Auth Error:", e);
                if(criticalErrorDisplay) {
                    criticalErrorDisplay.classList.remove('hidden');
                    criticalErrorDisplay.textContent = `Critical Error: មិនអាចតភ្ជាប់ Firebase បានទេ។ ${e.message}។ សូម Refresh ម្ដងទៀត។`;
                }
                if(loginPage) loginPage.classList.add('hidden'); 
            }

            // --- Main App Logic ---
            function initializeAppFlow() {
                console.log("initializeAppFlow called.");
                function isClient() {
                    const ua = navigator.userAgent || navigator.vendor || window.opera;
                    return (
                        (ua.indexOf('FBAN') > -1) || (ua.indexOf('FBAV') > -1) ||
                        (ua.indexOf('Twitter') > -1) || (ua.indexOf('Telegram') > -1) ||
                        (ua.indexOf('WebView') > -1) || (ua.indexOf('wv') > -1)
                    );
                }

                if (isClient()) {
                    console.log("Detected In-App Browser.");
                    if (inAppWarning) inAppWarning.classList.remove('hidden');
                    if (modelStatusEl) modelStatusEl.textContent = 'សូមបើកក្នុង Browser ពេញលេញ';
                    if (dataLoadingIndicator) dataLoadingIndicator.classList.add('hidden');
                } else {
                    console.log("Detected Full Browser.");
                    if (inAppWarning) inAppWarning.classList.add('hidden');
                    if (dataLoadingIndicator) dataLoadingIndicator.classList.remove('hidden');
                    
                    fetchUsers();
                    
                    if (typeof faceapi !== 'undefined') {
                        if (scanFaceBtn) scanFaceBtn.disabled = true; 
                        loadFaceApiModels();
                    } else {
                        console.error("Face-API.js មិនអាចទាញយកបានត្រឹមត្រូវទេ។");
                        if (modelStatusEl) modelStatusEl.textContent = 'Error: មិនអាចទាញយក Library ស្កេនមុខបាន';
                    }
                }
            }
            
            // --- Google Sheet Data Fetching ---
            async function fetchUsers() {
                console.log("Fetching users from Google Sheet...");
                try {
                    const response = await fetch(GVIZ_URL);
                    if (!response.ok) {
                        throw new Error(`Google Sheet fetch failed with status: ${response.status}`);
                    }
                    const text = await response.text();
                    const match = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/s);
                     if (!match || !match[1]) {
                        throw new Error("ទម្រង់ការឆ្លើយតបពី Google Sheet មិនត្រឹមត្រូវ");
                    }
                    const json = JSON.parse(match[1]);
                    
                    if (json.table && json.table.rows && json.table.rows.length > 0) {
                        allUsersData = json.table.rows.map(row => ({
                            id: row.c && row.c[0] ? row.c[0].v : null,
                            name: row.c && row.c[1] ? row.c[1].v : null,
                            photo: row.c && row.c[2] ? row.c[2].v : null,
                            gender: row.c && row.c[3] ? row.c[3].v : null,
                            group: row.c && row.c[4] ? row.c[4].v : null,
                            department: row.c && row.c[5] ? row.c[5].v : null,
                        })).filter(user => user.id && user.name); 
                        
                        console.log(`Fetched ${allUsersData.length} valid users.`);
                        populateUserDropdown(allUsersData, 'user-search', 'user-dropdown', (id) => {
                            selectedUserId = id;
                            if (scanFaceBtn) scanFaceBtn.disabled = (id === null || !modelStatusEl || modelStatusEl.textContent !== 'Model ស្កេនមុខបានទាញយករួចរាល់');
                            console.log("Selected User ID:", selectedUserId);
                        });
                        
                        if (dataLoadingIndicator) dataLoadingIndicator.classList.add('hidden');
                        if (loginFormContainer) loginFormContainer.classList.remove('hidden');

                    } else {
                        console.error("រកមិនឃើញទិន្នន័យអ្នកប្រើប្រាស់ក្នុង Google Sheet ទេ។");
                        throw new Error("រកមិនឃើញទិន្នន័យអ្នកប្រើប្រាស់");
                    }
                } catch (error) {
                    console.error("Error ពេលទាញយកទិន្នន័យ Google Sheet:", error);
                    if (dataLoadingIndicator) {
                        dataLoadingIndicator.innerHTML = `<p class="text-red-600 font-semibold">Error: មិនអាចទាញយកទិន្នន័យបាន</p><p class="text-gray-600 text-sm mt-1">សូមពិនិត្យអ៊ីនធឺណិត និង Refresh ម្ដងទៀត។</p>`;
                        dataLoadingIndicator.classList.remove('hidden'); 
                    }
                }
            }

            // --- Reusable Searchable Dropdown Logic ---
            let getSelectedDuration, getSelectedReason, getSelectedEditDuration, getSelectedEditReason;

            function setupSearchableDropdown(inputId, dropdownId, items, onSelectCallback, allowCustom = false) {
                const searchInput = document.getElementById(inputId);
                const dropdown = document.getElementById(dropdownId);
                
                if (!searchInput || !dropdown) {
                     console.error(`Dropdown elements not found: inputId=${inputId}, dropdownId=${dropdownId}`);
                     return () => null; // Return a function that returns null
                 }

                let currentSelection = null; 

                function populateDropdown(filter = '') {
                    dropdown.innerHTML = '';
                    const filteredItems = items.filter(item => item.text && item.text.toLowerCase().includes(filter.toLowerCase()));
                    
                    if (filteredItems.length === 0 && !allowCustom) {
                         dropdown.classList.add('hidden');
                         return;
                    }
                     
                    if (filteredItems.length === 0 && allowCustom && filter.trim() !== '') {
                        const itemEl = document.createElement('div');
                        itemEl.textContent = `"${filter}" (Custom)`;
                        itemEl.dataset.value = filter;
                        itemEl.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm italic';
                         itemEl.addEventListener('mousedown', (e) => {
                            e.preventDefault(); 
                            searchInput.value = filter;
                            currentSelection = filter;
                            dropdown.classList.add('hidden');
                            if (onSelectCallback) onSelectCallback(filter);
                            console.log(`Selected custom item: ${filter}`);
                        });
                        dropdown.appendChild(itemEl);
                    }

                    filteredItems.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.textContent = item.text;
                        itemEl.dataset.value = item.value;
                        itemEl.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                        
                        itemEl.addEventListener('mousedown', (e) => {
                            e.preventDefault(); 
                            searchInput.value = item.text;
                            currentSelection = item.value; 
                            dropdown.classList.add('hidden');
                            if (onSelectCallback) onSelectCallback(item.value);
                            console.log(`Selected dropdown item: ${item.text} (value: ${item.value})`);
                        });
                        dropdown.appendChild(itemEl);
                    });
                    dropdown.classList.remove('hidden');
                }

                searchInput.addEventListener('input', () => {
                    const currentValue = searchInput.value;
                    populateDropdown(currentValue);
                    
                    const validItem = items.find(item => item.text === currentValue);
                    if (validItem) {
                        currentSelection = validItem.value;
                        if (onSelectCallback) onSelectCallback(validItem.value);
                    } else if (allowCustom) {
                        currentSelection = currentValue; 
                        if (onSelectCallback) onSelectCallback(currentValue);
                    } else {
                        currentSelection = null; 
                        if (onSelectCallback) onSelectCallback(null);
                    }
                });

                searchInput.addEventListener('focus', () => {
                     console.log(`Focus on ${inputId}`);
                     populateDropdown(searchInput.value);
                });

                searchInput.addEventListener('blur', () => {
                     console.log(`Blur on ${inputId}`);
                    setTimeout(() => {
                        dropdown.classList.add('hidden');
                        
                        const currentValue = searchInput.value;
                        const validItem = items.find(item => item.text === currentValue);
                        
                        if (validItem) {
                            currentSelection = validItem.value;
                            if (onSelectCallback) onSelectCallback(validItem.value);
                        } else if (allowCustom && currentValue.trim() !== '') {
                            currentSelection = currentValue;
                            if (onSelectCallback) onSelectCallback(currentValue);
                        } else {
                            currentSelection = null;
                            if (onSelectCallback) onSelectCallback(null);
                            
                            if (!allowCustom) {
                                console.log(`Invalid selection on ${inputId}: ${currentValue}. Clearing.`);
                                searchInput.value = ''; 
                            }
                        }
                    }, 150);
                });
                
                // NEW: Add a function to set the value programmatically
                searchInput.setValue = (newValue) => {
                    const validItem = items.find(item => item.value === newValue);
                    if (validItem) {
                        searchInput.value = validItem.text;
                        currentSelection = validItem.value;
                        if (onSelectCallback) onSelectCallback(validItem.value);
                    } else if (allowCustom) {
                        searchInput.value = newValue;
                        currentSelection = newValue;
                        if (onSelectCallback) onSelectCallback(newValue);
                    } else {
                         searchInput.value = '';
                         currentSelection = null;
                         if (onSelectCallback) onSelectCallback(null);
                    }
                };

                return () => currentSelection;
            }


            function populateUserDropdown(users, inputId, dropdownId, onSelectCallback) {
                const userItems = users
                    .filter(user => user.id && user.name)
                    .map(user => ({ text: `${user.id} - ${user.name}`, value: user.id }));
                setupSearchableDropdown(inputId, dropdownId, userItems, onSelectCallback, false);
            }

            // --- Face Scan Logic ---
            async function loadFaceApiModels() {
                if (!modelStatusEl) return;
                try {
                    console.log("Loading face-api models...");
                    modelStatusEl.textContent = 'កំពុងទាញយក Model ស្កេនមុខ...';
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                        faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                        faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'),
                    ]);
                    modelStatusEl.textContent = 'Model ស្កេនមុខបានទាញយករួចរាល់';
                    console.log("Face-api models loaded successfully.");
                    if (scanFaceBtn) scanFaceBtn.disabled = (selectedUserId === null); 

                } catch (error) {
                    console.error("Error ពេលទាញយក Model របស់ face-api:", error);
                    modelStatusEl.textContent = 'Error: មិនអាចទាញយក Model បាន';
                }
            }


            async function startFaceScan() {
                console.log("startFaceScan called.");
                if (!selectedUserId) {
                    alert("សូមជ្រើសរើសអត្តលេខរបស់អ្នកជាមុនសិន");
                    return;
                }
                
                const user = allUsersData.find(u => u.id === selectedUserId);
                if (!user || !user.photo) {
                    alert("Error: មិនអាចទាញយករូបថតយោងរបស់អ្នកបានទេ។ សូមទាក់ទង IT Support។");
                    return;
                }
                console.log("Starting face scan for user:", user.id);

                if (faceScanModal) faceScanModal.classList.remove('hidden');
                if (scanStatusEl) scanStatusEl.textContent = 'កំពុងព្យាយាមបើកកាមេរ៉ា...';

                try {
                    // 1. Fetch and process reference image
                    console.log("Fetching reference image from:", user.photo);
                    if (scanStatusEl) scanStatusEl.textContent = 'កំពុងទាញយករូបថតយោង...';
                    let referenceImage;
                    try {
                        const img = new Image();
                        img.crossOrigin = 'anonymous'; 
                        img.src = user.photo;
                        await new Promise((resolve, reject) => {
                            img.onload = () => { console.log("Reference image loaded."); resolve(); };
                            img.onerror = (err) => { 
                                console.error("Error loading reference image:", err);
                                reject(new Error('Failed to fetch (មិនអាចទាញយករូបថតយោងបាន)។ សូមប្រាកដថា Link រូបថតត្រឹមត្រូវ និងអាចចូលមើលបាន។')); 
                            };
                        });
                        referenceImage = img;
                    } catch (fetchError) {
                        console.error('Fetch image error during face scan:', fetchError);
                        throw fetchError; 
                    }
                    
                    // 2. Compute reference descriptor
                    console.log("Computing reference face descriptor...");
                    if (scanStatusEl) scanStatusEl.textContent = 'កំពុងវិភាគរូបថតយោង...';
                     let referenceDescriptor;
                     try {
                        const referenceDetection = await faceapi.detectSingleFace(referenceImage).withFaceLandmarks(true).withFaceDescriptor();
                        if (!referenceDetection) {
                            throw new Error('រកមិនឃើញមុខនៅក្នុងរូបថតយោង');
                        }
                        referenceDescriptor = referenceDetection.descriptor;
                        console.log("Reference descriptor computed.");
                    } catch (descriptorError) {
                         console.error("Error computing reference descriptor:", descriptorError);
                         throw new Error('មិនអាចវិភាគមុខពីរូបថតយោងបានទេ (រូបថតអាចមិនច្បាស់ ឬ Link មិនត្រឹមត្រូវ)។');
                     }

                    // 3. Start video stream
                    console.log("Requesting camera access...");
                    if (scanStatusEl) scanStatusEl.textContent = 'កំពុងស្នើសុំបើកកាមេរ៉ា...';
                    const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                    if (video) video.srcObject = stream;
                    console.log("Camera stream started.");
                    if (scanStatusEl) scanStatusEl.textContent = 'សូមដាក់មុខរបស់អ្នកឲ្យចំកាមេរ៉ា';

                    // 4. Start detection interval
                    console.log("Starting face detection interval.");
                    if (faceScanInterval) clearInterval(faceScanInterval);
                    faceScanInterval = setInterval(async () => {
                        if (!video || video.readyState < 3) return; 

                        const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true).withFaceDescriptor();
                        
                        if (detections) {
                            if (scanStatusEl) scanStatusEl.textContent = 'រកឃើញផ្ទៃមុខ! កំពុងផ្ទៀងផ្ទាត់...';
                            const distance = faceapi.euclideanDistance(referenceDescriptor, detections.descriptor);
                            const similarity = (1 - distance).toFixed(2);
                            const threshold = 0.55; 
                            if (scanDebugEl) scanDebugEl.textContent = `ភាពស្រដៀងគ្នា: ${similarity} (ត្រូវ > ${1-threshold})`;

                            if (distance < threshold) { 
                                console.log("Face verification successful!", `Distance: ${distance}`);
                                if (scanStatusEl) scanStatusEl.textContent = 'ផ្ទៀងផ្ទាត់ជោគជ័យ!';
                                stopFaceScan(); 
                                loginUser(selectedUserId); 
                                
                                setTimeout(() => {
                                    if (faceScanModal) faceScanModal.classList.add('hidden');
                                }, 1000);
                            } else {
                                if (scanStatusEl) scanStatusEl.textContent = 'មុខមិនត្រឹមត្រូវ... សូមព្យាយាមម្តងទៀត';
                            }
                        } else {
                            if (scanStatusEl) scanStatusEl.textContent = 'រកមិនឃើញផ្ទៃមុខ...';
                            if (scanDebugEl) scanDebugEl.textContent = '';
                        }
                    }, 500);

                } catch (error) {
                    console.error("Error during face scan process:", error);
                    if (scanStatusEl) scanStatusEl.textContent = `Error: ${error.message}`;
                    stopFaceScan();
                     setTimeout(() => { 
                         if (faceScanModal) faceScanModal.classList.add('hidden');
                         alert(`មានបញ្ហាពេលស្កេនមុខ៖\n${error.message}\nសូមប្រាកដថាអ្នកបានអនុញ្ញាតឲ្យប្រើកាមេរ៉ា។`);
                     }, 1500); 
                }
            }


            function stopFaceScan() {
                console.log("Stopping face scan.");
                if (faceScanInterval) {
                    clearInterval(faceScanInterval);
                    faceScanInterval = null;
                }
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                    console.log("Camera stream stopped.");
                 } else {
                     console.log("No active camera stream to stop.");
                 }
            }


            if (scanFaceBtn) scanFaceBtn.addEventListener('click', startFaceScan);
            if (cancelScanBtn) cancelScanBtn.addEventListener('click', () => {
                console.log("Cancel scan button clicked.");
                stopFaceScan();
                if (faceScanModal) faceScanModal.classList.add('hidden');
            });

            // --- App Navigation & State Logic ---
            function loginUser(userIdToLogin) {
                console.log("Logging in user ID:", userIdToLogin);
                const user = allUsersData.find(u => u.id === userIdToLogin);
                 if (!user) {
                     console.error("User data not found for login:", userIdToLogin);
                     alert("មានបញ្ហា Login: រកមិនឃើញទិន្នន័យអ្នកប្រើប្រាស់");
                     return;
                 }

                if (rememberMeCheckbox && rememberMeCheckbox.checked) {
                    console.log("Remembering user.");
                    localStorage.setItem('leaveAppUser', JSON.stringify(user));
                } else {
                    console.log("Not remembering user.");
                    localStorage.removeItem('leaveAppUser');
                }
                
                showLoggedInState(user);
            }
            

            function logout() {
                console.log("Logging out user.");
                currentUser = null;
                localStorage.removeItem('leaveAppUser'); 

                if (loginPage) loginPage.classList.remove('hidden');
                if (mainAppContainer) mainAppContainer.classList.add('hidden');
                
                if (userPhotoEl) userPhotoEl.src = 'https://placehold.co/100x100/e2e8f0/64748b?text=User';
                if (userNameEl) userNameEl.textContent = '...';
                if (userIdEl) userIdEl.textContent = '...';
                if (userGenderEl) userGenderEl.textContent = '...';
                if (userGroupEl) userGroupEl.textContent = '...';
                if (userDepartmentEl) userDepartmentEl.textContent = '...';
                
                if (userSearchInput) userSearchInput.value = '';
                selectedUserId = null;
                if (scanFaceBtn) scanFaceBtn.disabled = true;
                if (rememberMeCheckbox) rememberMeCheckbox.checked = false;

                if (historyUnsubscribe) {
                    console.log("Unsubscribing from history listener.");
                    historyUnsubscribe();
                    historyUnsubscribe = null;
                }
                
                // Don't sign out from anonymous auth, just clear state
            }
            
            function showLoggedInState(user) {
                console.log("Showing logged-in state for:", user.id);
                currentUser = user;
                populateAccountPage(user);
                
                if (homeUserName) homeUserName.textContent = user.name || '...';

                if (loginPage) loginPage.classList.add('hidden');
                if (mainAppContainer) mainAppContainer.classList.remove('hidden');
                if (criticalErrorDisplay) criticalErrorDisplay.classList.add('hidden');

                navigateTo('page-home');
                
                // NEW: Setup history filter and listener
                setupHistoryFilters();
                setupHistoryListener(user.id, currentHistoryFilter.month, currentHistoryFilter.year);
            }
            
            function populateAccountPage(user) {
                if (!user) return;
                 console.log("Populating account page for:", user.id);
                if (userPhotoEl && user.photo) {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.src = user.photo;
                    img.onload = () => {
                        userPhotoEl.src = img.src;
                    };
                    img.onerror = () => { 
                        console.warn("Could not load user photo from:", user.photo);
                        userPhotoEl.src = 'https://placehold.co/100x100/e2e8f0/64748b?text=គ្មានរូប';
                    };
                } else if (userPhotoEl) {
                    userPhotoEl.src = 'https://placehold.co/100x100/e2e8f0/64748b?text=User';
                }
                
                if (userNameEl) userNameEl.textContent = user.name || 'មិនមាន';
                if (userIdEl) userIdEl.textContent = user.id || 'មិនមាន';
                if (userGenderEl) userGenderEl.textContent = user.gender || 'មិនមាន';
                if (userGroupEl) userGroupEl.textContent = user.group || 'មិនមាន';
                if (userDepartmentEl) userDepartmentEl.textContent = user.department || 'មិនមាន';
            }
            

            if (logoutBtn) logoutBtn.addEventListener('click', logout);
            
            // --- Bottom Navigation Logic ---
            function navigateTo(pageId) {
                console.log("Navigating to page:", pageId);
                pages.forEach(page => {
                    const pageEl = document.getElementById(page);
                    if (pageEl) {
                        pageEl.classList.add('hidden');
                    } else {
                         console.warn(`Page element not found: ${page}`);
                     }
                });
                
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                } else {
                     console.error(`Target page element not found: ${pageId}`);
                     const homePage = document.getElementById('page-home');
                     if(homePage) homePage.classList.remove('hidden');
                     return;
                 }

                if (bottomNav) {
                    if (pageId === 'page-request-leave') {
                        bottomNav.classList.add('hidden');
                    } else {
                        bottomNav.classList.remove('hidden');
                    }
                }
                
                if (navButtons) {
                    navButtons.forEach(btn => {
                        if (btn.dataset.page === pageId) {
                            btn.classList.add('text-blue-600');
                            btn.classList.remove('text-gray-500');
                        } else {
                            btn.classList.add('text-gray-500');
                            btn.classList.remove('text-blue-600');
                        }
                    });
                } else {
                     console.warn("Navigation buttons not found.");
                 }
                
                if (mainContent) {
                    mainContent.scrollTop = 0;
                }
            }

            if (navButtons) {
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const pageToNavigate = button.dataset.page;
                         if (pageToNavigate) {
                             navigateTo(pageToNavigate);
                         } else {
                             console.warn("Nav button clicked without data-page attribute.");
                         }
                    });
                });
            } else {
                 console.warn("Navigation buttons not found during event listener setup.");
             }

            // --- Leave Request Logic ---
            const durationToDaysMap = {
                "មួយព្រឹក": 1, "មួយរសៀល": 1, "មួយយប់": 1, "មួយថ្ងៃ": 1,
                "មួយថ្ងៃកន្លះ": 1.5, "ពីរថ្ងៃ": 2, "ពីរថ្ងៃកន្លះ": 2.5,
                "បីថ្ងៃ": 3, "បីថ្ងៃកន្លះ": 3.5, "បួនថ្ងៃ": 4, "បួនថ្ងៃកន្លះ": 4.5,
                "ប្រាំថ្ងៃ": 5, "ប្រាំថ្ងៃកន្លះ": 5.5, "ប្រាំមួយថ្ងៃ": 6, "ប្រាំមួយថ្ងៃកន្លះ": 6.5,
                "ប្រាំពីរថ្ងៃ": 7
            };
            const singleDayDurations = ["មួយព្រឹក", "មួយរសៀល", "មួយយប់", "មួយថ្ងៃ"];

            // --- Date Formatting Helpers ---
            function getTodayString() {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`; // ISO format (YYYY-MM-DD)
            }

            function formatToMDY(isoDate) {
                if (!isoDate || isoDate.split('-').length < 3) return "N/A";
                try {
                    // Handle potential invalid date strings from input
                    const [yyyy, mm, dd] = isoDate.split('-');
                    if (!yyyy || !mm || !dd) return "N/A";
                    return `${mm}/${dd}/${yyyy}`;
                } catch (e) {
                    console.warn("Could not format date:", isoDate);
                    return "N/A";
                }
            }
            
            function formatTimestampToLocalTime(timestamp) {
                if (!timestamp || typeof timestamp.toDate !== 'function') {
                    return null; 
                }
                try {
                    const date = timestamp.toDate();
                    let hours = date.getHours();
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const ampm = hours >= 12 ? 'រសៀល' : 'ព្រឹក';
                    hours = hours % 12;
                    hours = hours ? hours : 12; 
                    return `${hours}:${minutes} ${ampm}`;
                } catch (e) {
                    console.error("Error formatting timestamp:", e);
                    return null;
                }
            }


            function addDays(dateString, days) {
                try {
                     const date = new Date(dateString);
                     if (isNaN(date.getTime())) {
                         console.error("Invalid start date provided to addDays:", dateString);
                         return getTodayString(); 
                     }
                    date.setDate(date.getDate() + Math.ceil(days) - 1); 
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                } catch (e) {
                     console.error("Error in addDays function:", e);
                     return getTodayString();
                 }
            }


            function updateDateFields(duration, inputPrefix = '') {
                console.log(`Duration selected (${inputPrefix}):`, duration);
                
                const today = getTodayString();
                const singleContainer = document.getElementById(`${inputPrefix}single-date-container`);
                const rangeContainer = document.getElementById(`${inputPrefix}date-range-container`);
                const singleInput = document.getElementById(`${inputPrefix}leave-date-single`);
                const startInput = document.getElementById(`${inputPrefix}leave-date-start`);
                const endInput = document.getElementById(`${inputPrefix}leave-date-end`);

                 if (!singleContainer || !rangeContainer || !singleInput || !startInput || !endInput) {
                    console.error("Date input elements not found in updateDateFields for prefix:", inputPrefix);
                    return;
                }

                if (!duration || !durations.includes(duration)) { 
                    singleContainer.classList.add('hidden');
                    rangeContainer.classList.add('hidden');
                    return;
                }

                if (singleDayDurations.includes(duration)) {
                    singleContainer.classList.remove('hidden');
                    rangeContainer.classList.add('hidden');
                    singleInput.value = today;
                    console.log("Set single date to:", today);
                } else {
                    singleContainer.classList.add('hidden');
                    rangeContainer.classList.remove('hidden');
                    startInput.value = today;
                    const days = durationToDaysMap[duration] || 0;
                    const endDateValue = addDays(today, days);
                    endInput.value = endDateValue;
                    endInput.min = today; 
                    console.log(`Set date range: ${today} to ${endDateValue}`);
                }
            }


            // Setup the duration dropdown (Stricter)
            getSelectedDuration = setupSearchableDropdown('duration-search', 'duration-dropdown', durationItems, (duration) => {
                selectedDuration = duration;
                updateDateFields(duration, '');
            }, false); 
            
            // Setup the reason dropdown (Flexible)
            getSelectedReason = setupSearchableDropdown('reason-search', 'reason-dropdown', reasonItems, (reason) => {
                 selectedReason = reason;
                 console.log("Reason changed:", reason);
            }, true); 
            
            // NEW: Setup Edit Modal Dropdowns
            getSelectedEditDuration = setupSearchableDropdown('edit-duration-search', 'edit-duration-dropdown', durationItems, (duration) => {
                updateDateFields(duration, 'edit-');
            }, false);
            
            getSelectedEditReason = setupSearchableDropdown('edit-reason-search', 'edit-reason-dropdown', reasonItems, null, true); // No callback needed, will read on save


            // Open Leave Request Form
            if (openLeaveRequestBtn) openLeaveRequestBtn.addEventListener('click', () => {
                console.log("Opening leave request form.");
                 if (!currentUser) {
                     alert("សូម Login ជាមុនសិន។");
                     return;
                 }
                
                 const reqPhoto = document.getElementById('request-user-photo');
                 const reqName = document.getElementById('request-user-name');
                 const reqId = document.getElementById('request-user-id');
                 const reqDept = document.getElementById('request-user-department');

                 if(reqPhoto) reqPhoto.src = currentUser.photo || 'https://placehold.co/60x60/e2e8f0/64748b?text=User';
                 if(reqName) reqName.textContent = currentUser.name;
                 if(reqId) reqId.textContent = currentUser.id;
                 if(reqDept) reqDept.textContent = currentUser.department || 'មិនមាន';
                
                // Reset form fields
                if (durationSearchInput && typeof durationSearchInput.setValue === 'function') durationSearchInput.setValue(null);
                if (reasonSearchInput && typeof reasonSearchInput.setValue === 'function') reasonSearchInput.setValue(null);
                selectedDuration = null;
                selectedReason = null;
                if (singleDateContainer) singleDateContainer.classList.add('hidden');
                if (dateRangeContainer) dateRangeContainer.classList.add('hidden');
                if (requestErrorEl) requestErrorEl.classList.add('hidden');
                if (requestLoadingEl) requestLoadingEl.classList.add('hidden');
                if (submitLeaveRequestBtn) submitLeaveRequestBtn.disabled = false;
                
                navigateTo('page-request-leave');
            });

            // Cancel Leave Request
            if (cancelLeaveRequestBtn) cancelLeaveRequestBtn.addEventListener('click', () => {
                console.log("Cancelling leave request.");
                navigateTo('page-home');
            });

            // Submit Leave Request
            if (submitLeaveRequestBtn) submitLeaveRequestBtn.addEventListener('click', async () => {
                 console.log("Submit leave request button clicked.");
                 
                 const finalDuration = getSelectedDuration();
                 const finalReason = getSelectedReason();
                 
                 if (!currentUser || !currentUser.id) {
                     alert("មានបញ្ហា៖ មិនអាចបញ្ជាក់អ្នកប្រើប្រាស់បានទេ។ សូមព្យាយាម Login ម្ដងទៀត។");
                     return;
                 }
                 
                if (!finalDuration || !durations.includes(finalDuration)) {
                    console.warn("Submit failed: Duration is invalid or not in the list.");
                    if (requestErrorEl) {
                        requestErrorEl.textContent = 'សូមជ្រើសរើស "រយៈពេល" ពីក្នុងបញ្ជីឲ្យបានត្រឹមត្រូវ។';
                        requestErrorEl.classList.remove('hidden');
                    }
                    if (durationSearchInput) durationSearchInput.focus();
                    return;
                }
                
                if (!finalReason || finalReason.trim() === '') {
                     console.warn("Submit failed: Reason is empty.");
                    if (requestErrorEl) {
                        requestErrorEl.textContent = 'សូមបំពេញ "មូលហេតុ" ជាមុនសិន។';
                        requestErrorEl.classList.remove('hidden');
                    }
                    if (reasonSearchInput) reasonSearchInput.focus();
                    return;
                }
                
                if (requestErrorEl) requestErrorEl.classList.add('hidden');
                if (requestLoadingEl) requestLoadingEl.classList.remove('hidden');
                if (submitLeaveRequestBtn) submitLeaveRequestBtn.disabled = true;
                console.log("Submitting leave request with:", { finalDuration, finalReason });


                try {
                    // Determine start and end dates
                    const startDate = singleDayDurations.includes(finalDuration) 
                        ? (singleDateInput ? singleDateInput.value : getTodayString())
                        : (startDateInput ? startDateInput.value : getTodayString());
                    const endDate = singleDayDurations.includes(finalDuration) 
                        ? startDate 
                        : (endDateInput ? endDateInput.value : getTodayString());
                        
                     console.log("Calculated dates (YYYY-MM-DD):", { startDate, endDate });
                    
                    if (new Date(endDate) < new Date(startDate)) {
                         throw new Error('"ថ្ងៃបញ្ចប់" មិនអាចនៅមុន "ថ្ងៃចាប់ផ្តើម" បានទេ។');
                    }

                    const requestId = `leave_${Date.now()}`;
                    console.log("Generated Request ID:", requestId);
                    
                    const requestData = {
                        userId: currentUser.id,
                        name: currentUser.name,
                        department: currentUser.department || 'N/A',
                        photo: currentUser.photo || null,
                        duration: finalDuration,
                        reason: finalReason.trim(),
                        startDate: startDate, // YYYY-MM-DD
                        endDate: endDate,   // YYYY-MM-DD
                        status: 'pending', 
                        requestedAt: serverTimestamp(),
                        requestId: requestId,
                        decisionAt: null, 
                        firestoreUserId: auth.currentUser ? auth.currentUser.uid : 'unknown_auth_user'
                    };
                    
                     console.log("Request data prepared for Firestore:", requestData);

                    if (!db || !leaveRequestsCollectionPath) {
                        throw new Error("Firestore DB or Collection Path is not initialized.");
                    }
                    const requestRef = doc(db, leaveRequestsCollectionPath, requestId);
                    console.log("Attempting to write to Firestore path:", leaveRequestsCollectionPath, "with ID:", requestId);
                    await setDoc(requestRef, requestData);
                    console.log("Firestore write successful.");


                    // --- Send Telegram Notification ---
                    const displayStartDate = formatToMDY(startDate);
                    const displayEndDate = formatToMDY(endDate);
                    const dateString = (displayStartDate === displayEndDate) 
                        ? displayStartDate 
                        : `ពី ${displayStartDate} ដល់ ${displayEndDate}`;
                    
                    let message = `<b>🔔 សំណើសុំច្បាប់ថ្មី 🔔</b>\n\n`;
                    message += `<b>ឈ្មោះ:</b>     ${requestData.name}\n`;
                    message += `<b>អត្តលេខ:</b>   ${requestData.userId}\n`;
                    message += `<b>ផ្នែក:</b>       ${requestData.department}\n`;
                    message += `<b>រយៈពេល:</b>  ${requestData.duration}\n`;
                    message += `<b>មូលហេតុ:</b>   ${requestData.reason}\n`;
                    message += `<b>កាលបរិច្ឆេទ:</b> ${dateString}\n\n`;
                    message += `(សូមចូល Firestore ដើម្បីពិនិត្យ ID: \`${requestId}\`)`;

                    console.log("Sending Telegram notification...");
                    const telegramUrl = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                     const telegramResponse = await fetch(telegramUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: CHAT_ID,
                            text: message,
                            parse_mode: 'HTML'
                        })
                    });
                     if (!telegramResponse.ok) {
                         const errorBody = await telegramResponse.text();
                         console.error("Telegram API error:", telegramResponse.status, errorBody);
                     } else {
                         console.log("Telegram notification sent successfully.");
                     }

                    if (requestLoadingEl) requestLoadingEl.classList.add('hidden');
                    alert('សំណើរបស់អ្នកត្រូវបានផ្ញើដោយជោគជ័យ!');
                    navigateTo('page-history'); 

                } catch (error) {
                    console.error("Error submitting leave request:", error);
                     let displayError = error.message;
                     if (error.code && error.code.includes('permission-denied')) {
                         displayError = 'Missing or insufficient permissions. សូមពិនិត្យ Firestore Rules។';
                     }
                    if (requestErrorEl) {
                        requestErrorEl.textContent = `Error: ${displayError}`;
                        requestErrorEl.classList.remove('hidden');
                    }
                    if (requestLoadingEl) requestLoadingEl.classList.add('hidden');
                    if (submitLeaveRequestBtn) submitLeaveRequestBtn.disabled = false;
                }
            });

            // --- History Page Logic (NEW: With Filters and Tabs) ---
            
            function setupHistoryFilters() {
                const now = new Date();
                const currentMonth = now.getMonth() + 1; // 1-12
                const currentYear = now.getFullYear();

                currentHistoryFilter.month = currentMonth;
                currentHistoryFilter.year = currentYear;

                // Populate Month Filter
                const months = ["មករា", "កុម្ភៈ", "មីនា", "មេសា", "ឧសភា", "មិថុនា", "កក្កដា", "សីហា", "កញ្ញា", "តុលា", "វិច្ឆិកា", "ធ្នូ"];
                if(monthFilterSelect) {
                    monthFilterSelect.innerHTML = ''; // Clear existing
                    months.forEach((month, index) => {
                        const monthValue = index + 1;
                        const option = document.createElement('option');
                        option.value = monthValue;
                        option.textContent = month;
                        if (monthValue === currentMonth) {
                            option.selected = true;
                        }
                        monthFilterSelect.appendChild(option);
                    });
                }
                
                // Populate Year Filter (Current year + 2 previous years)
                if(yearFilterSelect) {
                    yearFilterSelect.innerHTML = ''; // Clear existing
                    for (let y = currentYear; y >= currentYear - 2; y--) {
                         const option = document.createElement('option');
                        option.value = y;
                        option.textContent = y;
                        if (y === currentYear) {
                            option.selected = true;
                        }
                        yearFilterSelect.appendChild(option);
                    }
                }
                
                // Add event listeners to filters
                if(monthFilterSelect) monthFilterSelect.addEventListener('change', updateHistoryFilter);
                if(yearFilterSelect) yearFilterSelect.addEventListener('change', updateHistoryFilter);
                
                // Add event listeners to tabs
                if(historyTabLeave) historyTabLeave.addEventListener('click', () => switchHistoryTab('leave'));
                if(historyTabOut) historyTabOut.addEventListener('click', () => switchHistoryTab('out'));
            }

            function switchHistoryTab(tabName) {
                currentHistoryFilter.type = tabName;
                console.log("Switched history tab to:", tabName);

                if (tabName === 'leave') {
                    // Show leave content, hide out content
                    if(historyTabLeave) historyTabLeave.classList.add('border-blue-600', 'text-blue-600');
                    if(historyTabLeave) historyTabLeave.classList.remove('border-transparent', 'text-gray-500');
                    if(historyTabOut) historyTabOut.classList.add('border-transparent', 'text-gray-500');
                    if(historyTabOut) historyTabOut.classList.remove('border-blue-600', 'text-blue-600');
                    if(historyContentLeave) historyContentLeave.classList.remove('hidden');
                    if(historyContentOut) historyContentOut.classList.add('hidden');
                    
                    // Re-apply filter for this tab
                    updateHistoryFilter();
                } else if (tabName === 'out') {
                    // Show out content, hide leave content
                    if(historyTabLeave) historyTabLeave.classList.add('border-transparent', 'text-gray-500');
                    if(historyTabLeave) historyTabLeave.classList.remove('border-blue-600', 'text-blue-600');
                    if(historyTabOut) historyTabOut.classList.add('border-blue-600', 'text-blue-600');
                    if(historyTabOut) historyTabOut.classList.remove('border-transparent', 'text-gray-500');
                    if(historyContentLeave) historyContentLeave.classList.add('hidden');
                    if(historyContentOut) historyContentOut.classList.remove('hidden');
                    
                    // TODO: In the future, you would apply the filter for 'out' requests here.
                    // For now, it just shows an empty state.
                    console.log("Out tab selected (no data source).");
                }
            }

            function updateHistoryFilter() {
                if(monthFilterSelect) currentHistoryFilter.month = parseInt(monthFilterSelect.value, 10);
                if(yearFilterSelect) currentHistoryFilter.year = parseInt(yearFilterSelect.value, 10);
                
                console.log("History filter updated:", currentHistoryFilter);
                
                if (currentUser && currentUser.id) {
                    setupHistoryListener(currentUser.id, currentHistoryFilter.month, currentHistoryFilter.year);
                }
            }


            function setupHistoryListener(currentEmployeeId, month, year) {
                console.log(`Setting up history listener for ID: ${currentEmployeeId}, Month: ${month}, Year: ${year}`);
                if (historyUnsubscribe) {
                     console.log("Detaching previous history listener.");
                    historyUnsubscribe();
                }
                
                if (!db || !leaveRequestsCollectionPath) {
                    console.error("Firestore DB or Collection Path is not initialized. Cannot setup history listener.");
                    return;
                }
                
                // Calculate start and end of the selected month
                const startDate = new Date(year, month - 1, 1); // First day of the month
                const endDate = new Date(year, month, 1); // First day of the *next* month
                
                // Convert to Firebase Timestamps
                const startTimestamp = Timestamp.fromDate(startDate);
                const endTimestamp = Timestamp.fromDate(endDate);
                
                console.log(`Querying collection '${leaveRequestsCollectionPath}' where 'userId' == '${currentEmployeeId}' AND 'requestedAt' >= ${startDate.toISOString()} AND 'requestedAt' < ${endDate.toISOString()}`);
                
                const historyQuery = query(
                    collection(db, leaveRequestsCollectionPath),
                    where("userId", "==", currentEmployeeId),
                    where("requestedAt", ">=", startTimestamp),
                    where("requestedAt", "<", endTimestamp)
                );

                if(historyContainer) historyContainer.innerHTML = ''; // Clear current view
                if(historyPlaceholder) historyPlaceholder.classList.remove('hidden');
                if(historyPlaceholder) historyPlaceholder.innerHTML = '<p class="text-gray-500">កំពុងទាញយក...</p>'; // Show loading

                historyUnsubscribe = onSnapshot(historyQuery, (snapshot) => {
                     console.log(`Received history snapshot. Empty: ${snapshot.empty}, Size: ${snapshot.size}`);
                    if (snapshot.empty) {
                        if (historyPlaceholder) historyPlaceholder.classList.remove('hidden');
                        if (historyContainer) historyContainer.innerHTML = ''; // Clear
                        if (historyPlaceholder) historyPlaceholder.innerHTML = '<p class="text-center text-gray-500 mt-4">មិនមានទិន្នន័យសម្រាប់ខែនេះ</p>';
                    } else {
                        if (historyPlaceholder) historyPlaceholder.classList.add('hidden');
                        if (historyContainer) historyContainer.innerHTML = ''; 
                        
                        const requests = [];
                        snapshot.forEach(doc => {
                            requests.push(doc.data());
                        });

                        requests.sort((a, b) => {
                             const timeA = a.requestedAt?.toMillis ? a.requestedAt.toMillis() : 0;
                             const timeB = b.requestedAt?.toMillis ? b.requestedAt.toMillis() : 0;
                            return timeB - timeA; 
                        });
                        console.log(`Rendering ${requests.length} history items.`);
                        requests.forEach(renderHistoryCard);
                    }
                }, (error) => {
                    console.error("Error listening to history:", error);
                    let errorMsg = 'Error: មិនអាចទាញយកប្រវត្តិបានទេ';
                    if (error.code && error.code.includes('permission-denied')) {
                         errorMsg = 'Error: មិនមានសិទ្ធិទាញយកប្រវត្តិ (Permission Denied)';
                     }
                    if (historyPlaceholder) {
                        historyPlaceholder.classList.remove('hidden');
                        historyPlaceholder.innerHTML = `<p class="text-red-500 text-center">${errorMsg}</p>`;
                    }
                    if (historyContainer) historyContainer.innerHTML = '';
                });
            }

            function renderHistoryCard(request) {
                 if (!request || !request.requestId) {
                     console.warn("Attempted to render invalid history card data:", request);
                     return; 
                 }
                let statusColor, statusText;
                let decisionTimeHtml = ''; 
                let actionButtonsHtml = ''; // NEW: For Edit/Delete buttons

                switch(request.status) {
                    case 'approved':
                        statusColor = 'bg-green-100 text-green-800';
                        statusText = 'បានយល់ព្រម';
                        const approvedTime = formatTimestampToLocalTime(request.decisionAt);
                        if (approvedTime) {
                            decisionTimeHtml = `<p class="text-xs text-green-600 mt-1">នៅម៉ោង: ${approvedTime}</p>`;
                        }
                        break;
                    case 'rejected':
                        statusColor = 'bg-red-100 text-red-800';
                        statusText = 'បានបដិសេធ';
                        const rejectedTime = formatTimestampToLocalTime(request.decisionAt);
                        if (rejectedTime) {
                            decisionTimeHtml = `<p class="text-xs text-red-600 mt-1">នៅម៉ោង: ${rejectedTime}</p>`;
                        }
                        break;
                    case 'editing': // NEW: Editing status
                         statusColor = 'bg-blue-100 text-blue-800';
                         statusText = 'កំពុងកែសម្រួល...';
                         break;
                    default: // 'pending'
                        statusColor = 'bg-yellow-100 text-yellow-800';
                        statusText = 'កំពុងរង់ចាំ';
                        // NEW: Add Edit/Delete buttons only if pending
                        actionButtonsHtml = `
                            <div class="flex items-center space-x-2">
                                <button class="edit-btn p-1 text-gray-400 hover:text-blue-600" data-request-id="${request.requestId}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                      <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <button class="delete-btn p-1 text-gray-400 hover:text-red-600" data-request-id="${request.requestId}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        `;
                }

                const displayStartDate = formatToMDY(request.startDate);
                const displayEndDate = formatToMDY(request.endDate);
                const dateString = (displayStartDate === displayEndDate) 
                    ? displayStartDate 
                    : (displayStartDate !== "N/A" && displayEndDate !== "N/A" ? `${displayStartDate} - ${displayEndDate}` : 'N/A'); 

                const card = `
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-semibold text-gray-800">${request.duration || 'N/A'}</span>
                            <div class="text-right">
                                <span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusColor}">
                                    ${statusText}
                                </span>
                                ${decisionTimeHtml} 
                            </div>
                        </div>
                        <div class="space-y-1">
                            <p class="text-sm text-gray-600">
                                <span class="font-medium">កាលបរិច្ឆេទ:</span> ${dateString}
                            </p>
                            <p class="text-sm text-gray-600">
                                <span class="font-medium">មូលហេតុ:</span> ${request.reason || 'មិនបានបញ្ជាក់'}
                            </p>
                        </div>
                        <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-100">
                             <p class="text-xs text-gray-400">
                                ID: ${request.requestId}
                            </p>
                            ${actionButtonsHtml}
                        </div>
                    </div>
                `;
                if (historyContainer) historyContainer.innerHTML += card;
                 else {
                     console.error("History container not found when rendering card.");
                 }
            }
            
            // --- NEW: Add event listeners for Edit/Delete buttons (must use event delegation) ---
            if (historyContainer) {
                historyContainer.addEventListener('click', async (e) => {
                    const editButton = e.target.closest('.edit-btn');
                    const deleteButton = e.target.closest('.delete-btn');

                    if (editButton) {
                        const requestId = editButton.dataset.requestId;
                        console.log("Edit button clicked for:", requestId);
                        await openEditModal(requestId);
                    }
                    
                    if (deleteButton) {
                        const requestId = deleteButton.dataset.requestId;
                        console.log("Delete button clicked for:", requestId);
                        openDeleteModal(requestId);
                    }
                });
            }
            
            // --- NEW: Edit/Delete Modal Functions ---
            
            let allHistoryRequests = []; // Cache to find request data for editing
            // Modify onSnapshot to cache data
            // (Inside setupHistoryListener's onSnapshot success callback...)
            /* ...
                allHistoryRequests = []; // Clear cache
                snapshot.forEach(doc => {
                    allHistoryRequests.push(doc.data());
                });
                
                const requests = allHistoryRequests.sort(...)
                ...
            */
           
           // Modify the onSnapshot in setupHistoryListener to populate allHistoryRequests
           // Find setupHistoryListener...
           /* historyUnsubscribe = onSnapshot(historyQuery, (snapshot) => {
                   ...
                   if (snapshot.empty) {
                       allHistoryRequests = []; // Clear cache
                       ...
                   } else {
                       ...
                       allHistoryRequests = []; // Clear cache
                       snapshot.forEach(doc => {
                           allHistoryRequests.push(doc.data());
                       });

                       const requests = allHistoryRequests.sort(...) // Sort from the cache
                       ...
                       requests.forEach(renderHistoryCard);
                   }
               }, ...);
           */
           // The code is already structured this way, just need to make sure `allHistoryRequests` is populated.
           // Re-writing setupHistoryListener to be sure:
           
           function setupHistoryListener(currentEmployeeId, month, year) {
                console.log(`Setting up history listener for ID: ${currentEmployeeId}, Month: ${month}, Year: ${year}`);
                if (historyUnsubscribe) {
                     console.log("Detaching previous history listener.");
                    historyUnsubscribe();
                }
                
                if (!db || !leaveRequestsCollectionPath) {
                    console.error("Firestore DB is not initialized. Cannot setup history listener.");
                    return;
                }
                
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 1);
                const startTimestamp = Timestamp.fromDate(startDate);
                const endTimestamp = Timestamp.fromDate(endDate);
                
                console.log(`Querying collection '${leaveRequestsCollectionPath}' where 'userId' == '${currentEmployeeId}' AND 'requestedAt' >= ${startDate.toISOString()} AND 'requestedAt' < ${endDate.toISOString()}`);
                
                const historyQuery = query(
                    collection(db, leaveRequestsCollectionPath),
                    where("userId", "==", currentEmployeeId),
                    where("requestedAt", ">=", startTimestamp),
                    where("requestedAt", "<", endTimestamp)
                );

                if(historyContainer) historyContainer.innerHTML = ''; 
                if(historyPlaceholder) historyPlaceholder.classList.remove('hidden');
                if(historyPlaceholder) historyPlaceholder.innerHTML = '<p class="text-gray-500">កំពុងទាញយក...</p>';

                historyUnsubscribe = onSnapshot(historyQuery, (snapshot) => {
                     console.log(`Received history snapshot. Empty: ${snapshot.empty}, Size: ${snapshot.size}`);
                     allHistoryRequests = []; // NEW: Clear cache on every update
                    if (snapshot.empty) {
                        if (historyPlaceholder) historyPlaceholder.classList.remove('hidden');
                        if (historyContainer) historyContainer.innerHTML = '';
                        if (historyPlaceholder) historyPlaceholder.innerHTML = '<p class="text-center text-gray-500 mt-4">មិនមានទិន្នន័យសម្រាប់ខែនេះ</p>';
                    } else {
                        if (historyPlaceholder) historyPlaceholder.classList.add('hidden');
                        if (historyContainer) historyContainer.innerHTML = ''; 
                        
                        snapshot.forEach(doc => {
                            allHistoryRequests.push(doc.data()); // NEW: Populate cache
                        });

                        const requests = [...allHistoryRequests].sort((a, b) => { // Sort from a copy
                             const timeA = a.requestedAt?.toMillis ? a.requestedAt.toMillis() : 0;
                             const timeB = b.requestedAt?.toMillis ? b.requestedAt.toMillis() : 0;
                            return timeB - timeA; 
                        });
                        console.log(`Rendering ${requests.length} history items.`);
                        requests.forEach(renderHistoryCard);
                    }
                }, (error) => {
                    allHistoryRequests = []; // Clear cache on error
                    console.error("Error listening to history:", error);
                    let errorMsg = 'Error: មិនអាចទាញយកប្រវត្តិបានទេ';
                    if (error.code && error.code.includes('permission-denied')) {
                         errorMsg = 'Error: មិនមានសិទ្ធិទាញយកប្រវត្តិ (Permission Denied)';
                     }
                    if (historyPlaceholder) {
                        historyPlaceholder.classList.remove('hidden');
                        historyPlaceholder.innerHTML = `<p class="text-red-500 text-center">${errorMsg}</p>`;
                    }
                    if (historyContainer) historyContainer.innerHTML = '';
                });
            }

            async function openEditModal(requestId) {
                if (!editModal) return;
                console.log("Opening edit modal for:", requestId);
                
                const request = allHistoryRequests.find(r => r.requestId === requestId);
                if (!request) {
                    console.error("Could not find request data to edit:", requestId);
                    alert("Error: រកមិនឃើញទិន្នន័យសំណើ។");
                    return;
                }
                
                // Check if still pending
                if (request.status !== 'pending') {
                    alert("សំណើនេះ មិនអាចកែសម្រួលបានទេ (ព្រោះត្រូវបានអនុម័ត/បដិសេធហើយ)។");
                    return;
                }

                // --- IMPORTANT: Set status to 'editing' in Firestore ---
                try {
                    const requestRef = doc(db, leaveRequestsCollectionPath, requestId);
                    await updateDoc(requestRef, { status: 'editing' });
                    console.log("Status set to 'editing' in Firestore.");
                } catch (e) {
                    console.error("Error setting 'editing' status:", e);
                    alert("Error: មិនអាចចាប់ផ្តើមកែសម្រួលបានទេ។ សូមព្យាយាមម្តងទៀត។");
                    return;
                }

                // Populate Modal Fields
                if(editRequestId) editRequestId.value = request.requestId; // Store ID in hidden input
                if(editDurationSearch) editDurationSearch.setValue(request.duration);
                if(editReasonSearch) editReasonSearch.setValue(request.reason);
                
                // Trigger date field update based on duration
                updateDateFields(request.duration, 'edit-');
                
                // Set specific dates
                if (singleDayDurations.includes(request.duration)) {
                    if(editSingleDateInput) editSingleDateInput.value = request.startDate;
                } else {
                    if(editStartDateInput) editStartDateInput.value = request.startDate;
                    if(editEndDateInput) editEndDateInput.value = request.endDate;
                }
                
                if(editErrorEl) editErrorEl.classList.add('hidden');
                if(editLoadingEl) editLoadingEl.classList.add('hidden');
                if(saveEditBtn) saveEditBtn.disabled = false;
                
                editModal.classList.remove('hidden');
            }

            async function closeEditModal(revertStatus = false) {
                if (!editModal) return;
                const requestId = editRequestId.value;
                
                if (revertStatus && requestId) {
                    console.log("Reverting status to 'pending' for:", requestId);
                    try {
                        const requestRef = doc(db, leaveRequestsCollectionPath, requestId);
                        await updateDoc(requestRef, { status: 'pending' });
                    } catch (e) {
                        console.error("Error reverting status:", e);
                        // Still close modal
                    }
                }
                editModal.classList.add('hidden');
            }

            if(cancelEditBtn) cancelEditBtn.addEventListener('click', () => closeEditModal(true)); // Revert status on cancel

            if(saveEditBtn) saveEditBtn.addEventListener('click', async () => {
                if (!editModal || !saveEditBtn) return;
                
                const requestId = editRequestId.value;
                const finalDuration = getSelectedEditDuration();
                const finalReason = getSelectedEditReason();
                
                // Validation
                if (!finalDuration || !durations.includes(finalDuration)) {
                     if(editErrorEl) editErrorEl.textContent = 'សូមជ្រើសរើស "រយៈពេល" ឲ្យបានត្រឹមត្រូវ។';
                     if(editErrorEl) editErrorEl.classList.remove('hidden');
                    return;
                }
                if (!finalReason || finalReason.trim() === '') {
                     if(editErrorEl) editErrorEl.textContent = 'សូមបំពេញ "មូលហេតុ" ជាមុនសិន។';
                     if(editErrorEl) editErrorEl.classList.remove('hidden');
                    return;
                }
                
                if(editErrorEl) editErrorEl.classList.add('hidden');
                if(editLoadingEl) editLoadingEl.classList.remove('hidden');
                saveEditBtn.disabled = true;
                
                try {
                    const startDate = singleDayDurations.includes(finalDuration)
                        ? (editSingleDateInput ? editSingleDateInput.value : getTodayString())
                        : (editStartDateInput ? editStartDateInput.value : getTodayString());
                    const endDate = singleDayDurations.includes(finalDuration)
                        ? startDate
                        : (editEndDateInput ? editEndDateInput.value : getTodayString());

                    if (new Date(endDate) < new Date(startDate)) {
                         throw new Error('"ថ្ងៃបញ្ចប់" មិនអាចនៅមុន "ថ្ងៃចាប់ផ្តើម" បានទេ។');
                    }
                    
                    const updatedData = {
                        duration: finalDuration,
                        reason: finalReason.trim(),
                        startDate: startDate,
                        endDate: endDate,
                        status: 'pending', // Revert status to 'pending'
                        requestedAt: serverTimestamp() // Update timestamp to show it's recent
                    };
                    
                    const requestRef = doc(db, leaveRequestsCollectionPath, requestId);
                    await updateDoc(requestRef, updatedData);
                    console.log("Update successful for:", requestId);
                    
                    // --- Send *Updated* Telegram Notification ---
                    const displayStartDate = formatToMDY(startDate);
                    const displayEndDate = formatToMDY(endDate);
                    const dateString = (displayStartDate === displayEndDate) 
                        ? displayStartDate 
                        : `ពី ${displayStartDate} ដល់ ${displayEndDate}`;
                    
                    let message = `<b>✏️ សំណើត្រូវបានកែសម្រួល ✏️</b>\n\n`;
                    message += `<b>ឈ្មោះ:</b>     ${currentUser.name}\n`;
                    message += `<b>អត្តលេខ:</b>   ${currentUser.id}\n`;
                    message += `<b>រយៈពេល:</b>  ${finalDuration}\n`;
                    message += `<b>មូលហេតុ:</b>   ${finalReason.trim()}\n`;
                    message += `<b>កាលបរិច្ឆេទ:</b> ${dateString}\n\n`;
                    message += `(ID: \`${requestId}\` ត្រូវបាន Update សូមពិនិត្យឡើងវិញ)`;

                    const telegramUrl = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                    await fetch(telegramUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: CHAT_ID,
                            text: message,
                            parse_mode: 'HTML'
                        })
                    });
                    
                    alert("ការកែសម្រួល ត្រូវបានរក្សាទុកដោយជោគជ័យ!");
                    closeEditModal(false); // Close without reverting status (already set to pending)
                    
                } catch (e) {
                    console.error("Error saving edit:", e);
                     if(editErrorEl) editErrorEl.textContent = `Error: ${e.message}`;
                     if(editErrorEl) editErrorEl.classList.remove('hidden');
                     if(editLoadingEl) editLoadingEl.classList.add('hidden');
                     saveEditBtn.disabled = false;
                }
            });

            function openDeleteModal(requestId) {
                if (!deleteModal || !deleteConfirmText || !deleteConfirmBtn) return;
                
                const request = allHistoryRequests.find(r => r.requestId === requestId);
                if (!request) {
                    alert("Error: រកមិនឃើញទិន្នន័យសំណើ។");
                    return;
                }
                
                // Check if still pending or editing
                if (request.status !== 'pending' && request.status !== 'editing') {
                    alert("សំណើនេះ មិនអាចលុបបានទេ (ព្រោះត្រូវបានអនុម័ត/បដិសេធហើយ)។");
                    return;
                }

                deleteConfirmText.textContent = `តើអ្នកពិតជាចង់លុបសំណើ (${request.duration} - ${request.reason}) មែនទេ?`;
                deleteConfirmBtn.dataset.requestId = requestId; // Store ID on button
                
                if(deleteLoadingEl) deleteLoadingEl.classList.add('hidden');
                deleteModal.classList.remove('hidden');
            }
            
            if(deleteCancelBtn) deleteCancelBtn.addEventListener('click', () => {
                if(deleteModal) deleteModal.classList.add('hidden');
            });
            
            if(deleteConfirmBtn) deleteConfirmBtn.addEventListener('click', async () => {
                if(!deleteConfirmBtn || !deleteLoadingEl) return;
                
                const requestId = deleteConfirmBtn.dataset.requestId;
                if (!requestId) return;
                
                deleteLoadingEl.classList.remove('hidden');
                deleteConfirmBtn.disabled = true;
                
                try {
                    const requestRef = doc(db, leaveRequestsCollectionPath, requestId);
                    await deleteDoc(requestRef);
                    console.log("Document successfully deleted:", requestId);
                    
                    alert("សំណើត្រូវបានលុបដោយជោគជ័យ។");
                    if(deleteModal) deleteModal.classList.add('hidden');
                    
                } catch (e) {
                    console.error("Error deleting document:", e);
                    alert(`Error: មិនអាចលុបសំណើបានទេ។ ${e.message}`);
                } finally {
                     if(deleteLoadingEl) deleteLoadingEl.classList.add('hidden');
                     if(deleteConfirmBtn) deleteConfirmBtn.disabled = false;
                }
            });

        });
    </script>
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }
        #user-dropdown, #duration-dropdown, #reason-dropdown, #edit-duration-dropdown, #edit-reason-dropdown {
            scrollbar-width: thin;
            scrollbar-color: #9ca3af #f3f4f6;
        }
        #user-dropdown::-webkit-scrollbar, #duration-dropdown::-webkit-scrollbar, #reason-dropdown::-webkit-scrollbar, #edit-duration-dropdown::-webkit-scrollbar, #edit-reason-dropdown::-webkit-scrollbar {
            width: 6px;
        }
        #user-dropdown::-webkit-scrollbar-track, #duration-dropdown::-webkit-scrollbar-track, #reason-dropdown::-webkit-scrollbar-track, #edit-duration-dropdown::-webkit-scrollbar-track, #edit-reason-dropdown::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 10px;
        }
        #user-dropdown::-webkit-scrollbar-thumb, #duration-dropdown::-webkit-scrollbar-thumb, #reason-dropdown::-webkit-scrollbar-thumb, #edit-duration-dropdown::-webkit-scrollbar-thumb, #edit-reason-dropdown::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 10px;
            border: 2px solid #f3f4f6;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #page-request-leave, #edit-request-modal {
            min-height: 100vh;
        }
        /* Style for active history tab */
        .history-tab-active {
            border-bottom-width: 3px;
            border-color: #2563EB; /* blue-600 */
            color: #2563EB;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ===== CRITICAL ERROR DISPLAY ===== -->
    <div id="critical-error-display" class="max-w-md mx-auto min-h-screen flex flex-col justify-center items-center p-6 text-center text-red-600 font-semibold hidden">
        <!-- Error message will be injected here by JS -->
    </div>

    <!-- ===== LOGIN PAGE ===== -->
    <div id="page-login" class="max-w-md mx-auto min-h-screen flex flex-col justify-center items-center p-6 bg-gray-50">
        <!-- Logo and Title -->
        <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="h-20 w-20 mb-4">
        <h1 class="text-2xl font-bold text-blue-800 mb-2">ឧស្សាហកម្មឌីជីថល</h1>
        <p class="text-gray-600 mb-8">សូមចូលប្រើកម្មវិធីសុំច្បាប់</p>

        <!-- In-App Browser Warning -->
        <div id="in-app-warning" class="w-full max-w-sm p-4 bg-yellow-100 border border-yellow-300 rounded-lg text-yellow-800 text-sm text-left hidden">
            <p class="font-bold text-base mb-2">បញ្ហាកាមេរ៉ា!</p>
            <p>កម្មវិធីនេះ ត្រូវការបើកកាមេរ៉ា ដែលមិនអាចដំណើរការក្នុង Telegram/Facebook បានទេ។</p>
            <p class="font-semibold mt-3">ដំណោះស្រាយ៖</p>
            <ol class="list-decimal list-inside mt-1">
                <li>នៅខាងលើស្តាំ, ចុចសញ្ញា <span class="font-bold">...</span></li>
                <li>ជ្រើសរើស "Open in Browser" (បើកក្នុង Browser)</li>
            </ol>
            <p class="mt-2">បន្ទាប់មក កម្មវិធីនឹងបើកក្នុង Chrome/Safari ហើយកាមេរ៉ានឹងដំណើរការ។</p>
        </div>

        <!-- Data Loading Indicator -->
        <div id="data-loading-indicator" class="w-full max-w-sm p-6 bg-white rounded-lg shadow-md border border-gray-200 flex flex-col items-center justify-center hidden">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600 font-medium">កំពុងទាញយកទិន្នន័យបុគ្គលិក...</p>
            <p class="text-xs text-gray-400 mt-1">សូមរង់ចាំបន្តិច</p>
        </div>

        <!-- Form (will be hidden until data loads) -->
        <div id="login-form-container" class="w-full bg-white p-6 rounded-lg shadow-md border border-gray-200 hidden">
            <!-- Searchable Dropdown -->
            <label for="user-search" class="block text-sm font-medium text-gray-700 mb-2">ជ្រើសរើសអត្តលេខ (ID)</label>
            <div class="relative">
                <input
                    type="text"
                    id="user-search"
                    placeholder="វាយ ឬ ជ្រើសរើស..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    autocomplete="off"
                >
                <!-- Custom Dropdown List -->
                <div
                    id="user-dropdown"
                    class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"
                >
                    <!-- User items will be injected here by JS -->
                </div>
            </div>
            
            <!-- Remember Me Checkbox -->
            <div class="flex items-center mt-4">
                <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <label for="remember-me" class="ml-2 block text-sm text-gray-700">ចងចាំខ្ញុំនៅលើ Device នេះ</label>
            </div>

            <!-- Login Button -->
            <button id="scan-face-btn" class="mt-6 w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 flex items-center justify-center space-x-2 disabled:opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm11 11H5V5h10v8zm-5 2a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
                </svg>
                <span>ចូលដោយស្កេនផ្ទៃមុខ</span>
            </button>
            <p id="model-status" class="text-xs text-gray-500 text-center mt-2"></p>
        </div>
    </div>

    <!-- ===== Face Scan Modal ===== -->
    <div id="face-scan-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md text-center">
            <h3 class="text-xl font-bold mb-4">កំពុងស្កេនផ្ទៃមុខ</h3>
            <div class="relative w-full h-64 bg-gray-800 rounded-lg overflow-hidden border-4 border-blue-500">
                <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
                <div id="scan-overlay" class="absolute inset-0 border-8 border-transparent animate-pulse"></div>
            </div>
            <p id="scan-status" class="mt-4 text-lg font-medium text-gray-700">រកមិនឃើញផ្ទៃមុខ...</p>
            <p id="scan-debug" class="text-xs text-gray-500 h-4"></p>
            <button id="cancel-scan-btn" class="mt-4 w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300">
                បោះបង់
            </button>
        </div>
    </div>

    <!-- ===== MAIN APP (Hidden by default) ===== -->
    <div id="main-app-container" class="max-w-md mx-auto min-h-screen bg-white shadow-lg hidden">
        
        <!-- Main Content Area (scrollable) -->
        <main id="main-content" class="pb-20" style="height: 100vh; overflow-y: auto;">
            
            <!-- ===== PAGE 1: HOME (ទំព័រដើម) ===== -->
            <div id="page-home" class="p-6">
                <!-- Header -->
                <header class="flex items-center justify-between mb-8">
                    <div class="flex items-center space-x-3">
                        <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="h-10 w-10 rounded-full border">
                        <div>
                            <p class="text-sm text-gray-500">ស្វាគមន៍</p>
                            <h2 id="home-user-name" class="text-xl font-bold text-gray-800">...</h2>
                        </div>
                    </div>
                </header>

                <!-- Request Types Section -->
                <section>
                    <h3 class="text-md font-semibold text-gray-700 mb-3">ប្រភេទសំណើសុំច្បាប់</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Leave Request -->
                        <button id="open-leave-request-btn" class="bg-blue-50 border border-blue-200 text-blue-800 p-6 rounded-lg shadow-sm hover:bg-blue-100 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-lg font-semibold">សុំច្បាប់ឈប់</p>
                            <p class="text-sm">ឈប់សម្រាក</p>
                        </button>
                        <!-- Out Request -->
                        <button class="bg-green-50 border border-green-200 text-green-800 p-6 rounded-lg shadow-sm hover:bg-green-100 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p class="text-lg font-semibold">សុំច្បាប់ចេញក្រៅ</p>
                            <p class="text-sm">ចេញក្រៅផ្ទាល់ខ្លួន</p>
                        </button>
                    </div>
                </section>
                
                <!-- Approver Section -->
                <section class="mt-8">
                    <h3 class="text-md font-semibold text-gray-700 mb-3">អ្នកអនុញ្ញាតច្បាប់</h3>
                    <button class="w-full bg-white border border-gray-300 p-4 rounded-lg shadow-sm hover:bg-gray-50 transition-all flex items-center space-x-4">
                        <img src="https://placehold.co/60x60/e2e8f0/64748b?text=Photo" alt="Approver" class="h-16 w-16 rounded-full border-2 border-white shadow-md">
                        <div>
                            <p class="text-lg font-semibold text-gray-800 text-left">លោកគ្រូ​ ពៅ ដារ៉ូ</p>
                            <p class="text-sm text-gray-500 text-left">គណៈគ្រប់គ្រង</p>
                        </div>
                    </button>
                </section>
            </div>

            <!-- ===== PAGE 2: ACCOUNT (គណនី) ===== -->
            <div id="page-account" class="p-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">គណនីរបស់ខ្ញុំ</h2>
                
                <!-- User Info Card -->
                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
                    <div class="flex flex-col items-center">
                        <img id="user-photo" src="https://placehold.co/100x100/e2e8f0/64748b?text=User" alt="User Photo" class="h-24 w-24 rounded-full border-4 border-white shadow-lg mb-4">
                        <h3 id="user-name" class="text-xl font-bold text-gray-900">...</h3>
                        <p id="user-id" class="text-sm text-gray-500">...</p>
                    </div>
                    
                    <hr class="my-6 border-gray-200">
                    
                    <!-- Details -->
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-500 font-medium">ភេទ:</span>
                            <span id="user-gender" class="font-semibold text-gray-800">...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500 font-medium">ក្រុម:</span>
                            <span id="user-group" class="font-semibold text-gray-800">...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500 font-medium">ផ្នែកការងារ:</span>
                            <span id="user-department" class="font-semibold text-gray-800">...</span>
                        </div>
                    </div>
                </div>

                <!-- Logout Button -->
                <button id="logout-btn" class="w-full bg-red-500 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-150">
                    ចាកចេញពីគណនី
                </button>
            </div>

            <!-- ===== PAGE 3: HISTORY (ប្រវត្តិ) ===== -->
            <div id="page-history" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 pt-6 px-6 text-center">ប្រវត្តិសុំច្បាប់</h2>
                
                <!-- NEW: Tabs -->
                <nav class="flex border-b border-gray-200 mt-6">
                    <button id="history-tab-leave" class="flex-1 text-center py-3 px-4 font-medium text-sm border-b-2 border-blue-600 text-blue-600">
                        ច្បាប់ឈប់សម្រាក
                    </button>
                    <button id="history-tab-out" class="flex-1 text-center py-3 px-4 font-medium text-sm text-gray-500 border-b-2 border-transparent hover:border-gray-300 hover:text-gray-700">
                        ច្បាប់ចេញក្រៅ
                    </button>
                </nav>

                <!-- NEW: Content for "Leave" Tab -->
                <div id="history-content-leave" class="p-6">
                    <!-- NEW: Filters -->
                    <div class="flex items-center space-x-2 mb-4">
                        <select id="month-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- Months populated by JS -->
                        </select>
                        <select id="year-filter" class="w-auto px-3 py-2 border border-gray-300 rounded-lg shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- Years populated by JS -->
                        </select>
                    </div>

                    <!-- Container for history cards -->
                    <div id="history-container">
                        <!-- History cards will be injected here by JS -->
                    </div>
                    
                    <!-- Placeholder for history content -->
                    <div id="history-placeholder" class="text-center text-gray-500 mt-10">
                        <!-- Message populated by JS (loading/empty) -->
                    </div>
                </div>
                
                <!-- NEW: Content for "Out" Tab -->
                <div id="history-content-out" class="p-6 hidden">
                     <div class="text-center text-gray-500 mt-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="mt-4 text-lg">មិនទាន់មាន</p>
                        <p class="text-sm">មុខងារសុំច្បាប់ចេញក្រៅ នឹងមានក្នុងពេលឆាប់ៗនេះ។</p>
                    </div>
                </div>
            </div>


            <!-- ===== PAGE 4: HELP (ជំនួយ) ===== -->
            <div id="page-help" class="p-6 hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ជំនួយ និង ទំនាក់ទំនង</h2>

                <div class="bg-white rounded-lg shadow-md border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ក្រុមការងារ IT SUPPORT</h3>
                    <p class="text-gray-600 mb-4">ប្រសិនបើអ្នកជួបបញ្ហាក្នុងការប្រើប្រាស់កម្មវិធី សូមទាក់ទងមកក្រុមការងារយើងខ្ញុំតាមរយៈ៖</p>
                    
                    <div class="space-y-4">
                        <!-- Telegram -->
                        <a href="https://t.me/MMKDigitalIndustry" target="_blank" class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 border border-gray-200">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram" class="h-6 w-6">
                            <div class="ml-4">
                                <p class="font-semibold text-blue-600">Telegram</p>
                                <p class="text-sm text-gray-600">@MMKDigitalIndustry</p>
                            </div>
                        </a>
                        <!-- Phone -->
                        <a href="tel:090544452" class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 border border-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                            </svg>
                            <div class="ml-4">
                                <p class="font-semibold text-green-700">លេខទូរស័ព្ទ</p>
                                <p class="text-sm text-gray-600">090 544 452</p>
                            </div>
                        </a>
                        <!-- Email -->
                        <a href="mailto:perdigitalindustry@gmail.com" class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 border border-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <div class="ml-4">
                                <p class="font-semibold text-red-700">អ៊ីម៉ែល</p>
                                <p class="text-sm text-gray-600">perdigitalindustry@gmail.com</p>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="text-center text-xs text-gray-400">
                    <p>&copy; 2024 ឧស្សាហកម្មឌីជីថល</p>
                    <p>អភិវឌ្ឍន៍ដោយ ក្រុមការងារ IT SUPPORT</p>
                </div>
            </div>

            <!-- ===== NEW PAGE 5: REQUEST LEAVE (ទម្រង់សុំច្បាប់) ===== -->
            <div id="page-request-leave" class="p-6 hidden bg-gray-50" style="min-height: 100vh;">
                <!-- Header with Back Button -->
                <header class="flex items-center mb-6">
                    <button id="cancel-leave-request-btn" class="p-2 text-gray-600 hover:text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <h2 class="text-xl font-bold text-gray-800 text-center flex-grow">ទម្រង់សុំច្បាប់ឈប់សម្រាក</h2>
                    <div class="w-8"></div> <!-- Spacer -->
                </header>

                <!-- User Info -->
                <section class="flex items-center bg-white border border-gray-200 p-4 rounded-lg shadow-sm mb-6">
                    <img id="request-user-photo" src="https://placehold.co/60x60/e2e8f0/64748b?text=User" alt="User Photo" class="h-16 w-16 rounded-full border-2 border-white shadow-md">
                    <div class="ml-4">
                        <h3 id="request-user-name" class="text-lg font-semibold text-gray-800">...</h3>
                        <p id="request-user-id" class="text-sm text-gray-500">...</p>
                        <p id="request-user-department" class="text-sm text-gray-500">...</p>
                    </div>
                </section>

                <!-- Form -->
                <section class="space-y-4 pb-24">
                    <!-- Duration -->
                    <div>
                        <label for="duration-search" class="block text-sm font-medium text-gray-700 mb-1">រយៈពេល</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="duration-search"
                                placeholder="វាយ ឬ ជ្រើសរើសរយៈពេល..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                autocomplete="off"
                            >
                            <div
                                id="duration-dropdown"
                                class="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"
                            >
                                <!-- Duration items will be injected here by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Single Date -->
                    <div id="single-date-container" class="hidden">
                        <label for="leave-date-single" class="block text-sm font-medium text-gray-700 mb-1">កាលបរិច្ឆេទ</label>
                        <input
                            type="date"
                            id="leave-date-single"
                            readonly
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed"
                        >
                    </div>

                    <!-- Date Range -->
                    <div id="date-range-container" class="hidden space-y-4">
                        <div>
                            <label for="leave-date-start" class="block text-sm font-medium text-gray-700 mb-1">ចាប់ពីថ្ងៃ</label>
                            <input
                                type="date"
                                id="leave-date-start"
                                readonly
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-gray-100 cursor-not-allowed"
                            >
                        </div>
                        <div>
                            <label for="leave-date-end" class="block text-sm font-medium text-gray-700 mb-1">ដល់ថ្ងៃ</label>
                            <input
                                type="date"
                                id="leave-date-end"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            >
                        </div>
                    </div>

                    <!-- Reason -->
                    <div>
                        <label for="reason-search" class="block text-sm font-medium text-gray-700 mb-1">មូលហេតុ</label>
                        <div class="relative">
                            <input
                                type="text"
                                id="reason-search"
                                placeholder="វាយ ឬ ជ្រើសរើសមូលហេតុ..."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                autocomplete="off"
                            >
                            <div
                                id="reason-dropdown"
                                class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"
                            >
                                <!-- Reason items will be injected here by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Error Message -->
                    <p id="request-error" class="text-red-500 text-sm hidden"></p>
                    
                    <!-- Loading Indicator -->
                    <div id="request-loading" class="flex items-center justify-center text-gray-600 hidden">
                        <div class="spinner mr-2" style="width: 20px; height: 20px; border-width: 2px;"></div>
                        <span>កំពុងដំណើរការ...</span>
                    </div>

                </section>

                <!-- Submit Button (Fixed at bottom) -->
                <footer class="absolute bottom-0 left-0 right-0 p-6 bg-white border-t border-gray-200 max-w-md mx-auto">
                    <button id="submit-leave-request-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 disabled:opacity-50">
                        ស្នើសុំច្បាប់
                    </button>
                </footer>
            </div>
        </main>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-navigation" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto h-16 bg-white border-t border-gray-200 shadow-md flex justify-around items-center">
            <!-- Home -->
            <button id="nav-home" class="nav-btn p-2 text-blue-600" data-page="page-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
                <span class="text-xs font-medium">ទំព័រដើម</span>
            </button>
            
            <!-- History Button -->
            <button id="nav-history" class="nav-btn p-2 text-gray-500" data-page="page-history">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-xs font-medium">ប្រវត្តិ</span>
            </button>

            <!-- Account -->
            <button id="nav-account" class="nav-btn p-2 text-gray-500" data-page="page-account">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                </svg>
                <span class="text-xs font-medium">គណនី</span>
            </button>
            
            <!-- Help -->
            <button id="nav-help" class="nav-btn p-2 text-gray-500" data-page="page-help">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                </svg>
                <span class="text-xs font-medium">ជំនួយ</span>
            </button>
        </nav>
    </div>
    
    <!-- ===== NEW: Edit Request Modal ===== -->
    <div id="edit-request-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <h3 class="text-xl font-bold mb-4">កែសម្រួលសំណើ</h3>
            
            <!-- Hidden input to store request ID -->
            <input type="hidden" id="edit-request-id">
            
            <div class="space-y-4 overflow-y-auto pr-2">
                <!-- Duration -->
                <div>
                    <label for="edit-duration-search" class="block text-sm font-medium text-gray-700 mb-1">រយៈពេល</label>
                    <div class="relative">
                        <input
                            type="text"
                            id="edit-duration-search"
                            placeholder="វាយ ឬ ជ្រើសរើសរយៈពេល..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            autocomplete="off"
                        >
                        <div
                            id="edit-duration-dropdown"
                            class="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"
                        ></div>
                    </div>
                </div>

                <!-- Single Date -->
                <div id="edit-single-date-container" class="hidden">
                    <label for="edit-leave-date-single" class="block text-sm font-medium text-gray-700 mb-1">កាលបរិច្ឆេទ</label>
                    <input
                        type="date"
                        id="edit-leave-date-single"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>

                <!-- Date Range -->
                <div id="edit-date-range-container" class="hidden space-y-4">
                    <div>
                        <label for="edit-leave-date-start" class="block text-sm font-medium text-gray-700 mb-1">ចាប់ពីថ្ងៃ</label>
                        <input
                            type="date"
                            id="edit-leave-date-start"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>
                    <div>
                        <label for="edit-leave-date-end" class="block text-sm font-medium text-gray-700 mb-1">ដល់ថ្ងៃ</label>
                        <input
                            type="date"
                            id="edit-leave-date-end"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    </div>
                </div>

                <!-- Reason -->
                <div>
                    <label for="edit-reason-search" class="block text-sm font-medium text-gray-700 mb-1">មូលហេតុ</label>
                    <div class="relative">
                        <input
                            type="text"
                            id="edit-reason-search"
                            placeholder="វាយ ឬ ជ្រើសរើសមូលហេតុ..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            autocomplete="off"
                        >
                        <div
                            id="edit-reason-dropdown"
                            class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden"
                        ></div>
                    </div>
                </div>
            </div>
            
            <!-- Error Message -->
            <p id="edit-error" class="text-red-500 text-sm hidden mt-4"></p>
            
            <!-- Loading Indicator -->
            <div id="edit-loading" class="flex items-center justify-center text-gray-600 hidden mt-4">
                <div class="spinner mr-2" style="width: 20px; height: 20px; border-width: 2px;"></div>
                <span>កំពុងរក្សាទុក...</span>
            </div>
            
            <!-- Modal Actions -->
            <div class="flex items-center justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                <button id="cancel-edit-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300">
                    បោះបង់
                </button>
                 <button id="save-edit-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 disabled:opacity-50">
                    រក្សាទុកការកែប្រែ
                </button>
            </div>
        </div>
    </div>
    
    <!-- ===== NEW: Delete Confirm Modal ===== -->
    <div id="delete-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden p-4">
         <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h3 class="text-xl font-bold my-3">បញ្ជាក់ការលុប</h3>
            <p id="delete-confirm-text" class="text-gray-600 mb-6 text-sm">តើអ្នកពិតជាចង់លុបសំណើនេះមែនទេ?</p>
            
            <!-- Loading -->
            <div id="delete-loading" class="flex items-center justify-center text-gray-600 hidden mb-4">
                <div class="spinner mr-2" style="width: 20px; height: 20px; border-width: 2px;"></div>
                <span>កំពុងលុប...</span>
            </div>
            
            <div class="flex items-center justify-center space-x-3">
                 <button id="delete-cancel-btn" class="bg-gray-200 text-gray-800 py-2 px-5 rounded-lg font-semibold hover:bg-gray-300">
                    ទេ
                </button>
                 <button id="delete-confirm-btn" class="bg-red-600 text-white py-2 px-5 rounded-lg font-semibold shadow-md hover:bg-red-700 disabled:opacity-50">
                    យល់ព្រមលុប
                </button>
            </div>
         </div>
    </div>

</body>
</html>

