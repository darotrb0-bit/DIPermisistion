<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីសុំច្បាប់ - ឧស្សាហកម្មឌីជីថល</title>
    
    <!-- Import Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Khmer Font (Kantumruy Pro) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- 
      ===== Import face-api.js =====
      'defer' ensures this script runs AFTER the HTML is parsed
      but BEFORE DOMContentLoaded.
    -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        /* Apply the font to the whole application */
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
    </style>
    
    <!-- Configure Tailwind to use the imported font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Kantumruy Pro', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-gray-100">

    <!-- 
      ===== PAGE 0: LOGIN =====
      This page is now the default, shown before the main app.
    -->
    <div id="page-login" class="max-w-md mx-auto min-h-screen flex flex-col justify-center items-center p-6 bg-gray-50">
        <!-- Logo and Title -->
        <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="h-20 w-20 mb-4">
        <h1 class="text-2xl font-bold text-blue-800 mb-2">ឧស្សាហកម្មឌីជីថល</h1>
        <p class="text-gray-600 mb-8">សូមចូលប្រើកម្មវិធីសុំច្បាប់</p>

        <!-- Form -->
        <div class="w-full bg-white p-6 rounded-lg shadow-md border border-gray-200">
            <!-- Dropdown -->
            <label for="user-select" class="block text-sm font-medium text-gray-700 mb-2">ជ្រើសរើសអត្តលេខ (ID)</label>
            
            <!-- Wrapper for input and custom dropdown -->
            <div class="relative">
                <!-- Removed list="user-datalist" and added autocomplete="off" -->
                <input id="user-select" autocomplete="off" placeholder="វាយ ឬ ជ្រើសរើស..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                
                <!-- Custom dropdown container -->
                <div id="user-dropdown" class="hidden absolute w-full bg-white border border-gray-300 rounded-b-lg max-h-60 overflow-y-auto z-20 shadow-lg" style="top: 100%;">
                    <!-- Dropdown items will be populated by JS -->
                </div>
            </div>
            
            <p id="user-select-error" class="text-red-500 text-sm mt-1 hidden">សូមជ្រើសរើសឈ្មោះរបស់អ្នក</p>

            <!-- Face Scan Button -->
            <button id="face-scan-login" class="w-full bg-blue-600 text-white py-3 rounded-lg shadow-md hover:bg-blue-700 transition-all font-semibold mt-6 flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 4.372A1 1 0 0116 5.175v9.65a1 1 0 01-1.447.894L12 13.431V6.569l2.553-2.197z" />
                </svg>
                <span>ចូលដោយស្កេនផ្ទៃមុខ</span>
            </button>
            <p id="model-status" class="text-xs text-gray-500 text-center mt-2"></p>
        </div>
    </div>

    <!-- ===== Face Scan Modal ===== -->
    <div id="scan-modal" class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-xs w-full">
            <h3 class="text-lg font-semibold mb-4">កំពុងស្កេនផ្ទៃមុខ</h3>
            <div class="relative w-full h-48 bg-gray-900 rounded-lg overflow-hidden mb-4">
                <video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline muted></video>
                <!-- "Scanning" overlay animation -->
                <div class-></div>
                <div id="scan-overlay" class="absolute inset-0 border-4 border-blue-500 rounded-lg animate-pulse"></div>
            </div>
            <p id="scan-status" class="text-gray-600">សូមដាក់មុខឲ្យចំកាមេរ៉ា...</p>
            <button id="cancel-scan" class="mt-4 text-sm text-gray-500 hover:underline">បោះបង់</button>
        </div>
    </div>


    <!-- 
      Main application container. 
      This now wraps the original app and is hidden by default.
    -->
    <div id="main-app-container" class="max-w-md mx-auto bg-white min-h-screen shadow-lg hidden">
        
        <!-- Header Section -->
        <header class="bg-white shadow-md p-4 sticky top-0 z-10">
            <div class="flex items-center space-x-3">
                <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="h-10 w-10 object-contain">
                <div>
                    <h1 class="text-xl font-bold text-blue-800">ឧស្សាហកម្មឌីជីថល</h1>
                    <p class="text-sm text-gray-500">កម្មវិធីស្នើសុំច្បាប់</p>
                </div>
            </div>
        </header>

        <!-- 
          Page Content Area 
          We have 3 page containers. JavaScript will show/hide them.
          pb-20 (padding-bottom) is added to avoid content being hidden by the fixed bottom nav.
        -->
        <main class="p-4 pb-24">

            <!-- ===== PAGE 1: HOME (ទំព័រដើម) ===== -->
            <div id="page-home">
                <section class="mb-6">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">សួស្តី, សូមស្វាគមន៍!</h2>
                    <p class="text-gray-600">សូមជ្រើសរើសប្រភេទសំណើសុំច្បាប់ខាងក្រោម៖</p>
                </section>

                <!-- Leave Request Options -->
                <section class="space-y-4">
                    <h3 class="text-md font-semibold text-gray-700">បង្កើតសំណើថ្មី</h3>
                    
                    <!-- Option 1: Leave to go out -->
                    <button class="w-full bg-blue-600 text-white p-6 rounded-lg shadow-md hover:bg-blue-700 transition-all flex items-center space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="text-lg font-semibold text-left">សំណើសុំច្បាប់ចេញក្រៅ</p>
                            <p class="text-sm text-blue-100 text-left">សម្រាប់ចេញក្រៅបន្តិចបន្តួច (ឧ. ទៅធនាគារ)</p>
                        </div>
                    </button>
                    
                    <!-- Option 2: Leave of absence -->
                    <button class="w-full bg-teal-600 text-white p-6 rounded-lg shadow-md hover:bg-teal-700 transition-all flex items-center space-x-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <div>
                            <p class="text-lg font-semibold text-left">សំណើសុំច្បាប់ឈប់សម្រាក</p>
                            <p class="text-sm text-teal-100 text-left">សម្រាប់ឈប់ (ឈឺ, ធុរៈ, សម្រាកប្រចាំឆ្នាំ)</p>
                        </div>
                    </button>
                </section>
                
                <!-- Recent Requests (Mock data) -->
                <section class="mt-8">
                    <h3 class="text-md font-semibold text-gray-700 mb-3">សំណើថ្មីៗរបស់ខ្ញុំ</h3>
                    <div class="space-y-3">
                        <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-gray-800">ច្បាប់ចេញក្រៅ</p>
                                <span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">រង់ចាំ...</span>
                            </div>
                            <p class="text-sm text-gray-500">ថ្ងៃទី ២៦ តុលា ២០២៥ (២ ម៉ោង)</p>
                        </div>
                        <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm">
                            <div class="flex justify-between items-center">
                                <p class="font-semibold text-gray-800">ច្បាប់ឈប់សម្រាក (ឈឺ)</p>
                                <span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-0.5 rounded-full">បានយល់ព្រម</span>
                            </div>
                            <p class="text-sm text-gray-500">ថ្ងៃទី ២០ តុលា ២០២៥ (១ ថ្ងៃ)</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- ===== PAGE 2: ACCOUNT (គណនី) ===== -->
            <!-- This section is now dynamic based on logged-in user -->
            <div id="page-account" class="hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ព័ត៌មានគណនី</h2>
                
                <!-- Profile Card -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 text-center mb-6">
                    <img id="account-photo" src="https://placehold.co/100x100/EBF8FF/3182CE?text=User" alt="Profile Picture" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-blue-200 object-cover">
                    <h3 id="account-name" class="text-lg font-semibold text-gray-900">...</h3>
                    <p id="account-department" class="text-gray-600">...</p>
                </div>
                
                <!-- Info List -->
                <div class="bg-white rounded-lg shadow-md border border-gray-200 divide-y divide-gray-200">
                    <div class="p-4">
                        <p class="text-sm text-gray-500">អត្តលេខ</p>
                        <p id="account-id" class="font-medium text-gray-800">...</p>
                    </div>
                    <div class="p-4">
                        <p class="text-sm text-gray-500">ក្រុម</p>
                        <p id="account-group" class="font-medium text-gray-800">...</p>
                    </div>
                    <div class="p-4">
                        <p class="text-sm text-gray-500">ភេទ</p>
                        <p id="account-gender" class="font-medium text-gray-800">...</p>
                    </div>
                    <div class="p-4">
                        <p class="text-sm text-gray-500">អ្នកអនុញ្ញាតច្បាប់</p>
                        <p class="font-medium text-gray-800">គណៈគ្រប់គ្រង លោកគ្រូ​ ពៅ ដារ៉ូ</p>
                    </div>
                </div>

                <!-- Log Out Button -->
                <button id="logout-button" class="w-full mt-6 bg-red-500 text-white py-3 rounded-lg shadow-md hover:bg-red-600 transition-all font-semibold">
                    ចាកចេញពីគណនី
                </button>
            </div>

            <!-- ===== PAGE 3: HELP (ជំនួយ) ===== -->
            <div id="page-help" class="hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4">ជំនួយ និង ទំនាក់ទំនង</h2>

                <div class="bg-white rounded-lg shadow-md border border-gray-200 divide-y divide-gray-200">
                    <div class="p-4">
                        <p class="text-sm text-gray-500">អ្នកភិវឌ្ឍន៍កម្មវិធី</p>
                        <p class="font-medium text-gray-800">ក្រុមការងារ IT SUPPORT</p>
                    </div>
                    
                    <div class="p-4">
                        <p class="text-sm font-semibold text-gray-600 mb-2">ក្រុមការងារប្រឹក្សាបញ្ហា</p>
                        <ul class="space-y-3">
                            <li class="flex items-center space-x-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                                <a href="https://t.me/MMKDigitalIndustry" target="_blank" class="text-blue-600 hover:underline">@MMKDigitalIndustry</a>
                            </li>
                            <li class="flex items-center space-x-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                </svg>
                                <a href="tel:090544452" class="text-gray-800">090 544 452</a>
                            </li>
                            <li class="flex items-center space-x-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                <a href="mailto:perdigitalindustry@gmail.com" class="text-blue-600 hover:underline">perdigitalindustry@gmail.com</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </main>

        <!-- 
          Bottom Navigation Bar 
          It's fixed to the bottom and stays within the max-w-md constraint.
        -->
        <footer class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 shadow-inner">
            <nav class="flex justify-around items-center h-16">
                <!-- Nav Button: Home -->
                <button id="nav-home" onclick="showPage('home')" class="nav-button flex flex-col items-center justify-center text-blue-600 w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                    <span class="text-xs font-medium">ទំព័រដើម</span>
                </button>
                
                <!-- Nav Button: Account -->
                <button id="nav-account" onclick="showPage('account')" class="nav-button flex flex-col items-center justify-center text-gray-500 w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs font-medium">គណនី</span>
                </button>
                
                <!-- Nav Button: Help -->
                <button id="nav-help" onclick="showPage('help')" class="nav-button flex flex-col items-center justify-center text-gray-500 w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0110 5a3 3 0 012.828 4.025A1 1 0 0112 10v1a1 1 0 11-2 0v-.5a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-xs font-medium">ជំនួយ</span>
                </button>
            </nav>
        </footer>

    </div>

    <script>
        // Get all page elements
        const pages = {
            home: document.getElementById('page-home'),
            account: document.getElementById('page-account'),
            help: document.getElementById('page-help')
        };
        
        // Get all nav button elements
        const navButtons = {
            home: document.getElementById('nav-home'),
            account: document.getElementById('nav-account'),
            help: document.getElementById('nav-help')
        };

        // Function to show a page and update nav
        function showPage(pageId) {
            // Hide all pages
            for (const id in pages) {
                pages[id].classList.add('hidden');
            }
            
            // Deactivate all nav buttons (set to gray)
            for (const id in navButtons) {
                navButtons[id].classList.remove('text-blue-600');
                navButtons[id].classList.add('text-gray-500');
            }
            
            // Show the selected page
            if (pages[pageId]) {
                pages[pageId].classList.remove('hidden');
            }
            
            // Activate the selected nav button (set to blue)
            if (navButtons[pageId]) {
                navButtons[pageId].classList.remove('text-gray-500');
                navButtons[pageId].classList.add('text-blue-600');
            }
        }

        // ===== NEW LOGIN SCRIPT =====

        // --- Global variables ---
        let allUsersData = []; // To store { id, name, photo, gender, group, department }
        let currentUser = null;
        let cameraStream = null;
        let modelsLoaded = false;
        let faceScanInterval = null;

        // --- Element Caching ---
        const pageLogin = document.getElementById('page-login');
        const mainAppContainer = document.getElementById('main-app-container');
        const userSelect = document.getElementById('user-select'); // This is the <input> now
        const userDropdown = document.getElementById('user-dropdown'); // NEW custom dropdown
        const userSelectError = document.getElementById('user-select-error');
        const faceScanLoginBtn = document.getElementById('face-scan-login');
        const modelStatus = document.getElementById('model-status');
        
        const scanModal = document.getElementById('scan-modal');
        const cameraFeed = document.getElementById('camera-feed');
        const scanStatus = document.getElementById('scan-status');
        const cancelScanBtn = document.getElementById('cancel-scan');
        const scanOverlay = document.getElementById('scan-overlay');
        
        const logoutButton = document.getElementById('logout-button');

        // --- Google Sheet Data Fetching ---
        const SHEET_ID = '1_Kgl8UQXRsVATt_BOHYQjVWYKkRIBA12R-qnsBoSUzc';
        const SHEET_NAME = 'បញ្ជឺឈ្មោះរួម';
        // Query: Select E (ID), L (Name), AA (Photo), N (Gender), G (Group), S (Department)
        // Start from row 9. OFFSET 0 means don't skip any *data* rows.
        // The query "WHERE E IS NOT NULL" already handles skipping the headers (rows 1-8).
        const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tq=${encodeURIComponent('SELECT E, L, AA, N, G, S WHERE E IS NOT NULL OFFSET 0')}`;

        async function fetchUsers() {
            try {
                const response = await fetch(GVIZ_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                let text = await response.text();
                
                // Strip JSONP wrapper
                const jsonTextMatch = text.match(/google\.visualization\.Query\.setResponse\((.*)\)/s);
                if (!jsonTextMatch || !jsonTextMatch[1]) {
                    throw new Error('Invalid JSONP response format');
                }
                
                const data = JSON.parse(jsonTextMatch[1]);
                
                if (data.table && data.table.rows) {
                    allUsersData = data.table.rows.map(row => ({
                        id: row.c[0] ? row.c[0].v : null,
                        name: row.c[1] ? row.c[1].v : null,
                        photo: row.c[2] ? row.c[2].v : null, 
                        gender: row.c[3] ? row.c[3].v : null,
                        group: row.c[4] ? row.c[4].v : null,
                        department: row.c[5] ? row.c[5].v : null,
                    })).filter(user => user.id && user.name); // Filter out empty rows
                    
                    // Don't populate dropdown on load, wait for focus
                    userSelect.placeholder = "វាយ ឬ ជ្រើសរើស...";
                } else {
                     throw new Error('No data table found in response');
                }
            } catch (error) {
                console.error('Error fetching Google Sheet data:', error);
                // Can't set innerHTML of an input, maybe set placeholder
                userSelect.placeholder = "មិនអាចទាញទិន្នន័យបាន";
            }
        }

        // This function now filters AND shows/hides the custom dropdown
        function populateUserDropdown(filter = '') {
            userDropdown.innerHTML = ''; // Clear old items
            
            const lowerFilter = filter.toLowerCase();
            let hasMatches = false;

            allUsersData.forEach(user => {
                const itemText = `${user.id} - ${user.name}`;
                // Filter logic
                if (itemText.toLowerCase().includes(lowerFilter)) {
                    hasMatches = true;
                    // Create a div for each item
                    const itemDiv = document.createElement('div');
                    itemDiv.textContent = itemText;
                    itemDiv.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                    
                    // Add click event to select item
                    itemDiv.addEventListener('click', () => {
                        userSelect.value = itemText; // Set input value
                        userDropdown.classList.add('hidden'); // Hide dropdown
                    });
                    
                    userDropdown.appendChild(itemDiv);
                }
            });

            // Show or hide dropdown based on matches
            if (hasMatches) {
                userDropdown.classList.remove('hidden');
            } else {
                userDropdown.classList.add('hidden');
            }
        }

        // --- NEW Event Listeners for custom dropdown ---

        // Show and populate on focus
        userSelect.addEventListener('focus', () => {
            populateUserDropdown(userSelect.value); // Show all or filtered
        });

        // Filter on typing
        userSelect.addEventListener('input', () => {
            populateUserDropdown(userSelect.value);
            userSelectError.classList.add('hidden'); // Hide error while typing
        });

        // Hide on click outside
        window.addEventListener('click', (e) => {
            // Hide if click is not on the input and not inside the dropdown
            if (e.target !== userSelect && !userDropdown.contains(e.target)) {
                userDropdown.classList.add('hidden');
            }
        });


        // --- Login Logic ---
        faceScanLoginBtn.addEventListener('click', startLoginProcess);
        
        async function startLoginProcess() {
            // 1. Check if models are loaded
            if (!modelsLoaded) {
                modelStatus.textContent = 'សូមរង់ចាំ Model កំពុងទាញយក...';
                return;
            }

            // 2. Validate user selection
            const selectedValue = userSelect.value; // Get value from <input>
            const selectedUserId = selectedValue.split(' - ')[0];
            
            if (!selectedUserId) {
                userSelectError.classList.remove('hidden');
                return;
            }
            userSelectError.classList.add('hidden');
            
            currentUser = allUsersData.find(user => user.id == selectedUserId);
            if (!currentUser) {
                userSelectError.textContent = 'រកមិនឃើញទិន្នន័យអ្នកប្រើប្រាស់';
                userSelectError.classList.remove('hidden');
                return;
            }
            
            // 3. Check for reference photo
            if (!currentUser.photo) {
                userSelectError.textContent = 'អ្នកប្រើប្រាស់នេះ មិនមានរូបថតយោងទេ';
                userSelectError.classList.remove('hidden');
                return;
            }

            // 4. Show modal and start camera
            scanModal.classList.remove('hidden');
            scanStatus.textContent = 'កំពុងចាប់ផ្តើមកាមេរ៉ា...';
            scanOverlay.className = 'absolute inset-0 border-4 border-blue-500 rounded-lg animate-pulse';
            
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    cameraFeed.srcObject = cameraStream;
                    
                    // Wait for camera to be ready
                    cameraFeed.onloadedmetadata = () => {
                        scanStatus.textContent = 'សូមដាក់មុខឲ្យចំ...';
                        // Start the actual face recognition
                        startFaceRecognition();
                    }
                } else {
                    throw new Error('Camera API not supported');
                }
            } catch (err) {
                console.error('Camera error:', err);
                scanStatus.textContent = 'មិនអាចបើកកាមេរ៉ាបាន!';
                // Hide modal after 2 seconds on error
                setTimeout(() => {
                    cancelScan(); // Use cancel function to clean up
                }, 2000);
            }
        }

        // ===== NEW: Face Recognition Logic =====

        async function startFaceRecognition() {
            let referenceDescriptor;

            // 1. Load reference image and create descriptor
            try {
                scanStatus.textContent = 'កំពុងវិភាគរូបថតយោង...';
                // Use faceapi.fetchImage to handle potential CORS issues
                const referenceImage = await faceapi.fetchImage(currentUser.photo);
                referenceDescriptor = await faceapi.detectSingleFace(referenceImage, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks(true)
                    .withFaceDescriptor();
                
                if (!referenceDescriptor) {
                    throw new Error('No face found in reference photo.');
                }
            } catch (err) {
                console.error('Error loading reference image:', err);
                scanStatus.textContent = 'Error: មិនអាចផ្ទុក/វិភាគរូបថតយោងបាន។';
                scanOverlay.className = 'absolute inset-0 border-4 border-red-500 rounded-lg';
                setTimeout(cancelScan, 3000);
                return;
            }
            
            // 2. Create Face Matcher
            const faceMatcher = new faceapi.FaceMatcher(referenceDescriptor, 0.5); // 0.5 = 50% distance threshold
            scanStatus.textContent = 'សូមដាក់មុខឲ្យចំ...';

            // 3. Start recognition interval
            faceScanInterval = setInterval(async () => {
                if (!cameraStream) return; // Stop if camera was cancelled
                
                try {
                    const detections = await faceapi.detectAllFaces(cameraFeed, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks(true)
                        .withFaceDescriptors();

                    if (detections.length > 0) {
                        // Find the best match from the detected faces
                        const bestMatch = faceMatcher.findBestMatch(detections[0].descriptor);
                        
                        if (bestMatch.label === 'person 1' && bestMatch.distance < 0.5) {
                            // MATCH FOUND!
                            scanStatus.textContent = 'ផ្ទៀងផ្ទាត់ជោគជ័យ!';
                            scanOverlay.className = 'absolute inset-0 border-4 border-green-500 rounded-lg';
                            clearInterval(faceScanInterval);
                            faceScanInterval = null;
                            setTimeout(completeLogin, 1000); // Wait 1 sec before closing
                        } else {
                            // No match
                            scanStatus.textContent = 'មិនស្គាល់មុខ... សូមព្យាយាមម្ដងទៀត។';
                            scanOverlay.className = 'absolute inset-0 border-4 border-red-500 rounded-lg';
                        }
                    } else {
                        // No face detected
                        scanStatus.textContent = 'រកមិនឃើញមុខ... សូមដាក់មុខឲ្យចំ។';
                        scanOverlay.className = 'absolute inset-0 border-4 border-blue-500 rounded-lg animate-pulse';
                    }
                } catch (err) {
                    console.error('Error during detection interval:', err);
                    scanStatus.textContent = 'មានបញ្ហាពេលកំពុងវិភាគ...';
                }
            }, 700); // Check every 700ms
        }
        
        // ======================================

        function completeLogin() {
            // Stop camera and interval
            stopScan();
            
            // Hide modal
            scanModal.classList.add('hidden');

            // Populate account page
            populateAccountPage();

            // Show main app
            pageLogin.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
            showPage('home'); // Go to home page
        }

        function populateAccountPage() {
            if (!currentUser) return;
            
            const accountPhoto = document.getElementById('account-photo');
            accountPhoto.src = currentUser.photo || 'https://placehold.co/100x100/EBF8FF/3182CE?text=User';
            // Handle potential errors on photo load
            accountPhoto.onerror = function() {
                this.src = 'https://placehold.co/100x100/EBF8FF/3182CE?text=User';
            };
            
            document.getElementById('account-name').textContent = currentUser.name || 'N/A';
            document.getElementById('account-department').textContent = currentUser.department || 'N/A';
            document.getElementById('account-id').textContent = currentUser.id || 'N/A';
            document.getElementById('account-group').textContent = currentUser.group || 'N/A';
            document.getElementById('account-gender').textContent = currentUser.gender || 'N/A';
        }

        // --- NEW: Refactored cleanup functions ---
        function stopScan() {
             // Stop recognition interval
            if (faceScanInterval) {
                clearInterval(faceScanInterval);
                faceScanInterval = null;
            }
            // Stop camera
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                cameraFeed.srcObject = null;
            }
        }
        
        function cancelScan() {
            stopScan();
            scanModal.classList.add('hidden');
        }

        // --- Cancel Scan ---
        cancelScanBtn.addEventListener('click', cancelScan);

        // --- Logout Logic ---
        logoutButton.addEventListener('click', () => {
            currentUser = null;
            mainAppContainer.classList.add('hidden');
            pageLogin.classList.remove('hidden');
            userSelect.value = ''; // Reset input field
            // Ensure home is not active when logged out
            showPage('home'); // This will hide all pages
            pages.home.classList.add('hidden'); // Explicitly hide home
        });

        // --- NEW: Load Face-API Models on Startup ---
        async function loadFaceApiModels() {
            // Use tiny models for faster mobile performance
            // FIX: The path should be 'weights' not 'models' for this CDN version
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            try {
                modelStatus.textContent = 'កំពុងទាញយក Model...';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL);
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                modelsLoaded = true;
                modelStatus.textContent = 'Model បានត្រៀមរួចរាល់';
                console.log('Face-API models loaded');
            } catch (err) {
                console.error('Error loading face-api models:', err);
                modelStatus.textContent = 'Error: មិនអាចទាញយក Model បាន';
            }
        }


        // Set the default page to 'home' when the app loads
        document.addEventListener('DOMContentLoaded', () => {
            // Start by fetching users for the login page
            fetchUsers();
            
            // NEW: Load face-api models
            // We can call this directly because `faceapi` is guaranteed
            // to be available by the 'defer' attribute on the script tag.
            // This avoids the need for setInterval.
            if (typeof faceapi !== 'undefined') {
                loadFaceApiModels();
            } else {
                console.error("Face-API.js did not load correctly.");
                modelStatus.textContent = 'Error: មិនអាចទាញយក Library ស្កេនមុខបាន';
            }
        });
    </script>

</body>
</html>

